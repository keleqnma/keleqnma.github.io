<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>C++åˆ·ï¼ˆçœ‹ï¼‰é¢˜è®°å½•</title>
    <link href="/2020/11/30/C-%E7%9C%8B%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    <url>/2020/11/30/C-%E7%9C%8B%E9%A2%98%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<p>ä¸€. é¢è¯•é¢˜57ï¼ˆäºŒï¼‰ï¼šå’Œä¸ºsçš„è¿ç»­æ­£æ•°åºåˆ—</p><blockquote><p>é¢˜ç›®ï¼šè¾“å…¥ä¸€ä¸ªæ­£æ•°sï¼Œæ‰“å°å‡ºæ‰€æœ‰å’Œä¸ºsçš„è¿ç»­æ­£æ•°åºåˆ—ï¼ˆè‡³å°‘å«æœ‰ä¸¤ä¸ªæ•°ï¼‰ã€‚ä¾‹å¦‚è¾“å…¥15ï¼Œç”±äº1+2+3+4+5=4+5+6=7+8=15ï¼Œæ‰€ä»¥ç»“æœæ‰“å°å‡º3ä¸ªè¿ç»­åºåˆ—1ï½5ã€4ï½6å’Œ7ï½8ã€‚</p></blockquote><pre><code>æ€è·¯ï¼šå’Œä¸ºsçš„è¿ç»­åºåˆ—ï¼Œæ ¹æ®ç­‰å·®å’Œå…¬å¼å¯å¾—ï¼Œä¸­é—´çš„é‚£ä¸ªæ•°ä¸€å®šä¸ºï¼ˆs-1ï¼‰/2ï¼Œæšä¸¾è¾“å‡ºã€‚</code></pre><p>äºŒ. é¢è¯•é¢˜66ï¼šæ„å»ºä¹˜ç§¯æ•°ç»„</p><blockquote><p>é¢˜ç›®ï¼šç»™å®šä¸€ä¸ªæ•°ç»„A[0, 1, â€¦, n-1]ï¼Œè¯·æ„å»ºä¸€ä¸ªæ•°ç»„B[0, 1, â€¦, n-1]ï¼Œå…¶ä¸­Bä¸­çš„å…ƒç´ B[i] =A[0]Ã—A[1]Ã—â€¦ Ã—A[i-1]Ã—A[i+1]Ã—â€¦Ã—A[n-1]ã€‚ä¸èƒ½ä½¿ç”¨é™¤æ³•ã€‚</p></blockquote><pre><code>æ€è·¯: ä¿å­˜ä¸¤ä¸ªæ•°ï¼Œä¸€ä¸ªæ˜¯å½“å‰ä½ç½®çš„å‰åºä¹˜ç§¯ï¼Œä¸€ä¸ªæ˜¯å½“å‰ä½ç½®çš„åç»­ä¹˜ç§¯ï¼Œç›¸ä¹˜å³å¯ã€‚</code></pre><p>ä¸‰. é¢è¯•é¢˜7ï¼šé‡å»ºäºŒå‰æ ‘</p><blockquote><p>é¢˜ç›®ï¼šè¾“å…¥æŸäºŒå‰æ ‘çš„å‰åºéå†å’Œä¸­åºéå†çš„ç»“æœï¼Œè¯·é‡å»ºè¯¥äºŒå‰æ ‘ï¼ˆå‡è®¾æ²¡æœ‰é‡å¤æ•°å­—ï¼‰ã€‚èŠ‚ç‚¹å®šä¹‰å¦‚ä¸‹ï¼š</p></blockquote><pre><code>struct TreeNode &#123;    int val;    TreeNode *left;    TreeNode *right;    TreeNode(int x) :val(x), left(nullptr), right(nullptr) &#123;&#125;&#125;;</code></pre><p> æ€è·¯ï¼š</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Socketç¼–ç¨‹</title>
    <link href="/2020/11/23/Socket%E7%BC%96%E7%A8%8B/"/>
    <url>/2020/11/23/Socket%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ç›—ç‰ˆå°è¯´ç½‘ç«™çˆ¬ğŸ›ç®€æ˜“æŒ‡å—</title>
    <link href="/2020/11/14/%E7%9B%97%E7%89%88%E5%B0%8F%E8%AF%B4%E7%88%AC%E8%99%AB%E6%8C%87%E5%8C%97/"/>
    <url>/2020/11/14/%E7%9B%97%E7%89%88%E5%B0%8F%E8%AF%B4%E7%88%AC%E8%99%AB%E6%8C%87%E5%8C%97/</url>
    
    <content type="html"><![CDATA[<p>ç”±äºå‰æ®µæ—¥å­è¯¯æ“ä½œæŠŠæ‰‹æœºé‡Œçš„å°è¯´éƒ½åˆ äº†ï¼Œå°±é‡æ“æ—§ä¸šçˆ¬å–ç›—ç‰ˆå°è¯´ç½‘ç«™ï¼Œå°è¯´çˆ¬è™«ç®—æ˜¯è½»é‡çº§çˆ¬è™«ï¼Œç›—ç‰ˆå°è¯´ç½‘ç«™æ¯”èµ·æ­£ç‰ˆå°è¯´ç½‘ç«™ï¼Œæ²¡ä»€ä¹ˆéªŒè¯ç ï¼Œç”¨vueå’Œreactçš„éƒ½å°‘ï¼Œç½‘é¡µä¸‰å‰‘å®¢æ‰€è§å³æ‰€å¾—ï¼Œä¹Ÿä¸ç”¨seleniumè¿™ç§ä¸œè¥¿å»æ¨¡æ‹Ÿç‚¹å‡»ï¼Œå½“ç„¶ï¼Œç›—ç‰ˆå°è¯´ç½‘ç«™æœåŠ¡å™¨é€šå¸¸å¾ˆçƒ‚å¾ˆçƒ‚ï¼Œä½ è¦æ˜¯çˆ¬çŒ›äº†å‘ç°é€Ÿåº¦çªç„¶æ…¢ä¸‹æ¥è¯·æ±‚å¤§é¢ç§¯å¤±è´¥äº†ï¼Œé™¤äº†ipæ‹¦æˆªçš„å¯èƒ½æ€§ä¹‹å¤–ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä½ çˆ¬è™«æŠŠäººå®¶æœåŠ¡å™¨æå´©äº†â€¦â€¦</p><p>çˆ¬å–ç›—ç‰ˆå°è¯´ç½‘ç«™ä¹Ÿä¸éœ€è¦è€ƒè™‘å»é‡ï¼Œä¸éœ€è¦å¾ªç¯çˆ¬å–ï¼Œæ˜¯éå¸¸ç®€å•çš„å¤šå‰å¼æµç¨‹çˆ¬å–ï¼š</p><p>é¦–é¡µ â¡ï¸ ä¹¦ç±åˆ†ç±»/æ’è¡Œæ¦œé¡µ â¡ï¸ ä¹¦ç±ç« èŠ‚ç´¢å¼•é¡µ â¡ï¸ çˆ¬å–ç« èŠ‚ï¼Œå†™å…¥æ•°æ®åº“</p><p>å¤§éƒ¨åˆ†ç›—ç‰ˆå°è¯´ç½‘ç«™å¯¹çˆ¬è™«æ²¡ä»€ä¹ˆé˜²èŒƒæªæ–½ï¼Œé¡¶å¤šå°±æ˜¯ä½ çˆ¬çŒ›äº†ç»™ä½ å°ipï¼Œéå¸¸é€‚åˆç”¨æ¥ç»ƒæ‰‹ï¼Œçˆ¬èµ·æ¥ä¹Ÿå¾ˆæœ‰å¿«æ„Ÿï¼é‚£ä¹ˆè¦ç¡®å®šçš„å°±æ˜¯ä¸¤ä¸ªäº‹æƒ…ï¼š</p><ol><li>è¿™ä¸ªç½‘ç«™èƒ½æ‰¿å—å¤šå°‘è¯·æ±‚ï¼Ÿå°è¯·æ±‚çš„ä¸Šé™æ˜¯å¤šå°‘ï¼Ÿ</li><li>ä½ çš„çˆ¬è™«æœºï¼Œä½ çš„ç½‘ç»œé€Ÿåº¦ä¸Šé™æ˜¯å¤šå°‘ï¼Ÿ</li></ol><p>ç¡®å®šäº†ä¹‹åè°ƒæ•´ä¸€ä¸‹å‚æ•°ï¼Œå‰©ä¸‹æ¥çš„å°±æ˜¯é€šç”¨æµç¨‹ã€‚</p><h2 id="1-å®šä½çˆ¬å–å…ƒç´ ï¼Ÿ"><a href="#1-å®šä½çˆ¬å–å…ƒç´ ï¼Ÿ" class="headerlink" title="1. å®šä½çˆ¬å–å…ƒç´ ï¼Ÿ"></a>1. å®šä½çˆ¬å–å…ƒç´ ï¼Ÿ</h2><p>ç†è®ºä¸Šè¯´ç½‘é¡µè§£æé€Ÿåº¦re &gt; css &gt; xpathï¼Œä¸ç®¡æ˜¯ä¸ºäº†çˆ¬è™«çš„ç¨³å®šè¿˜æ˜¯ä¸ºäº†æ•ˆç‡ï¼Œéƒ½å°½é‡ä½¿ç”¨cssé€‰æ‹©å™¨ä»£æ›¿Xpathã€‚ä½†æ˜¯æˆ‘ç”¨Xpathæ¯”è¾ƒé¡ºæ‰‹ï¼Œè¿™ç§è½»é‡çº§çˆ¬è™«ä¹Ÿæ— æ‰€è°“ã€‚</p><h2 id="2-å¤šåç¨‹-çº¿ç¨‹å¦‚ä½•ç¨³å®šçˆ¬å–é€Ÿç‡ï¼Ÿ"><a href="#2-å¤šåç¨‹-çº¿ç¨‹å¦‚ä½•ç¨³å®šçˆ¬å–é€Ÿç‡ï¼Ÿ" class="headerlink" title="2. å¤šåç¨‹/çº¿ç¨‹å¦‚ä½•ç¨³å®šçˆ¬å–é€Ÿç‡ï¼Ÿ"></a>2. å¤šåç¨‹/çº¿ç¨‹å¦‚ä½•ç¨³å®šçˆ¬å–é€Ÿç‡ï¼Ÿ</h2><p>è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…é—®é¢˜ã€‚</p><p>ç”Ÿäº§ï¼šå¯ä»¥å¼€å§‹çˆ¬å–çš„åç¨‹/çº¿ç¨‹ä¸ªæ•°ï¼Œ</p><h2 id="3-DNSè§£æç¼“å­˜ï¼Ÿ"><a href="#3-DNSè§£æç¼“å­˜ï¼Ÿ" class="headerlink" title="3. DNSè§£æç¼“å­˜ï¼Ÿ"></a>3. DNSè§£æç¼“å­˜ï¼Ÿ</h2><p>dnsè§£æä¸€èˆ¬ä¼šèŠ±è´¹å‡ åmsä¸ç­‰çš„æ—¶é—´ï¼Œå› ä¸ºæˆ‘æ˜¯åœ¨macä¸Šè·‘çš„ï¼Œæœ‰æ—¶å€™ä¼šå‡ºç°DNSè§£æè¶…æ—¶çš„æƒ…å†µï¼Œç”¨ä¸€ä¸ªç®€å•çš„mapç»“æ„ä¿å­˜åŸŸåå’Œå…¶å¯¹åº”çš„IPï¼Œéš”ä¸€æ®µæ—¶é—´åˆ·æ–°ä¸€æ¬¡ï¼Œè¿™æ ·å°±èƒ½èŠ‚çœé‡å¤è§£æèŠ±è´¹çš„æ—¶é—´å’Œèµ„æºã€‚</p><pre><code class="hljs golang">client = &amp;http.Client&#123;Transport: &amp;http.Transport&#123;......Dial: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(network <span class="hljs-keyword">string</span>, address <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(net.Conn, error)</span></span> &#123;separator := strings.LastIndex(address, <span class="hljs-string">&quot;:&quot;</span>)ip, _ := client.dnsCache.FetchOneString(address[:separator])<span class="hljs-keyword">return</span> net.Dial(<span class="hljs-string">&quot;tcp&quot;</span>, ip+address[separator:])&#125;,                ......&#125;,            ......&#125;</code></pre><p>è¿™é‡Œçš„è¿™ä¸ªdnsCacheå°±æ˜¯è¿™ä¸ªmapç»“æ„çš„å°è£…ï¼Œè°ƒç”¨fetchåä¼šé¦–å…ˆåœ¨æœ¬åœ°æŸ¥æ‰¾æ˜¯å¦æœ‰ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰æˆ–è€…å·²è¿‡æœŸåˆ™ä¼šè°ƒç”¨<code>net.LookupIP</code>æŸ¥æ‰¾æ›´æ–°ç¼“å­˜ï¼Œéšåè¿”å›ã€‚</p><h2 id="4-ä»£ç†IPæ± ï¼Ÿ"><a href="#4-ä»£ç†IPæ± ï¼Ÿ" class="headerlink" title="4. ä»£ç†IPæ± ï¼Ÿ"></a>4. ä»£ç†IPæ± ï¼Ÿ</h2><pre><code class="hljs golang">client = &amp;http.Client&#123;Transport: &amp;http.Transport&#123;Proxy:               http.ProxyURL(proxy),MaxIdleConnsPerHost: clientSize * <span class="hljs-number">2</span>,                .....            &#125;,            ......&#125;</code></pre><p>å°è£…ä¸€ä¸ªGetteræ¥å£ï¼Œç»™å‡ ä¸ªå…è´¹çš„ä»£ç†ç½‘ç«™ç¼–å†™çˆ¬è™«è„šæœ¬çˆ¬å–ä»£ç†IPï¼Œæ›´æ–°çˆ¬å–æµ‹è¯•ä»£ç†æ˜¯å¦èƒ½ç”¨ï¼ˆæ˜¯å¦èƒ½è¿é€šéœ€è¦çˆ¬å–çš„ç½‘ç«™ï¼‰ï¼Œå…¶å®ä»£ç†æ± è™½ç„¶å¤šï¼Œä½†æ˜¯èƒ½ç”¨çš„ä»£ç†æ¯”ä¾‹å¾ˆä½ï¼Œè¿™ç§ä½“é‡çš„å°çˆ¬è™«æ§åˆ¶é€Ÿç‡ä¸€èˆ¬å°±æ²¡å¿…è¦ç”¨ä»£ç†äº†ï¼Œéœ€æ±‚é«˜é€Ÿç‡çš„è¯å¯ä»¥åœ¨è¿™æ–¹é¢å†åŠªåŠ›åŠªåŠ›ã€‚</p><h2 id="5-é•¿è¿æ¥çŸ­è¿æ¥ï¼Ÿ"><a href="#5-é•¿è¿æ¥çŸ­è¿æ¥ï¼Ÿ" class="headerlink" title="5. é•¿è¿æ¥çŸ­è¿æ¥ï¼Ÿ"></a>5. é•¿è¿æ¥çŸ­è¿æ¥ï¼Ÿ</h2><p>Golangçš„Clientä¸€èˆ¬ä¼šå«æœ‰å†…éƒ¨çŠ¶æ€ï¼ˆç¼“å­˜ TCP è¿æ¥ï¼‰ï¼Œå› æ­¤ Client ç±»å‹å€¼åº”å°½é‡è¢«é‡ç”¨è€Œä¸æ˜¯æ¯æ¬¡éœ€è¦éƒ½åˆ›å»ºæ–°çš„ã€‚ Client ç±»å‹å€¼å¯ä»¥å®‰å…¨çš„è¢«å¤šä¸ªgoroutineåŒæ—¶ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸€èˆ¬å»ºè®®æ˜¯é‡ç”¨clientï¼Œä½¿ç”¨é•¿è¿æ¥å¹¶ä¸”æŠŠMaxIdleConnsPerHostè®¾å¤§ä¸€ç‚¹ã€‚</p><h2 id="6-åˆ†å¸ƒå¼çˆ¬è™«ï¼Ÿ"><a href="#6-åˆ†å¸ƒå¼çˆ¬è™«ï¼Ÿ" class="headerlink" title="6. åˆ†å¸ƒå¼çˆ¬è™«ï¼Ÿ"></a>6. åˆ†å¸ƒå¼çˆ¬è™«ï¼Ÿ</h2><h2 id="6-éƒ¨åˆ†ä»£ç é€»è¾‘"><a href="#6-éƒ¨åˆ†ä»£ç é€»è¾‘" class="headerlink" title="6. éƒ¨åˆ†ä»£ç é€»è¾‘"></a>6. éƒ¨åˆ†ä»£ç é€»è¾‘</h2>]]></content>
    
    
    <categories>
      
      <category>è®¡ç®—æœºç½‘ç»œ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      
      <tag>é»„ç‹—æ‚è°ˆ</tag>
      
      <tag>çˆ¬è™«</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ¯å¤©ä¸€é¢˜ Leetcode 166. Fraction to Recurring Decimal</title>
    <link href="/2020/10/28/%E6%AF%8F%E5%A4%A9%E4%B8%80%E9%A2%98-Leetcode-166-Fraction-to-Recurring-Decimal/"/>
    <url>/2020/10/28/%E6%AF%8F%E5%A4%A9%E4%B8%80%E9%A2%98-Leetcode-166-Fraction-to-Recurring-Decimal/</url>
    
    <content type="html"><![CDATA[<p>åˆ©ç”¨å“ˆå¸Œè¡¨æ‰¾é‡å¤æƒ…å†µï¼Œæ³¨æ„corner caseã€‚</p><a id="more"></a><h1 id="æ¯å¤©ä¸€é¢˜-Leetcode-166-Fraction-to-Recurring-Decimal"><a href="#æ¯å¤©ä¸€é¢˜-Leetcode-166-Fraction-to-Recurring-Decimal" class="headerlink" title="æ¯å¤©ä¸€é¢˜ Leetcode 166. Fraction to Recurring Decimal"></a>æ¯å¤©ä¸€é¢˜ Leetcode 166. Fraction to Recurring Decimal</h1><h2 id="1-é¢˜ç›®"><a href="#1-é¢˜ç›®" class="headerlink" title="1. é¢˜ç›®"></a>1. é¢˜ç›®</h2><p><a href="https://leetcode.com/problems/fraction-to-recurring-decimal/">https://leetcode.com/problems/fraction-to-recurring-decimal/</a></p><div class="note note-primary">            <p>Given two integers representing the numerator and denominator of a fraction, return the fraction in string format.</p><p>If the fractional part is repeating, enclose the repeating part in parentheses.</p><p>If multiple answers are possible, return any of them.</p><p>It is guaranteed that the length of the answer string is less than 104 for all the given inputs.</p><pre><code>Example 1:Input: numerator = 1, denominator = 2Output: &quot;0.5&quot;Example 2:Input: numerator = 2, denominator = 1Output: &quot;2&quot;Example 3:Input: numerator = 2, denominator = 3Output: &quot;0.(6)&quot;Example 4:Input: numerator = 4, denominator = 333Output: &quot;0.(012)&quot;Example 5:Input: numerator = 1, denominator = 5Output: &quot;0.2&quot;</code></pre><p>Constraints:</p><ul><li><p>-231 &lt;= numerator, denominator &lt;= 231 - 1</p></li><li><p>denominator != 0 </p></li></ul>          </div><h2 id="2-è§£æ³•"><a href="#2-è§£æ³•" class="headerlink" title="2. è§£æ³•"></a>2. è§£æ³•</h2><p>ä»£ç ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span>(    <span class="hljs-string">&quot;strconv&quot;</span>    <span class="hljs-string">&quot;fmt&quot;</span>)<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">abs</span><span class="hljs-params">(n <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">int</span></span> &#123;    <span class="hljs-keyword">if</span> n &gt; <span class="hljs-number">0</span> &#123;        <span class="hljs-keyword">return</span> n    &#125;    <span class="hljs-keyword">return</span> -n&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fractionToDecimal</span><span class="hljs-params">(numerator <span class="hljs-keyword">int</span>, denominator <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">string</span></span> &#123;    <span class="hljs-keyword">var</span> res <span class="hljs-keyword">string</span>    <span class="hljs-keyword">if</span> ((numerator &gt; <span class="hljs-number">0</span>) &amp;&amp; (denominator &lt; <span class="hljs-number">0</span>)) || ((numerator &lt; <span class="hljs-number">0</span>) &amp;&amp; (denominator &gt; <span class="hljs-number">0</span>))&#123;        res += <span class="hljs-string">&quot;-&quot;</span>    &#125;        num := abs(numerator)    den := abs(denominator)    res += strconv.Itoa(num/den)    num %= den    <span class="hljs-keyword">if</span> num == <span class="hljs-number">0</span>&#123;        <span class="hljs-keyword">return</span> res    &#125;        res += <span class="hljs-string">&quot;.&quot;</span>    numMap := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">int</span>]<span class="hljs-keyword">int</span>)    numMap[num] = <span class="hljs-built_in">len</span>(res)    <span class="hljs-keyword">for</span> num != <span class="hljs-number">0</span> &#123;        num *= <span class="hljs-number">10</span>        res += strconv.Itoa(num/den)        num %= den        <span class="hljs-keyword">if</span> index, ok := numMap[num];ok&#123;            res = res[:index] + <span class="hljs-string">&quot;(&quot;</span> + res[index:] + <span class="hljs-string">&quot;)&quot;</span>            <span class="hljs-keyword">break</span>        &#125;<span class="hljs-keyword">else</span>&#123;            numMap[num] = <span class="hljs-built_in">len</span>(res)        &#125;    &#125;    <span class="hljs-keyword">return</span> res&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•</category>
      
      <category>LeetCode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç®—æ³•</tag>
      
      <tag>å“ˆå¸Œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»0å®ç°Golangé«˜æ€§èƒ½å®šæ—¶å™¨</title>
    <link href="/2020/10/26/%E4%BB%8E0%E5%AE%9E%E7%8E%B0Golang%E9%AB%98%E6%80%A7%E8%83%BD%E5%AE%9A%E6%97%B6%E5%99%A8/"/>
    <url>/2020/10/26/%E4%BB%8E0%E5%AE%9E%E7%8E%B0Golang%E9%AB%98%E6%80%A7%E8%83%BD%E5%AE%9A%E6%97%B6%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<p>ç°åœ¨åœ¨åšçš„ä¸šåŠ¡æœ‰å¤§é‡å¾ªç¯å®šæœŸä»»åŠ¡ï¼Œç›®å‰ç”¨çš„æ˜¯å°æ ¹å †+å®šæœŸcheckï¼Œå‰å‡ å¤©é¢è¯•ï¼Œé¢è¯•å®˜å»ºè®®å¯ä»¥ç”¨æ—¶é—´è½®ï¼Œä½†æ˜¯golangè¿˜æ²¡æœ‰æˆ‘ç‰¹åˆ«å–œæ¬¢çš„å®ç°ï¼Œæ‰€ä»¥å†³å®šè‡ªå·±å†™ï¼ˆzaoï¼‰ä¸€ï¼ˆlunï¼‰ä¸ªï¼ˆziï¼‰ã€‚</p><p>å¸Œæœ›çš„featureï¼š</p><ol><li>è‡ªå®šä¹‰æ—¶é—´ç²’åº¦ã€‚</li><li>æ”¯æŒä¸€æ¬¡æ€§å®šæ—¶ï¼Œå‘¨æœŸæ€§å®šæ—¶ã€‚</li><li><strong>é«˜æ€§èƒ½</strong>ã€‚</li><li>æ”¯æŒä¼ å‡½æ•°å‚æ•°ã€‚ï¼ˆä¸ªäººéœ€æ±‚ï¼‰</li><li>æ”¯æŒsleepã€‚</li></ol><h2 id="é¢„å¤‡èµ„æ–™"><a href="#é¢„å¤‡èµ„æ–™" class="headerlink" title="é¢„å¤‡èµ„æ–™"></a>é¢„å¤‡èµ„æ–™</h2><p>|  å®šæ—¶å™¨åº“  | å®ç°åŸç†  | ç¼ºç‚¹ | ä¼˜ç‚¹<br>|  â€”-  | â€”-  | â€”-<br>|&lt;Go1.10 timer | å…¨å±€å”¯ä¸€çš„timerprocåç¨‹å’Œtime bucketï¼ˆå››å‰å †ï¼‰ã€‚|å…¨å±€å…±ç”¨çš„äº’æ–¥é”å¼€é”€è¿‡å¤§ã€‚ | å››å‰å †å¯¹ç¼“å­˜å‹å¥½ã€‚<br>|Go1.10-1.13 timer| GOMAXPROCSï¼ˆé»˜è®¤64) ä¸ªtimerprocåç¨‹å’Œtime bucketï¼Œè¿›è¡Œåˆ†æ¡¶ã€‚| å¤„ç†å™¨å’Œåç¨‹ä¹‹é—´é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚| åˆ†æ¡¶ï¼Œé™ä½é”ç²’åº¦ã€‚<br>|&gt;Go1.14 timer| å–æ¶ˆtimerprocåç¨‹å’Œæ¡¶ï¼Œtimerç›´æ¥å’Œå¤„ç†å™¨ï¼ˆruntime.pï¼‰ç»‘å®šï¼Œéƒ½äº¤ç”±å¤„ç†å™¨çš„ç½‘ç»œè½®è¯¢å™¨å’Œè°ƒåº¦å™¨è§¦å‘ã€‚ | |å……åˆ†åˆ©ç”¨æœ¬åœ°æ€§ã€å‡å°‘çº¿ä¸Šä¸Šä¸‹æ–‡çš„åˆ‡æ¢å¼€é”€ï¼Œä¹Ÿæ˜¯ç›®å‰æ€§èƒ½æœ€å¥½çš„å®ç°æ–¹å¼ã€‚<br>|Netty|<br>|kafka|</p><h2 id="æ€»ä½“ç»“æ„"><a href="#æ€»ä½“ç»“æ„" class="headerlink" title="æ€»ä½“ç»“æ„"></a>æ€»ä½“ç»“æ„</h2><h2 id="é€»è¾‘"><a href="#é€»è¾‘" class="headerlink" title="é€»è¾‘"></a>é€»è¾‘</h2><h2 id="benchmark"><a href="#benchmark" class="headerlink" title="benchmark"></a>benchmark</h2>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>2020å¹´çš„æŠ€æœ¯å‘Flag</title>
    <link href="/2020/10/26/2020%E7%9A%84Flag/"/>
    <url>/2020/10/26/2020%E7%9A%84Flag/</url>
    
    <content type="html"><![CDATA[<p>2020è¿˜å‰©ä¸¤ä¸ªæœˆï¼Œç»™è‡ªå·±ç«‹å‡ ä¸ªFlagå§ã€‚</p><a id="more"></a><ol><li><p>ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰6.824 çš„lab3åšå®Œå¹¶ä¸”å†™å®Œå®ç°ç¬”è®°ã€‚</p></li><li><p>ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰ç»§ç»­ä¼˜åŒ–CocoCacheï¼Œä¼˜åŒ–GCå¼€é”€ã€‚</p></li><li><p>ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰ä¸šåŠ¡é©±åŠ¨çš„éœ€æ±‚ï¼šç”¨Goå®ç°ä¸€ä¸ªæ—¶é—´è½®ç®—æ³•ï¼Œå‚è€ƒå®ç°ï¼š<a href="https://github.com/rfyiamcool/go-ringtimer%EF%BC%8C">https://github.com/rfyiamcool/go-ringtimerï¼Œ</a>  <a href="https://github.com/wuYin/timewheel%E3%80%82">https://github.com/wuYin/timewheelã€‚</a></p></li><li><p>ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰æ¨¡ä»¿Ginå†™ä¸€ä¸ªwebæ¡†æ¶ã€‚</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>ä¸ªäºº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é»„ç‹—æ‚è°ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ¯å¤©ä¸€é¢˜ Leetcode å¡«å……æ¯ä¸ªèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªå³ä¾§èŠ‚ç‚¹æŒ‡é’ˆ II</title>
    <link href="/2020/10/21/%E6%AF%8F%E5%A4%A9%E4%B8%80%E9%A2%98-%E5%A1%AB%E5%85%85%E8%8A%82%E7%82%B9/"/>
    <url>/2020/10/21/%E6%AF%8F%E5%A4%A9%E4%B8%80%E9%A2%98-%E5%A1%AB%E5%85%85%E8%8A%82%E7%82%B9/</url>
    
    <content type="html"><![CDATA[<p>ä¸€é“ç‰¹æ®Šçš„äºŒå‰æ ‘BFSé¢˜ç›®ã€‚</p><a id="more"></a><h2 id="1-é¢˜ç›®"><a href="#1-é¢˜ç›®" class="headerlink" title="1. é¢˜ç›®"></a>1. é¢˜ç›®</h2><div class="note note-primary">            <p>ç»™å®šä¸€ä¸ªäºŒå‰æ ‘</p><pre><code>struct Node {  int val;  Node *left;  Node *right;  Node *next;}</code></pre><p>å¡«å……å®ƒçš„æ¯ä¸ª next æŒ‡é’ˆï¼Œè®©è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘å…¶ä¸‹ä¸€ä¸ªå³ä¾§èŠ‚ç‚¹ã€‚å¦‚æœæ‰¾ä¸åˆ°ä¸‹ä¸€ä¸ªå³ä¾§èŠ‚ç‚¹ï¼Œåˆ™å°† next æŒ‡é’ˆè®¾ç½®ä¸º NULLã€‚</p><p>åˆå§‹çŠ¶æ€ä¸‹ï¼Œæ‰€æœ‰ next æŒ‡é’ˆéƒ½è¢«è®¾ç½®ä¸º NULLã€‚</p><p>è¿›é˜¶ï¼š</p><p>ä½ åªèƒ½ä½¿ç”¨å¸¸é‡çº§é¢å¤–ç©ºé—´ã€‚<br>ä½¿ç”¨é€’å½’è§£é¢˜ä¹Ÿç¬¦åˆè¦æ±‚ï¼Œæœ¬é¢˜ä¸­é€’å½’ç¨‹åºå ç”¨çš„æ ˆç©ºé—´ä¸ç®—åšé¢å¤–çš„ç©ºé—´å¤æ‚åº¦ã€‚</p>          </div><h2 id="2-è§£æ³•"><a href="#2-è§£æ³•" class="headerlink" title="2. è§£æ³•"></a>2. è§£æ³•</h2><p>ç°åœ¨ç½‘ä¸Šçš„è§£æ³•æ˜¯é€‚ç”¨äºå®Œå…¨äºŒå‰æ ‘ï¼ˆåŸé¢˜æ˜¯å®Œå…¨äºŒå‰æ ‘ï¼‰çš„ï¼Œä½†æ˜¯å¯¹äºæ™®é€šäºŒå‰æ ‘ï¼Œå°±ä¸å®ç”¨äº†ã€‚æŠŠæ¡ä½ä¸¤ä¸ªç‚¹ï¼š</p><ol><li>åˆ©ç”¨nextèŠ‚ç‚¹å¯ä»¥åœ¨äºŒå‰æ ‘çš„åŒä¸€çº§å†…è‡ªç”±è·³è½¬ã€‚</li><li>éœ€è¦æ‰¾åˆ°åŒä¸€çº§å†…ç¦»ä½ æœ€è¿‘çš„å³ä¾§èŠ‚ç‚¹ã€‚</li></ol><p>å¾ˆæ˜æ˜¾å¯ä»¥ç”¨BFSæ¥åšï¼Œå°†ä»£ç ä¿®æ”¹ä¸€ä¸‹åŠ ä¸€ä¸ªBFSé€»è¾‘å°±å¯ä»¥äº†ï¼ˆä¸æ˜¯å…¸å‹BFSä»£ç çš„æ ·å¼ï¼Œæ²¡æœ‰é˜Ÿåˆ—ï¼Œä½†æ˜¯æ€æƒ³æ˜¯BFSï¼Œåˆ†å±‚éå†ï¼‰ã€‚</p><ol><li>åˆ©ç”¨nextèŠ‚ç‚¹ä»å·¦å‘å³éå†å½“å‰èŠ‚ç‚¹çš„å±‚æ¬¡ï¼Œå¸®å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€å±‚èŠ‚ç‚¹æ‰¾åˆ°ä»–ä»¬çš„nextèŠ‚ç‚¹ã€‚</li><li>ç”¨ä¸€ä¸ªå˜é‡è®°ä¸‹ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æœ€å·¦èŠ‚ç‚¹ã€‚</li><li>å†éå†ä¸‹ä¸€å±‚ï¼Œå¾ªç¯å¾€å¤ã€‚</li></ol><pre><code class="hljs go"><span class="hljs-comment">/**</span><span class="hljs-comment"> * Definition for a Node.</span><span class="hljs-comment"> * type Node struct &#123;</span><span class="hljs-comment"> *     Val int</span><span class="hljs-comment"> *     Left *Node</span><span class="hljs-comment"> *     Right *Node</span><span class="hljs-comment"> *     Next *Node</span><span class="hljs-comment"> * &#125;</span><span class="hljs-comment"> */</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">connect</span><span class="hljs-params">(root *Node)</span> *<span class="hljs-title">Node</span></span> &#123;    <span class="hljs-keyword">if</span> root == <span class="hljs-literal">nil</span> &#123;        <span class="hljs-keyword">return</span> root    &#125;           <span class="hljs-keyword">for</span> leftNode:= root;leftNode!=<span class="hljs-literal">nil</span>;&#123;        <span class="hljs-keyword">var</span> firstChild *Node        <span class="hljs-keyword">for</span> curNode := leftNode;curNode != <span class="hljs-literal">nil</span>;curNode = curNode.Next&#123;            <span class="hljs-keyword">if</span> curNode.Left != <span class="hljs-literal">nil</span>&#123;                <span class="hljs-keyword">if</span> curNode.Right != <span class="hljs-literal">nil</span>&#123;                    curNode.Left.Next=curNode.Right;                &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> curNode.Next != <span class="hljs-literal">nil</span> &#123;                    curNode.Left.Next=findLeftestNode(curNode.Next)                &#125;                <span class="hljs-keyword">if</span> firstChild == <span class="hljs-literal">nil</span>&#123;                    firstChild = curNode.Left                &#125;            &#125;            <span class="hljs-keyword">if</span> curNode.Right != <span class="hljs-literal">nil</span> &#123;                <span class="hljs-keyword">if</span> curNode.Next != <span class="hljs-literal">nil</span>&#123;                     curNode.Right.Next = findLeftestNode(curNode.Next)                &#125;                <span class="hljs-keyword">if</span> firstChild == <span class="hljs-literal">nil</span>&#123;                    firstChild = curNode.Right                &#125;            &#125;        &#125;        leftNode = firstChild    &#125;<span class="hljs-keyword">return</span> root&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findLeftestNode</span><span class="hljs-params">(root *Node)</span> *<span class="hljs-title">Node</span></span>&#123;    <span class="hljs-keyword">for</span> curNode:= root; curNode != <span class="hljs-literal">nil</span> ;curNode = curNode.Next&#123;        <span class="hljs-keyword">if</span> curNode.Left != <span class="hljs-literal">nil</span>&#123;            <span class="hljs-keyword">return</span> curNode.Left        &#125;        <span class="hljs-keyword">if</span> curNode.Right != <span class="hljs-literal">nil</span>&#123;            <span class="hljs-keyword">return</span> curNode.Right        &#125;    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•</category>
      
      <category>LeetCode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç®—æ³•</tag>
      
      <tag>BFS</tag>
      
      <tag>äºŒå‰æ ‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ¯å¤©ä¸€é¢˜ LeetCode81 Search in Rotated Sorted Array II</title>
    <link href="/2020/10/13/%E6%AF%8F%E5%A4%A9%E4%B8%80%E9%A2%98-LeetCode81-Search-in-Rotated-Sorted-Array-II/"/>
    <url>/2020/10/13/%E6%AF%8F%E5%A4%A9%E4%B8%80%E9%A2%98-LeetCode81-Search-in-Rotated-Sorted-Array-II/</url>
    
    <content type="html"><![CDATA[<p>ç‰¹æ®Šæƒ…å†µçš„äºŒåˆ†ç®—æ³•ã€‚</p><a id="more"></a><h1 id="æ¯å¤©ä¸€é¢˜-LeetCode81-Search-in-Rotated-Sorted-Array-II"><a href="#æ¯å¤©ä¸€é¢˜-LeetCode81-Search-in-Rotated-Sorted-Array-II" class="headerlink" title="æ¯å¤©ä¸€é¢˜ LeetCode81 Search in Rotated Sorted Array II"></a>æ¯å¤©ä¸€é¢˜ LeetCode81 Search in Rotated Sorted Array II</h1><h2 id="1-é¢˜ç›®"><a href="#1-é¢˜ç›®" class="headerlink" title="1. é¢˜ç›®"></a>1. é¢˜ç›®</h2><p><a href="https://leetcode.com/problems/search-in-rotated-sorted-array-ii/">https://leetcode.com/problems/search-in-rotated-sorted-array-ii/</a></p><div class="note note-primary">            <p>Suppose an array sorted in ascending order is rotated at some pivot unknown to you beforehand.</p><p>(i.e., [0,0,1,2,2,5,6] might become [2,5,6,0,0,1,2]).</p><p>You are given a target value to search. If found in the array return true, otherwise return false.</p><p>Example 1:</p><pre><code>Input: nums = [2,5,6,0,0,1,2], target = 0Output: true</code></pre><p>Example 2:</p><pre><code>Input: nums = [2,5,6,0,0,1,2], target = 3Output: falseFollow up:</code></pre><ul><li>This is a follow up problem to Search in Rotated Sorted Array, where nums may contain duplicates.</li><li>Would this affect the run-time complexity? How and why?</li></ul>          </div><h2 id="2-è§£æ³•"><a href="#2-è§£æ³•" class="headerlink" title="2. è§£æ³•"></a>2. è§£æ³•</h2><p>ä½¿ç”¨äºŒåˆ†æ³•ï¼Œmidçš„ä½ç½®æœ‰ä¸‰ç§æƒ…å†µï¼ˆgoogleç»˜å›¾ï¼Œå¾ˆä¸‘ï¼Œå¤§æ¦‚æ‡‚æ„æ€å°±è¡Œï¼‰ï¼š</p><table><thead><tr><th>å›¾ç¤º</th><th><div style="width: 260pt">æŒ‡é’ˆå¤§å°æƒ…å†µ</div></th></tr></thead><tbody><tr><td><img src="/img/leetcode/rightmid.png" alt="img"></td><td>nums[mid] &lt;= nums[right] &lt;= nums[left]</td></tr><tr><td><img src="/img/leetcode/leftmid.png" alt="img"></td><td>nums[right] &lt;= nums[left] &lt;= nums[mid]</td></tr><tr><td><img src="/img/leetcode/totalSorted.png" alt="img"></td><td>nums[left] &lt;= nums[mid] &lt;= nums[right]</td></tr></tbody></table><p>å†åˆ†åˆ«åœ¨è¿™ä¸‰ç§æƒ…å†µé‡Œé’ˆå¯¹targetçš„ä½ç½®è¿›è¡Œåˆ¤å®šå°±è¡Œäº†ã€‚<br>ä»£ç ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">search</span><span class="hljs-params">(nums []<span class="hljs-keyword">int</span>, target <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123;    l, r := <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(nums) - <span class="hljs-number">1</span>    <span class="hljs-keyword">for</span> l &lt;= r &#123;        <span class="hljs-keyword">for</span> l &lt; r &amp;&amp; nums[l+<span class="hljs-number">1</span>] == nums[l]&#123; <span class="hljs-comment">// å»é‡</span>            l++        &#125;        <span class="hljs-keyword">for</span> r &gt; l &amp;&amp; nums[r<span class="hljs-number">-1</span>] == nums[r]&#123; <span class="hljs-comment">// å»é‡</span>            r--        &#125;        m := l + (r - l) / <span class="hljs-number">2</span>        fmt.Println(l,m,r)        <span class="hljs-keyword">switch</span>&#123;        <span class="hljs-keyword">case</span> nums[m] == target :            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>         <span class="hljs-keyword">case</span> nums[m] &lt;= nums[r] &amp;&amp; nums[r] &lt;= nums[l]: <span class="hljs-comment">//mid åœ¨æ›´å°çš„è¿™è¾¹</span>            <span class="hljs-keyword">if</span> target &lt; nums[m] || target &gt; nums[r]&#123;                r = m - <span class="hljs-number">1</span>            &#125;<span class="hljs-keyword">else</span>&#123;                l = m + <span class="hljs-number">1</span>            &#125;        <span class="hljs-keyword">case</span> nums[r] &lt;= nums[l] &amp;&amp; nums[l] &lt;= nums[m]: <span class="hljs-comment">//mid åœ¨æ›´å¤§çš„è¿™è¾¹</span>            <span class="hljs-keyword">if</span> target &lt; nums[m] &amp;&amp; target &gt; nums[r]&#123;                r = m - <span class="hljs-number">1</span>            &#125;<span class="hljs-keyword">else</span>&#123;                l = m + <span class="hljs-number">1</span>            &#125;        <span class="hljs-keyword">case</span> nums[l] &lt;= nums[m] &amp;&amp; nums[m] &lt;= nums[r]: <span class="hljs-comment">//lä¸rä¹‹é—´æ˜¯é¡ºåº</span>            <span class="hljs-keyword">if</span> target &lt; nums[m]&#123;                r = m - <span class="hljs-number">1</span>            &#125;<span class="hljs-keyword">else</span>&#123;                l = m + <span class="hljs-number">1</span>            &#125;        &#125;    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•</category>
      
      <category>LeetCode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç®—æ³•</tag>
      
      <tag>äºŒåˆ†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2020 Spring 6.824 Lab2C: Raft State Persistç¬”è®°</title>
    <link href="/2020/10/10/2020-Spring-6-824-Lab2C-Raft-State-Persist%E7%AC%94%E8%AE%B0/"/>
    <url>/2020/10/10/2020-Spring-6-824-Lab2C-Raft-State-Persist%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="2020-Spring-6-824-Lab2C-Raft-State-Persistç¬”è®°"><a href="#2020-Spring-6-824-Lab2C-Raft-State-Persistç¬”è®°" class="headerlink" title="2020 Spring 6.824 Lab2C: Raft State Persistç¬”è®°"></a>2020 Spring 6.824 Lab2C: Raft State Persistç¬”è®°</h1><h2 id="0-Raftç®—æ³•åŸºç¡€"><a href="#0-Raftç®—æ³•åŸºç¡€" class="headerlink" title="0. Raftç®—æ³•åŸºç¡€"></a>0. Raftç®—æ³•åŸºç¡€</h2><p>æœ€å¥½å…ˆçœ‹ä¸€éè®ºæ–‡åŸæ–‡ï¼š<a href="https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf">https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf</a></p><p>è¿™ä¸ªä¸­æ–‡ç¿»è¯‘å¾ˆä¸é”™ï¼Œæˆ‘çš„æ³¨é‡Šä»£ç å¾ˆå¤šéƒ½æ˜¯å‚ç…§é‡Œé¢ï¼š<a href="https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md">https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md</a></p><p>è¿™ä¸ªRaftå¯è§†åŒ–ä¹Ÿä¸é”™ï¼Œå¦‚æœçœ‹ä¸ä¸‹è®ºæ–‡å¯ä»¥å…ˆçœ‹ä¸€éè¿™ä¸ªï¼š<a href="http://thesecretlivesofdata.com/raft/">http://thesecretlivesofdata.com/raft/</a></p><p>æœ¬ç« ä»£ç åœ°å€ï¼š<a href="https://github.com/keleqnma/6.824-notes-codes/tree/master/src/raft">https://github.com/keleqnma/6.824-notes-codes/tree/master/src/raft</a></p>]]></content>
    
    
    <categories>
      
      <category>åˆ†å¸ƒå¼ç³»ç»Ÿ</category>
      
      <category>6.824</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åˆ†å¸ƒå¼ç³»ç»Ÿ</tag>
      
      <tag>6.824</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2020 Spring 6.824 Lab2B: Raft Log Replicationç¬”è®°</title>
    <link href="/2020/10/10/2020-Spring-6-824-Lab2B-Raft-Log-Replication%E7%AC%94%E8%AE%B0/"/>
    <url>/2020/10/10/2020-Spring-6-824-Lab2B-Raft-Log-Replication%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<p>å½“Leaderè¢«é€‰ä¸¾å‡ºæ¥åï¼Œå°†ä¼šä»å®¢æˆ·ç«¯æ¥æ”¶å‘½ä»¤æ›´æ–°æ—¥å¿—ï¼ŒleaderèŠ‚ç‚¹ä¼šç»´æŠ¤æ—¥å¿—æ¡ç›®æ›´æ–°çš„ä¸€è‡´æ€§ã€‚æœ¬ç« å°†å®ç°Lab2Bï¼Œè¯¦ç»†ä»‹ç»å¦‚ä½•å®ç°Raftç®—æ³•é‡Œçš„Raft Log Replicationï¼Œä»¥åŠè¯¥éƒ¨åˆ†çš„å¯é æ€§ï¼Œå¦‚ä½•å¤„ç†ä¹±åºï¼Œæ–­è¿ç­‰å¤æ‚ç½‘ç»œæƒ…å†µã€‚</p><a id="more"></a><h1 id="2020-Spring-6-824-Lab2B-Raft-Log-Replicationç¬”è®°"><a href="#2020-Spring-6-824-Lab2B-Raft-Log-Replicationç¬”è®°" class="headerlink" title="2020 Spring 6.824 Lab2B: Raft Log Replicationç¬”è®°"></a>2020 Spring 6.824 Lab2B: Raft Log Replicationç¬”è®°</h1><h2 id="0-Raft-Log-Replicationåœ¨å¹²å•¥"><a href="#0-Raft-Log-Replicationåœ¨å¹²å•¥" class="headerlink" title="0. Raft Log Replicationåœ¨å¹²å•¥"></a>0. Raft Log Replicationåœ¨å¹²å•¥</h2><div class="note note-info">            <p>rafté›†ç¾¤æ¥å—clientçš„æ·»åŠ logéœ€æ±‚ï¼Œleaderéœ€è¦è´Ÿè´£logåœ¨é›†ç¾¤å†…éƒ¨çš„å¤åˆ¶ï¼Œä¿è¯logçš„æœ‰åºæ€§ï¼Œå”¯ä¸€æ€§ï¼Œåœ¨éƒ¨åˆ†èŠ‚ç‚¹å®•æœºï¼Œç½‘ç»œéš”ç¦»çš„æƒ…å†µä¸‹ä»èƒ½ä¿è¯æœåŠ¡çš„ç¨³å®šæ€§ã€‚</p><p>raftå¦‚ä½•å®ç°ï¼Ÿ</p><p>ç”¨termï¼Œlog indexæ ‡è¯†logï¼Œå¹¶åœ¨å¿ƒè·³æ£€æŸ¥ï¼Œé€‰ä¸¾æ£€æŸ¥æ—¶ä¿è¯leaderæ‹¥æœ‰ä¹‹å‰commitçš„æ‰€æœ‰logï¼Œleaderå†ä¸æ–­å¯¹followerå‘å‡ºå¿ƒè·³å¯¹followerå¤åˆ¶logã€‚</p>          </div><p>æœ€å¥½å…ˆçœ‹ä¸€éè®ºæ–‡åŸæ–‡ï¼š<a href="https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf">https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf</a></p><p>è¿™ä¸ªä¸­æ–‡ç¿»è¯‘å¾ˆä¸é”™ï¼Œæˆ‘çš„æ³¨é‡Šä»£ç å¾ˆå¤šéƒ½æ˜¯å‚ç…§é‡Œé¢ï¼š<a href="https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md">https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md</a></p><p>è¿™ä¸ªRaftå¯è§†åŒ–ä¹Ÿä¸é”™ï¼Œå¦‚æœçœ‹ä¸ä¸‹è®ºæ–‡å¯ä»¥å…ˆçœ‹ä¸€éè¿™ä¸ªï¼š<a href="http://thesecretlivesofdata.com/raft/">http://thesecretlivesofdata.com/raft/</a></p><p>æœ¬ç« ä»£ç åœ°å€ï¼š<a href="https://github.com/keleqnma/6.824-notes-codes/tree/master/src/raft">https://github.com/keleqnma/6.824-notes-codes/tree/master/src/raft</a></p><p>æˆ‘è¿˜æ˜¯å»ºè®®æƒ³å­¦6.824çš„åŒå­¦ä»”ä»”ç»†ç»†å»çœ‹ä¸€éè®ºæ–‡åŸæ–‡ï¼Œä¹‹å‰æˆ‘çœ‹äº†ä¸€äº›æ–‡ç« ï¼Œææ‡‚äº†Raftå¤§è‡´æ˜¯ä»€ä¹ˆåŸç†ï¼Œæ€ä¹ˆå·¥ä½œçš„ï¼Œä½†æ˜¯è¦å®ç°å®ƒå¿…é¡»è¿˜æ˜¯è¦å»çœ‹åŸæ–‡ï¼Œæœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦æ³¨æ„ã€‚</p><h2 id="1-æµ‹è¯•ä»£ç "><a href="#1-æµ‹è¯•ä»£ç " class="headerlink" title="1. æµ‹è¯•ä»£ç "></a>1. æµ‹è¯•ä»£ç </h2><p>æµ‹è¯•ä»£ç åˆå§‹åŒ–æˆ‘å·²ç»åœ¨2Aä¸­è®²è¿‡äº†ï¼Œè¿™é‡Œä¸å†è®²ï¼Œè¿™é‡Œå¤§æ¦‚è®²ä¸€ä¸‹2Bçš„æµ‹è¯•éƒ½æ˜¯æµ‹è¯•ä»€ä¹ˆæƒ…å†µã€‚</p><p>2Bçš„æµ‹è¯•å¾ˆå¤šï¼Œæœ‰å…«ä¸ªã€‚</p><p>2Bè¦æ±‚ä¿è¯é›†ç¾¤æ¥å—logï¼Œleaderç”¨appendEntriesåœ¨é›†ç¾¤é‡ŒåŒæ­¥logï¼Œå¹¶è¦æ±‚leaderï¼Œfollowerå®•æœºçš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥ä¿è¯æœåŠ¡ç¨³å®šæ€§ã€‚</p><table><thead><tr><th>æµ‹è¯•</th><th>æµ‹è¯•å†…å®¹</th><th>é”™è¯¯æƒ…å†µ</th></tr></thead><tbody><tr><td>TestBasicAgree2B</td><td>ç®€å•çš„æäº¤çš„ä¸€ä¸ªlogï¼Œç„¶åæ£€æŸ¥å„ä¸ªraft serverå…³äºè¯¥logæœ‰æ²¡æœ‰è¾¾æˆä¸€è‡´</td><td></td></tr><tr><td>TestRPCBytes2B</td><td>æ£€æŸ¥logåœ¨æ²¡æœ‰æ–­è”çš„æƒ…å†µä¸‹æœ‰æ²¡æœ‰é‡å‘/å¤šå‘ã€‚</td><td>1.å¿ƒè·³é—´éš”è®¾ç½®å¤ªçŸ­ä¼šå‡ºç°è¿‡ä¸äº†çš„æƒ…å†µï¼Œå»ºè®®æŒ‰ç…§è®ºæ–‡æ¨èè®¾ç½®ï¼Œ150msï¼Œtesteré™åˆ¶ä¸€ç§’è‡³å¤šåæ¬¡å¿ƒè·³ã€‚2.leaderå‘followå‘é€rpcåç­‰å¾…å›ä¿¡çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šè¶…æ—¶ï¼Œè¿™æ—¶å€™å¯èƒ½ä¼šé‡å‘ï¼Œè¿™é‡Œå¯ä»¥åŠ ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œæˆ–è€…åŠ ä¸€ä¸ªchannelï¼Œè¡¨ç¤ºæ­£åœ¨å‘é€ï¼Œä¸éœ€è¦å¯åŠ¨é¢å¤–çš„é‡å‘ã€‚</td></tr><tr><td>TestFailAgree2B</td><td>æµ‹è¯•å°‘æ•°ï¼ˆ1/3ï¼‰çš„èŠ‚ç‚¹å¤±è´¥é‡è¿æ—¶çš„ç³»ç»Ÿæƒ…å†µ</td><td>å å¤šæ•°èŠ‚ç‚¹çš„ç½‘ç»œå†…éƒ¨æ­£å¸¸ï¼Œå°‘æ•°æ–­è”èŠ‚ç‚¹å†…éƒ¨æ— æ³•é€‰ä¸¾å‡ºä¸€ä¸ªæ–°Leaderï¼Œtermä¸æ–­å¢åŠ ï¼Œé‡è¿återmæ¯”å…¶ä»–èŠ‚ç‚¹éƒ½å¤§ï¼Œå´åˆæ²¡æœ‰æ­£ç¡®çš„logï¼Œå…¶ä»–èŠ‚ç‚¹æ‹’ç»æŠ•ç¥¨ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå†…éƒ¨æ— æ³•é€‰å‡ºLeaderã€‚</td></tr><tr><td>TestFailNoAgree2B</td><td>æµ‹è¯•ä¸€åŠä»¥ä¸Šï¼ˆ3/5ï¼‰çš„èŠ‚ç‚¹å¤±è´¥é‡è¿æ—¶çš„ç³»ç»Ÿæƒ…å†µ</td><td>å¦‚ä¸Šã€‚</td></tr><tr><td>TestConcurrentStarts2B</td><td>æ£€æŸ¥å¹¶å‘å‘raftå‡†å¤‡åŒæ­¥çš„æ—¥å¿—é‡Œæäº¤çš„æƒ…å†µ</td><td></td></tr><tr><td>TestRejoin2B</td><td>è€leaderæ–­è”åè‡ªå·±æ”¶äº†ä¸€å¤§å †logï¼Œæ–°leaderä¹Ÿæ”¶ä¸€å¤§å †logï¼ˆå’Œè€leaderä¸ä¸€è‡´ï¼‰ï¼Œç„¶åé‡è¿è€leaderï¼Œæ£€æŸ¥æ˜¯å¦æ­£å¸¸ã€‚</td><td></td></tr><tr><td>TestBackup2B</td><td>æ£€æŸ¥æ—¥å¿—åŒæ­¥èƒ½åŠ›ã€‚ä¸æ–­disconnectä¸åŒçš„leaderï¼Œä¸€ä¸‹å­disconnectå¤§å¤šæ•°å¯¼è‡´é›†ç¾¤å´©æºƒï¼Œä¸€ä¸‹å­connectå›æ¥å¯¼è‡´é›†ç¾¤æ¢å¤ï¼Œä¸»è¦æ˜¯è€ƒå¯Ÿå¤æ‚ç½‘ç»œæƒ…å†µä¸‹raftç®—æ³•èƒ½ä¸èƒ½ä¿è¯æ•°æ®åŒæ­¥çš„å¿«é€Ÿæ€§ç¨³å®šæ€§ã€‚</td><td>éå¸¸å¤šï¼ŒåŒ…å«å¤§é‡çš„éšæœºæ€§ã€‚</td></tr><tr><td>TestCount2B</td><td>ä¸»è¦è¿˜æ˜¯æ£€éªŒå®Œæˆæ•´ä¸ªé›†ç¾¤çš„commitéœ€è¦çš„æ—¶é—´å’ŒRPCæ¬¡æ•°ï¼Œä»¥åŠæ²¡æœ‰ç½‘ç»œéš”ç¦»æƒ…å†µä¸‹leaderå’Œtermæ˜¯å¦æœ‰å˜åŒ–ã€‚</td><td></td></tr></tbody></table><h2 id="2-ç»“æ„å®šä¹‰"><a href="#2-ç»“æ„å®šä¹‰" class="headerlink" title="2. ç»“æ„å®šä¹‰"></a>2. ç»“æ„å®šä¹‰</h2><p><img src="/img/raft/AppendEntriesRPC.png" alt="img"><br>ä»£ç ï¼š</p><pre><code class="hljs go"><span class="hljs-keyword">type</span> AppendEntriesArgs <span class="hljs-keyword">struct</span> &#123;Term         <span class="hljs-keyword">int</span>LeaderId     <span class="hljs-keyword">int</span>PrevLogIndex <span class="hljs-keyword">int</span>        <span class="hljs-comment">//ç´§é‚»éœ€è¦æ·»åŠ çš„æ–°æ—¥å¿—æ¡ç›®ä¹‹å‰çš„é‚£ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼•</span>PrevLogTerm  <span class="hljs-keyword">int</span>        <span class="hljs-comment">//ç´§é‚»éœ€è¦æ·»åŠ çš„æ–°æ—¥å¿—æ¡ç›®ä¹‹å‰çš„é‚£ä¸ªæ—¥å¿—æ¡ç›®çš„ä»»æœŸ</span>Entries      []LogEntry <span class="hljs-comment">//éœ€è¦è¢«ä¿å­˜çš„æ—¥å¿—æ¡ç›®ï¼ˆè¢«å½“åšå¿ƒè·³ä½¿ç”¨æ—¶æ—¥å¿—æ¡ç›®å†…å®¹ä¸ºç©ºï¼›ä¸ºäº†æé«˜æ•ˆç‡å¯èƒ½ä¸€æ¬¡æ€§å‘é€å¤šä¸ªï¼‰</span>LeaderCommit <span class="hljs-keyword">int</span>        <span class="hljs-comment">//Ledaerå·²çŸ¥å·²æäº¤çš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•</span>&#125;<span class="hljs-keyword">type</span> AppendEntriesReply <span class="hljs-keyword">struct</span> &#123;Term      <span class="hljs-keyword">int</span>  <span class="hljs-comment">// å½“å‰æœåŠ¡å™¨çš„term</span>Success   <span class="hljs-keyword">bool</span> <span class="hljs-comment">// æ˜¯å¦æˆåŠŸ</span>NextIndex <span class="hljs-keyword">int</span> <span class="hljs-comment">// å‰¯æœ¬ä¸»åŠ¨æŠ¥å‘Šè‡ªå·±éœ€è¦æ›´æ–°çš„log indexï¼Œ raftè®ºæ–‡é‡Œè¯´è¿™ç§ä¼˜åŒ–æ²¡å¿…è¦ï¼Œâ€œåœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬ååˆ†æ€€ç–‘è¿™ç§ä¼˜åŒ–æ˜¯å¦æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå¤±è´¥æ˜¯å¾ˆå°‘å‘ç”Ÿçš„å¹¶ä¸”ä¹Ÿä¸å¤§å¯èƒ½ä¼šæœ‰è¿™ä¹ˆå¤šä¸ä¸€è‡´çš„æ—¥å¿—ã€‚â€ï¼Œä½†æ˜¯6.824çš„æ¨¡æ‹Ÿç¯å¢ƒé‡Œå°±æ˜¯æœ‰è¿™ä¹ˆå¤šï¼Œæ‰€ä»¥éœ€è¦å®ç°è¿™ä¸ªä¼˜åŒ–ã€‚</span>&#125;</code></pre><h2 id="3-é€»è¾‘å®ç°"><a href="#3-é€»è¾‘å®ç°" class="headerlink" title="3. é€»è¾‘å®ç°"></a>3. é€»è¾‘å®ç°</h2><h3 id="3-1-å¯åŠ¨AppendEntries"><a href="#3-1-å¯åŠ¨AppendEntries" class="headerlink" title="3.1. å¯åŠ¨AppendEntries"></a>3.1. å¯åŠ¨AppendEntries</h3><p>appendEntriesLoopæ˜¯raftçš„ä¸‰å¤§æ—¶é—´é©±åŠ¨Loopä¹‹ä¸€ï¼Œè¦æ±‚æ¯ä¸ªå¿ƒè·³é—´éš”å‘é€ä¸€æ¬¡å¿ƒè·³ï¼ˆå¦‚æœæ²¡æœ‰éœ€è¦åŒæ­¥çš„logå°±æ˜¯å¿ƒè·³ï¼‰ã€‚</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span> <span class="hljs-title">applyLogLoop</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">for</span> &#123;<span class="hljs-keyword">select</span> &#123;<span class="hljs-keyword">case</span> &lt;-rf.stopCh:<span class="hljs-keyword">return</span><span class="hljs-keyword">case</span> &lt;-rf.applyTimer.C:rf.notifyApplyCh &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<span class="hljs-keyword">case</span> &lt;-rf.notifyApplyCh:rf.startApplyLogs()&#125;&#125;&#125;</code></pre><h3 id="3-2-æ¥æ”¶AppendEntries"><a href="#3-2-æ¥æ”¶AppendEntries" class="headerlink" title="3.2. æ¥æ”¶AppendEntries"></a>3.2. æ¥æ”¶AppendEntries</h3><ol><li>å¦‚æœå‘é€æ–¹çš„termå°äºæ¥å—æ–¹çš„termï¼Œæ‹’ç»æ·»åŠ ï¼Œ<strong>è¿”å›</strong>ã€‚</li><li>å‘é€æ–¹çš„termå¤§äºç­‰äºäºæ¥å—æ–¹çš„termï¼Œé‡ç½®é€‰ä¸¾è®¡æ—¶å™¨ï¼Œå¹¶ä¸”é‡ç½®æ¥æ”¶æ–¹ä¸ºfollowerã€‚</li><li>å¦‚æœ AppendEntriesArgs.PrevLogIndexï¼ˆå‘é€æ–¹è®¤ä¸ºæ¥æ”¶æ–¹å·²ç»æ·»åŠ çš„æœ€åçš„log indexï¼‰ &gt; å½“å‰æ¥æ”¶æ–¹æœ€åçš„log indexï¼Œä¸­é—´çš„logç¼ºå¤±ï¼Œæ¥æ”¶æ–¹æ‰¾åˆ°è‡ªå·±éœ€è¦æ·»åŠ çš„ç¬¬ä¸€ä½log indexï¼Œ<strong>è¿”å›</strong>ã€‚</li><li>å‘é€æ–¹å‘é€çš„logä¹±åºï¼Œtermæ²¡å˜ï¼Œä½†æ˜¯éœ€è¦æ·»åŠ çš„logæ¯”å½“å‰æœ€åä¸€ä½logå°ï¼Œ<strong>è¿”å›</strong>ã€‚</li><li>å‘é€æ–¹çš„logè®°å½•å’Œæ¥æ”¶æ–¹è®°å½•çŸ›ç›¾ï¼ˆåŒæ ·çš„log indexï¼Œlog termä¸ä¸€è‡´ï¼‰ï¼Œè®¡ç®—è‡ªå·±éœ€è¦å›é€€åˆ°çš„ä½ç½®ï¼Œ<strong>è¿”å›</strong>ã€‚</li><li>è®°å½•ä¸€è‡´ï¼ŒåŒ¹é…æ­£å¸¸ï¼Œ<strong>æ·»åŠ log</strong>ã€‚</li></ol><pre><code class="hljs go"><span class="hljs-comment">// å¦‚æœå‘é€æ–¹çš„termå°äºå½“å‰termï¼Œæ‹’ç»æ·»åŠ </span><span class="hljs-keyword">if</span> rf.currentTerm &gt; args.Term &#123;rf.unlock(<span class="hljs-string">&quot;append_entries&quot;</span>)<span class="hljs-keyword">return</span>&#125;<span class="hljs-comment">// æ¥æ”¶åˆ°appendentriesåé‡ç½®é€‰ä¸¾è®¡æ—¶å™¨ï¼Œå¹¶ä¸”é‡ç½®è§’è‰²</span>rf.currentTerm = args.Termrf.changeRole(Follower)rf.resetElectionTimer()_, lastLogIndex := rf.lastLogTermIndex()<span class="hljs-keyword">switch</span> &#123;<span class="hljs-keyword">case</span> args.PrevLogIndex &gt; lastLogIndex:<span class="hljs-comment">// ç¼ºå°‘ä¸­é—´çš„ log</span>reply.Success = <span class="hljs-literal">false</span>        <span class="hljs-comment">// è¿™é‡Œæ²¡æœ‰è®©leaderé‡‡å–å›é€€æ”¿ç­–ï¼Œè€Œæ˜¯ç›´æ¥è®¡ç®—å‘Šè¯‰leaderä¸‹ä¸€æ¬¡åº”è¯¥ä»å“ªé‡Œå‘é€æ—¥å¿—ï¼ˆç›´æ¥æŠŠå½“å‰æœ€åä¸€æ¡log indexè¿”å›ï¼‰</span>reply.NextIndex = rf.getNextIndex()<span class="hljs-keyword">case</span> rf.logEntries[rf.getRealIdxByLogIndex(args.PrevLogIndex)].Term == args.PrevLogTerm:<span class="hljs-keyword">if</span> rf.outOfOrderAppendEntries(args) &#123;reply.Success = <span class="hljs-literal">false</span>reply.NextIndex = <span class="hljs-number">0</span>&#125; <span class="hljs-keyword">else</span> &#123;reply.Success = <span class="hljs-literal">true</span>rf.logEntries = <span class="hljs-built_in">append</span>(rf.logEntries[<span class="hljs-number">0</span>:rf.getRealIdxByLogIndex(args.PrevLogIndex)+<span class="hljs-number">1</span>], args.Entries...)reply.NextIndex = rf.getNextIndex()&#125;<span class="hljs-keyword">default</span>:rf.log(<span class="hljs-string">&quot;prev log not match&quot;</span>)reply.Success = <span class="hljs-literal">false</span><span class="hljs-comment">// è·³è¿‡ä¸€ä¸ª term</span>Â·Â·Â·Â·Â·        term := rf.logEntries[args.PrevLogIndex].Term        idx := args.PrevLogIndex        <span class="hljs-keyword">for</span> idx &gt; rf.commitIndex &amp;&amp; rf.logEntries[idx].Term == term &#123;idx -= <span class="hljs-number">1</span>&#125;        <span class="hljs-comment">// ä¸Šä¸€ä¸ªtermä¸ä¸€è‡´ï¼Œå°±ç›´æ¥è·³è¿‡ä¸Šä¸€ä¸ªtermï¼Œè¿”å›ä¸Šä¸Šä¸ªtermçš„log indexï¼Œä»é‚£é‡Œå¼€å§‹æ·»åŠ </span>reply.NextIndex = idx + <span class="hljs-number">1</span>&#125;</code></pre><h3 id="3-3-å‘é€AppendEntries"><a href="#3-3-å‘é€AppendEntries" class="headerlink" title="3.3. å‘é€AppendEntries"></a>3.3. å‘é€AppendEntries</h3><ol><li><p>æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨å‘é€AppendEntriesçš„ï¼ˆè¿™é‡Œæˆ‘ç”¨äº†é”ï¼Œä¸æ˜¯å¾ˆå¥½ï¼Œå¯èƒ½ä¼šå¤§é‡block goroutineï¼Œåç»­ä¼šæ›´æ”¹ï¼‰ã€‚å¦‚æœæœ‰æ­£åœ¨å‘é€çš„ï¼Œ<strong>è¿”å›ã€‚</strong></p></li><li><p>å‘é€AppendEntriesRPCï¼Œç­‰å¾…ä¸€ä¸ªéšæœºçš„RPC timeoutï¼Œå¦‚æœè®¡æ—¶å™¨ç»“æŸå‰æ²¡æœ‰è¿”å›ï¼Œä¸€ç›´é‡å‘ç›´åˆ°æ”¶åˆ°å›å¤ã€‚</p></li><li><p>æ”¶åˆ°å›å¤ï¼Œå¼€å§‹æ£€æŸ¥ï¼š</p><ol><li>ç°åœ¨å½“å‰èŠ‚ç‚¹å·²ä¸å†æ˜¯leaderï¼Œæˆ–è€…termå‘ç”Ÿäº†å˜åŒ–ï¼Œ<strong>è¿”å›</strong>ã€‚</li><li>ç›®æ ‡èŠ‚ç‚¹çš„termæ¯”ç°åœ¨leaderé«˜ï¼ˆå¯èƒ½æ˜¯å› ä¸ºç½‘ç»œéš”ç¦»å¯¼è‡´çš„ï¼‰ï¼Œé‡ç½®å½“å‰è§’è‰²ä¸ºfollowerï¼Œæ”¹å˜termï¼Œé‡ç½®é€‰ä¸¾è®¡æ—¶å™¨ï¼Œ<strong>è¿”å›ã€‚</strong></li><li>è¿”å›å¤±è´¥ï¼Œé‡ç½®nextIndexï¼Œå†æ¬¡å‘é€ã€‚</li><li>è¿”å›æˆåŠŸï¼ŒåŒæ­¥ä¸€ä¸‹å·²ç»å¤åˆ¶çš„logä½ç½®ï¼Œå¹¶ä¸”å°è¯•commitã€‚ï¼ˆä¸€ä¸ªlogè¢«è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹æˆåŠŸå†™å…¥ï¼Œåˆ™å¯ä»¥åˆ¤æ–­æ˜¯æˆåŠŸcommitäº†ï¼‰</li></ol></li></ol><h2 id="4-ç®—æ³•å¯é æ€§-amp-ä¸€è‡´æ€§åˆ†æ"><a href="#4-ç®—æ³•å¯é æ€§-amp-ä¸€è‡´æ€§åˆ†æ" class="headerlink" title="4. ç®—æ³•å¯é æ€§&amp;ä¸€è‡´æ€§åˆ†æ"></a>4. ç®—æ³•å¯é æ€§&amp;ä¸€è‡´æ€§åˆ†æ</h2><p>ä¸€ç³»åˆ—é™åˆ¶ä¿è¯äº†logçš„å¯é æ€§å’Œä¸€è‡´æ€§ã€‚</p><ul><li><strong>Raftä¿è¯æ‰€æœ‰ä¹‹å‰çš„ä»»æœŸå·ä¸­å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®åœ¨é€‰ä¸¾çš„æ—¶å€™éƒ½ä¼šå‡ºç°åœ¨Leaderä¸­</strong>ï¼Œä¸éœ€è¦ä¼ é€è¿™äº›æ—¥å¿—æ¡ç›®ç»™Leaderã€‚è¿™æ„å‘³ç€æ—¥å¿—æ¡ç›®çš„ä¼ é€æ˜¯å•å‘çš„ï¼Œåªä»Leaderä¼ ç»™followerï¼Œå¹¶ä¸”Leaderä»ä¸ä¼šè¦†ç›–è‡ªèº«æœ¬åœ°æ—¥å¿—ä¸­å·²ç»å­˜åœ¨çš„æ¡ç›®ã€‚</li></ul><blockquote><p>RequestVoteRPC æœ‰è¿™æ ·çš„é™åˆ¶ï¼šRPC ä¸­åŒ…å«äº†å€™é€‰äººçš„æ—¥å¿—ä¿¡æ¯ï¼ŒæŠ•ç¥¨äººä¼šæ‹’ç»æ‰é‚£äº›æ—¥å¿—æ²¡æœ‰è‡ªå·±æ–°çš„æŠ•ç¥¨è¯·æ±‚ã€‚<br>Raft é€šè¿‡æ¯”è¾ƒä¸¤ä»½æ—¥å¿—ä¸­æœ€åä¸€æ¡æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼å’Œä»»æœŸå·å®šä¹‰è°çš„æ—¥å¿—æ¯”è¾ƒæ–°ã€‚å¦‚æœä¸¤ä»½æ—¥å¿—æœ€åçš„æ¡ç›®çš„ä»»æœŸå·ä¸åŒï¼Œé‚£ä¹ˆä»»æœŸå·å¤§çš„æ—¥å¿—æ›´åŠ æ–°ã€‚å¦‚æœä¸¤ä»½æ—¥å¿—æœ€åçš„æ¡ç›®ä»»æœŸå·ç›¸åŒï¼Œé‚£ä¹ˆæ—¥å¿—æ¯”è¾ƒé•¿çš„é‚£ä¸ªå°±æ›´åŠ æ–°ã€‚</p></blockquote><ul><li>å½“Leaderå¤åˆ¶ä¹‹å‰ä»»æœŸé‡Œçš„æ—¥å¿—æ—¶ï¼ŒRaft ä¼šä¸ºæ‰€æœ‰æ—¥å¿—ä¿ç•™<strong>åŸå§‹</strong>çš„ä»»æœŸå·, è¿™åœ¨æäº¤è§„åˆ™ä¸Šäº§ç”Ÿäº†é¢å¤–çš„å¤æ‚æ€§ã€‚åœ¨å…¶ä»–çš„ä¸€è‡´æ€§ç®—æ³•ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ–°Leaderè¦é‡æ–°å¤åˆ¶ä¹‹å‰çš„ä»»æœŸé‡Œçš„æ—¥å¿—æ—¶ï¼Œå®ƒå¿…é¡»ä½¿ç”¨å½“å‰æ–°çš„ä»»æœŸå·ã€‚Raft ä½¿ç”¨çš„æ–¹æ³•æ›´åŠ å®¹æ˜“è¾¨åˆ«å‡ºæ—¥å¿—ï¼Œå› ä¸ºå®ƒå¯ä»¥éšç€æ—¶é—´å’Œæ—¥å¿—çš„å˜åŒ–å¯¹æ—¥å¿—ç»´æŠ¤ç€åŒä¸€ä¸ªä»»æœŸç¼–å·ã€‚å¦å¤–ï¼Œå’Œå…¶ä»–çš„ç®—æ³•ç›¸æ¯”ï¼ŒRaft ä¸­çš„æ–°Leaderåªéœ€è¦å‘é€æ›´å°‘æ—¥å¿—æ¡ç›®ï¼ˆå…¶ä»–ç®—æ³•ä¸­å¿…é¡»åœ¨ä»–ä»¬è¢«æäº¤ä¹‹å‰å‘é€æ›´å¤šçš„å†—ä½™æ—¥å¿—æ¡ç›®æ¥ä¸ºä»–ä»¬é‡æ–°ç¼–å·ï¼‰ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>åˆ†å¸ƒå¼ç³»ç»Ÿ</category>
      
      <category>6.824</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åˆ†å¸ƒå¼ç³»ç»Ÿ</tag>
      
      <tag>6.824</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2020 Spring 6.824 Lab2A: Raft Leader Electionç¬”è®°</title>
    <link href="/2020/09/30/2020-Spring-6-824-Lab2A-Raft-Leader-Election%E7%AC%94%E8%AE%B0/"/>
    <url>/2020/09/30/2020-Spring-6-824-Lab2A-Raft-Leader-Election%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<p>Raft ä½¿ç”¨ä¸€ç§å¿ƒè·³æœºåˆ¶æ¥è§¦å‘Leader Electionï¼Œé€šè¿‡é€‰ä¸¾ä¸€ä¸ªLeaderï¼Œç„¶åç»™äºˆä»–å…¨éƒ¨çš„ç®¡ç†å¤åˆ¶æ—¥å¿—çš„æƒåŠ›æ¥å®ç°ä¸€è‡´æ€§ã€‚æœ¬ç« å°†å®ç°Lab2Aï¼Œè¯¦ç»†ä»‹ç»å¦‚ä½•å®ç°Raftç®—æ³•é‡Œçš„Leader Electionï¼Œä»¥åŠè¯¥éƒ¨åˆ†çš„å¯é æ€§ã€‚</p><a id="more"></a><h1 id="2020-Spring-6-824-Lab2A-Raft-Leader-Electionç¬”è®°"><a href="#2020-Spring-6-824-Lab2A-Raft-Leader-Electionç¬”è®°" class="headerlink" title="2020 Spring 6.824 Lab2A:Raft Leader Electionç¬”è®°"></a>2020 Spring 6.824 Lab2A:Raft Leader Electionç¬”è®°</h1><h2 id="0-Lab2Aè¦å¹²å•¥"><a href="#0-Lab2Aè¦å¹²å•¥" class="headerlink" title="0. Lab2Aè¦å¹²å•¥"></a>0. Lab2Aè¦å¹²å•¥</h2><ul><li>æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ</li></ul><p>ä¸€è‡´æ€§å…±è¯†é—®é¢˜ã€‚</p><ul><li>é‡‡ç”¨äº†ä»€ä¹ˆæ–¹æ¡ˆã€‚</li></ul><p>æ‹œå åº­æ–¹æ¡ˆï¼ŒRaftæ”¹ç¼–è‡ªPaxosç®—æ³•ï¼Œä¸ºäº†è§£å†³Paxoséš¾äºç†è§£ä¸”éš¾äºå®ç°çš„é—®é¢˜ã€‚</p><p>å…ˆçœ‹ä¸€éè®ºæ–‡åŸæ–‡ï¼š<a href="https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf">https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf</a></p><p>è¿™ä¸ªä¸­æ–‡ç¿»è¯‘å¾ˆä¸é”™ï¼Œæˆ‘çš„æ³¨é‡Šå¾ˆå¤šéƒ½æ˜¯å‚ç…§é‡Œé¢ï¼š<a href="https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md">https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md</a></p><p>è¿™ä¸ªRaftå¯è§†åŒ–ä¹Ÿä¸é”™ï¼Œå¦‚æœçœ‹ä¸ä¸‹è®ºæ–‡å¯ä»¥å…ˆçœ‹ä¸€éè¿™ä¸ªï¼š<a href="http://thesecretlivesofdata.com/raft/">http://thesecretlivesofdata.com/raft/</a></p><p>æœ¬ç« ä»£ç åœ°å€ï¼š<a href="https://github.com/keleqnma/6.824-notes-codes/tree/master/src/raft">https://github.com/keleqnma/6.824-notes-codes/tree/master/src/raft</a></p><p>æˆ‘è¿˜æ˜¯å»ºè®®æƒ³å­¦6.824çš„åŒå­¦ä»”ä»”ç»†ç»†å»çœ‹ä¸€éè®ºæ–‡åŸæ–‡ï¼Œä¹‹å‰æˆ‘çœ‹äº†ä¸€äº›æ–‡ç« ï¼Œææ‡‚äº†Raftå¤§è‡´æ˜¯ä»€ä¹ˆåŸç†ï¼Œæ€ä¹ˆå·¥ä½œçš„ï¼Œä½†æ˜¯è¦å®ç°å®ƒå¿…é¡»è¿˜æ˜¯è¦å»çœ‹åŸæ–‡ï¼Œæœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦æ³¨æ„ã€‚</p><h2 id="1-æµ‹è¯•ä»£ç -amp-Configä»£ç é€»è¾‘"><a href="#1-æµ‹è¯•ä»£ç -amp-Configä»£ç é€»è¾‘" class="headerlink" title="1. æµ‹è¯•ä»£ç &amp;Configä»£ç é€»è¾‘"></a>1. æµ‹è¯•ä»£ç &amp;Configä»£ç é€»è¾‘</h2><h3 id="1-1-æµ‹è¯•Configåˆå§‹åŒ–"><a href="#1-1-æµ‹è¯•Configåˆå§‹åŒ–" class="headerlink" title="1.1. æµ‹è¯•Configåˆå§‹åŒ–"></a>1.1. æµ‹è¯•Configåˆå§‹åŒ–</h3><p>2Aæ€»å…±æœ‰ä¸¤ä¸ªtestï¼Œç°åœ¨ä»¥test2Aä¸ºä¾‹è¯´ä¸€ä¸‹raftçš„åˆå§‹åŒ–</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestInitialElection2A</span><span class="hljs-params">(t *testing.T)</span></span> &#123;servers := <span class="hljs-number">3</span>cfg := make_config(t, servers, <span class="hljs-literal">false</span>)<span class="hljs-keyword">defer</span> cfg.cleanup()Â·Â·Â·Â·Â·Â·&#125;</code></pre><p>æµ‹è¯•ä»£ç æ³¨å†Œäº†ä¸€ä¸ªconfigï¼ˆä¼ å…¥å‚æ•°ä¸º3ï¼‰ï¼Œconfigæ³¨å†Œäº†ä¸‰ä¸ªRaftèŠ‚ç‚¹ï¼Œå¹¶å®Œæˆä¸€ç³»åˆ—åˆå§‹åŒ–æ“ä½œï¼šåˆå§‹åŒ–RPCNetï¼Œåˆå§‹åŒ–ApplyErrï¼ˆå¯¹åº”èŠ‚ç‚¹åœ¨æ¥æ”¶commitæ—¶æŠ¥çš„é”™ï¼‰ï¼Œåˆå§‹åŒ–logs(ç”¨äºå­˜å‚¨key-valueç»“æ„çš„Entryæ•°æ®ï¼‰ï¼Œè¿æ¥çŠ¶æ€ç­‰ç­‰ï¼Œæ¯”å¦‚è¿™ä¸ªå¯åŠ¨RaftèŠ‚ç‚¹çš„ä»£ç ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">//</span><span class="hljs-comment">// start or re-start a Raft.</span><span class="hljs-comment">// if one already exists, &quot;kill&quot; it first.</span><span class="hljs-comment">// allocate new outgoing port file names, and a new</span><span class="hljs-comment">// state persister, to isolate previous instance of</span><span class="hljs-comment">// this server. since we cannot really kill it.</span><span class="hljs-comment">//</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cfg *config)</span> <span class="hljs-title">start1</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span></span> &#123;cfg.crash1(i)<span class="hljs-comment">// a fresh set of outgoing ClientEnd names.</span><span class="hljs-comment">// so that old crashed instance&#x27;s ClientEnds can&#x27;t send.</span>cfg.endnames[i] = <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">string</span>, cfg.n)<span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; cfg.n; j++ &#123;cfg.endnames[i][j] = randstring(<span class="hljs-number">20</span>)&#125;<span class="hljs-comment">// a fresh set of ClientEnds.</span>ends := <span class="hljs-built_in">make</span>([]*labrpc.ClientEnd, cfg.n)<span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; cfg.n; j++ &#123;ends[j] = cfg.net.MakeEnd(cfg.endnames[i][j])cfg.net.Connect(cfg.endnames[i][j], j)&#125;cfg.mu.Lock()<span class="hljs-comment">// a fresh persister, so old instance doesn&#x27;t overwrite</span><span class="hljs-comment">// new instance&#x27;s persisted state.</span><span class="hljs-comment">// but copy old persister&#x27;s content so that we always</span><span class="hljs-comment">// pass Make() the last persisted state.</span><span class="hljs-keyword">if</span> cfg.saved[i] != <span class="hljs-literal">nil</span> &#123;cfg.saved[i] = cfg.saved[i].Copy()&#125; <span class="hljs-keyword">else</span> &#123;cfg.saved[i] = MakePersister()&#125;cfg.mu.Unlock()<span class="hljs-comment">// listen to messages from Raft indicating newly committed messages.</span>applyCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ApplyMsg)<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">for</span> m := <span class="hljs-keyword">range</span> applyCh &#123;err_msg := <span class="hljs-string">&quot;&quot;</span><span class="hljs-keyword">if</span> m.CommandValid == <span class="hljs-literal">false</span> &#123;<span class="hljs-comment">// ignore other types of ApplyMsg</span>&#125; <span class="hljs-keyword">else</span> &#123;v := m.Commandcfg.mu.Lock()<span class="hljs-keyword">for</span> j := <span class="hljs-number">0</span>; j &lt; <span class="hljs-built_in">len</span>(cfg.logs); j++ &#123;<span class="hljs-keyword">if</span> old, oldok := cfg.logs[j][m.CommandIndex]; oldok &amp;&amp; old != v &#123;<span class="hljs-comment">// some server has already committed a different value for this entry!</span>err_msg = fmt.Sprintf(<span class="hljs-string">&quot;commit index=%v server=%v %v != server=%v %v&quot;</span>,m.CommandIndex, i, m.Command, j, old)&#125;&#125;_, prevok := cfg.logs[i][m.CommandIndex<span class="hljs-number">-1</span>]cfg.logs[i][m.CommandIndex] = v<span class="hljs-keyword">if</span> m.CommandIndex &gt; cfg.maxIndex &#123;cfg.maxIndex = m.CommandIndex&#125;cfg.mu.Unlock()<span class="hljs-keyword">if</span> m.CommandIndex &gt; <span class="hljs-number">1</span> &amp;&amp; prevok == <span class="hljs-literal">false</span> &#123;err_msg = fmt.Sprintf(<span class="hljs-string">&quot;server %v apply out of order %v&quot;</span>, i, m.CommandIndex)&#125;&#125;<span class="hljs-keyword">if</span> err_msg != <span class="hljs-string">&quot;&quot;</span> &#123;log.Fatalf(<span class="hljs-string">&quot;apply error: %v\n&quot;</span>, err_msg)cfg.applyErr[i] = err_msg<span class="hljs-comment">// keep reading after error so that Raft doesn&#x27;t block</span><span class="hljs-comment">// holding locks...</span>&#125;&#125;&#125;()rf := Make(ends, i, cfg.saved[i], applyCh)cfg.mu.Lock()cfg.rafts[i] = rfcfg.mu.Unlock()svc := labrpc.MakeService(rf)srv := labrpc.MakeServer()srv.AddService(svc)cfg.net.AddServer(i, srv)&#125;</code></pre><p>é¦–å…ˆåœ¨RPCNeté‡Œæ³¨å†Œå½“å‰èŠ‚ç‚¹å’Œå…¶ä»–èŠ‚ç‚¹çš„è¿æ¥(ends)ï¼Œå¹¶åˆå§‹åŒ–Persisterï¼ˆç”¨äºå­˜å‚¨raftstateå’Œsnapshotçš„ï¼‰ï¼Œå¯åŠ¨ä¸€ä¸ªGoroutineç›‘å¬ï¼ŒæŠŠç›‘å¬åˆ°çš„æ•°æ®å’Œcfgä¸Šå…¶ä»–èŠ‚ç‚¹è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœä¸ä¸€æ ·å°±æŠ¥é”™ï¼Œç„¶åå¯¹æ¯”commitçš„åºå·ï¼Œå¦‚æœä¸ç¬¦å°±æŠ¥é”™ï¼Œå¹¶ä¸”æŠŠé”™è¯¯è®°å½•è¿›ApplyErrã€‚<br>éšååˆ›å»ºä¸€ä¸ªRaftServerï¼Œåˆ›å»ºServerçš„å…·ä½“ä»£ç å¦‚ä¸‹(è¿™ä¹Ÿæ˜¯æˆ‘ä»¬è¦å®ç°çš„åœ°æ–¹ï¼‰ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Make</span><span class="hljs-params">(peers []*labrpc.ClientEnd, me <span class="hljs-keyword">int</span>,</span></span><span class="hljs-function"><span class="hljs-params">persister *Persister, applyCh <span class="hljs-keyword">chan</span> ApplyMsg)</span> *<span class="hljs-title">Raft</span></span> &#123;rf := &amp;Raft&#123;&#125;rf.peers = peersrf.persister = persisterrf.me = me<span class="hljs-comment">// Your initialization code here (2A, 2B, 2C).</span><span class="hljs-comment">// initialize from state persisted before a crash</span>rf.readPersist(persister.ReadRaftState())<span class="hljs-keyword">return</span> rf&#125;</code></pre><p>éšåç”¨raft serveråˆå§‹åŒ–ä¸€ä¸ªserviceï¼Œåˆå§‹åŒ–ä¸€ä¸ªç©ºserverï¼ŒæŠŠè¯¥serviceæ·»åŠ åˆ°serveré‡Œï¼Œå†åœ¨RPCNeté‡Œæ·»åŠ è¯¥Serverã€‚</p><h3 id="1-2-æµ‹è¯•è¦ç‚¹"><a href="#1-2-æµ‹è¯•è¦ç‚¹" class="headerlink" title="1.2. æµ‹è¯•è¦ç‚¹"></a>1.2. æµ‹è¯•è¦ç‚¹</h3><p>2Açš„æµ‹è¯•æ¯”è¾ƒç®€å•ï¼Œåªæœ‰ä¸¤ä¸ªã€‚<br>TestAæ˜¯æ£€æµ‹åˆå§‹åŒ–ä¹‹åæœ‰æ²¡æœ‰é¡ºåˆ©é€‰ä¸¾å‡ºä¸€ä¸ªLeaderï¼Œæ£€æµ‹termçš„å˜åŒ–ï¼ˆé€‰ä¸¾å‡ºæ–°Leaderåtermè¦åŠ ä¸€ï¼‰ï¼Œç„¶åæ£€æµ‹åœ¨ç½‘ç»œæƒ…å†µä¸å˜çš„æƒ…å†µä¸‹ï¼ŒåŸæœ‰Leaderæœ‰æ²¡æœ‰è¢«ç½¢é»œï¼Œtermæœ‰æ²¡æœ‰å˜åŒ–ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestInitialElection2A</span><span class="hljs-params">(t *testing.T)</span></span> &#123;servers := <span class="hljs-number">3</span>cfg := make_config(t, servers, <span class="hljs-literal">false</span>)<span class="hljs-keyword">defer</span> cfg.cleanup()cfg.begin(<span class="hljs-string">&quot;Test (2A): initial election&quot;</span>)<span class="hljs-comment">// is a leader elected?</span>cfg.checkOneLeader()<span class="hljs-comment">// sleep a bit to avoid racing with followers learning of the</span><span class="hljs-comment">// election, then check that all peers agree on the term.</span>time.Sleep(<span class="hljs-number">50</span> * time.Millisecond)term1 := cfg.checkTerms()<span class="hljs-keyword">if</span> term1 &lt; <span class="hljs-number">1</span> &#123;t.Fatalf(<span class="hljs-string">&quot;term is %v, but should be at least 1&quot;</span>, term1)&#125;<span class="hljs-comment">// does the leader+term stay the same if there is no network failure?</span>time.Sleep(<span class="hljs-number">2</span> * RaftElectionTimeout)term2 := cfg.checkTerms()<span class="hljs-keyword">if</span> term1 != term2 &#123;fmt.Printf(<span class="hljs-string">&quot;warning: term changed even though there were no failures&quot;</span>)&#125;<span class="hljs-comment">// there should still be a leader.</span>cfg.checkOneLeader()cfg.end()&#125;</code></pre><p>TestBæ˜¯æ£€æµ‹åˆå§‹åŒ–ä¹‹åæœ‰æ²¡æœ‰é¡ºåˆ©é€‰ä¸¾å‡ºä¸€ä¸ªLeaderï¼Œç„¶åæŠŠåŸæœ‰çš„Leaderæ–­è¿ï¼Œæ£€æµ‹æœ‰æ²¡æœ‰é€‰ä¸¾å‡ºæ–°Leaderï¼Œç„¶åå†æŠŠåŸæœ‰çš„Leaderé‡è¿ï¼Œçœ‹çœ‹ä¼šä¸ä¼šäº§ç”Ÿä¸¤ä¸ªLeaderï¼Œç„¶åæŠŠåŒ…æ‹¬leaderåœ¨å†…çš„ä¸¤ä¸ªèŠ‚ç‚¹æ–­è¿ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯æ— leaderäº§ç”Ÿï¼ˆraftç®—æ³•åªèƒ½åœ¨å¤§å¤šæ•°èŠ‚ç‚¹æ­£å¸¸å·¥ä½œçš„æƒ…å†µä¸‹è¿è¡Œï¼‰ï¼Œå†é‡æ–°è¿æ¥å›ä¸¤ä¸ªæ–­è¿çš„èŠ‚ç‚¹ï¼Œæ£€æµ‹æœ‰æ²¡æœ‰é€‰ä¸¾å‡ºæ–°Leaderï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestReElection2A</span><span class="hljs-params">(t *testing.T)</span></span> &#123;servers := <span class="hljs-number">3</span>cfg := make_config(t, servers, <span class="hljs-literal">false</span>)<span class="hljs-keyword">defer</span> cfg.cleanup()cfg.begin(<span class="hljs-string">&quot;Test (2A): election after network failure&quot;</span>)leader1 := cfg.checkOneLeader()<span class="hljs-comment">// if the leader disconnects, a new one should be elected.</span>cfg.disconnect(leader1)cfg.checkOneLeader()<span class="hljs-comment">// if the old leader rejoins, that shouldn&#x27;t</span><span class="hljs-comment">// disturb the new leader.</span>cfg.connect(leader1)leader2 := cfg.checkOneLeader()<span class="hljs-comment">// if there&#x27;s no quorum, no leader should</span><span class="hljs-comment">// be elected.</span>cfg.disconnect(leader2)cfg.disconnect((leader2 + <span class="hljs-number">1</span>) % servers)time.Sleep(<span class="hljs-number">2</span> * RaftElectionTimeout)cfg.checkNoLeader()<span class="hljs-comment">// if a quorum arises, it should elect a leader.</span>cfg.connect((leader2 + <span class="hljs-number">1</span>) % servers)cfg.checkOneLeader()<span class="hljs-comment">// re-join of last node shouldn&#x27;t prevent leader from existing.</span>cfg.connect(leader2)cfg.checkOneLeader()cfg.end()&#125;</code></pre><h2 id="2-å®šä¹‰ç»“æ„"><a href="#2-å®šä¹‰ç»“æ„" class="headerlink" title="2. å®šä¹‰ç»“æ„"></a>2. å®šä¹‰ç»“æ„</h2><h3 id="2-1-Raft-State"><a href="#2-1-Raft-State" class="headerlink" title="2.1. Raft State"></a>2.1. Raft State</h3><p><img src="/img/raft/RaftState.png" alt="img"></p><pre><code class="hljs awk">type Raft struct &#123;mu        sync.Mutex          <span class="hljs-regexp">//</span> lock to protect shared access to this pee<span class="hljs-string">r&#x27;s state</span><span class="hljs-string">peers     []*labrpc.ClientEnd // RPC end points of all peers</span><span class="hljs-string">persister *Persister          // Object to hold this peer&#x27;</span>s persisted stateme        int                 <span class="hljs-regexp">//</span> this pee<span class="hljs-string">r&#x27;s index into peers[]</span><span class="hljs-string">dead      int32               // set by Kill()</span><span class="hljs-string"></span><span class="hljs-string">// Your data here (2A, 2B, 2C).</span><span class="hljs-string">// Look at the paper&#x27;</span>s Figure <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> a description of what<span class="hljs-regexp">//</span> state a Raft server must maintain.role        Role <span class="hljs-regexp">//</span>å½“å‰æœåŠ¡å™¨çš„è§’è‰²currentTerm int  <span class="hljs-regexp">//</span>æœåŠ¡å™¨å·²çŸ¥æœ€æ–°çš„ä»»æœŸï¼ˆåœ¨æœåŠ¡å™¨é¦–æ¬¡å¯åŠ¨çš„æ—¶å€™åˆå§‹åŒ–ä¸º<span class="hljs-number">0</span>ï¼Œå•è°ƒé€’å¢ï¼‰electionTimer       *time.Timer   <span class="hljs-regexp">//</span> å‘èµ·é€‰ä¸¾çš„è®¡æ—¶å™¨appendEntriesTimers []*time.Timer <span class="hljs-regexp">//</span> appendEntriesçš„è®¡æ—¶å™¨ï¼Œ<span class="hljs-number">2</span>Aä¸­ç”¨æ¥å‘å¿ƒè·³applyTimer          *time.Timer   <span class="hljs-regexp">//</span> applyæ—¥å¿—çš„è®¡æ—¶å™¨ï¼Œ<span class="hljs-number">2</span>Aç”¨ä¸åˆ°notifyApplyCh       chan struct&#123;&#125;stopCh              chan struct&#123;&#125;voteFor             int <span class="hljs-regexp">//</span> å½“å‰ä»»æœŸå†…æ”¶åˆ°é€‰ç¥¨çš„å€™é€‰è€…idapplyCh             chan ApplyMsglogEntries  []LogEntry <span class="hljs-regexp">//</span> æ—¥å¿—æ¡ç›®;æ¯ä¸ªæ¡ç›®åŒ…å«äº†ç”¨äºçŠ¶æ€æœºçš„å‘½ä»¤ï¼Œä»¥åŠé¢†å¯¼è€…æ¥æ”¶åˆ°è¯¥æ¡ç›®æ—¶çš„ä»»æœŸï¼ˆç¬¬ä¸€ä¸ªç´¢å¼•ä¸º<span class="hljs-number">1</span>ï¼‰,lastSnapshot æ”¾åˆ° index <span class="hljs-number">0</span>commitIndex int        <span class="hljs-regexp">//</span> å·²çŸ¥å·²æäº¤çš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆåˆå§‹å€¼ä¸º<span class="hljs-number">0</span>ï¼Œå•è°ƒé€’å¢ï¼‰lastApplied int        <span class="hljs-regexp">//</span> å·²ç»è¢«åº”ç”¨åˆ°çŠ¶æ€æœºçš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆåˆå§‹å€¼ä¸º<span class="hljs-number">0</span>ï¼Œå•è°ƒé€’å¢ï¼‰<span class="hljs-regexp">//</span>leaderéœ€è¦ä¿å­˜çš„nextIndex  []int <span class="hljs-regexp">//</span> å¯¹äºæ¯ä¸€å°æœåŠ¡å™¨ï¼Œå‘é€åˆ°è¯¥æœåŠ¡å™¨çš„ä¸‹ä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆåˆå§‹å€¼ä¸ºé¢†å¯¼è€…æœ€åçš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•+<span class="hljs-number">1</span>ï¼‰matchIndex []int <span class="hljs-regexp">//</span> å¯¹äºæ¯ä¸€å°æœåŠ¡å™¨ï¼Œå·²çŸ¥çš„å·²ç»å¤åˆ¶åˆ°è¯¥æœåŠ¡å™¨çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆåˆå§‹å€¼ä¸º<span class="hljs-number">0</span>ï¼Œå•è°ƒé€’å¢ï¼‰lastSnapshotIndex int <span class="hljs-regexp">//</span> å¿«ç…§ä¸­çš„ indexlastSnapshotTerm  int&#125;</code></pre><h3 id="2-2-RequestVote-RPC"><a href="#2-2-RequestVote-RPC" class="headerlink" title="2.2 RequestVote RPC"></a>2.2 RequestVote RPC</h3><p><img src="/img/raft/RequestVoteRPC.png" alt="img"></p><pre><code class="hljs go"><span class="hljs-keyword">type</span> RequestVoteArgs <span class="hljs-keyword">struct</span> &#123;<span class="hljs-comment">// Your data here (2A, 2B).</span>Term         <span class="hljs-keyword">int</span> <span class="hljs-comment">//å€™é€‰äººçš„ä»»æœŸå·</span>CandidateId  <span class="hljs-keyword">int</span> <span class="hljs-comment">// è¯·æ±‚é€‰ç¥¨çš„å€™é€‰äººçš„ Id</span>LastLogIndex <span class="hljs-keyword">int</span> <span class="hljs-comment">// å€™é€‰äººçš„æœ€åæ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼</span>LastLogTerm  <span class="hljs-keyword">int</span> <span class="hljs-comment">// å€™é€‰äººæœ€åæ—¥å¿—æ¡ç›®çš„ä»»æœŸå·</span>&#125;<span class="hljs-keyword">type</span> RequestVoteReply <span class="hljs-keyword">struct</span> &#123;<span class="hljs-comment">// Your data here (2A).</span>Term        <span class="hljs-keyword">int</span>  <span class="hljs-comment">// å½“å‰ä»»æœŸå·ï¼Œä»¥ä¾¿äºå€™é€‰äººå»æ›´æ–°è‡ªå·±çš„ä»»æœŸå·</span>VoteGranted <span class="hljs-keyword">bool</span> <span class="hljs-comment">// å€™é€‰äººèµ¢å¾—äº†æ­¤å¼ é€‰ç¥¨æ—¶ä¸ºçœŸ</span>&#125;</code></pre><h2 id="3-é€»è¾‘å®ç°"><a href="#3-é€»è¾‘å®ç°" class="headerlink" title="3. é€»è¾‘å®ç°"></a>3. é€»è¾‘å®ç°</h2><h3 id="3-1-Raftåˆå§‹åŒ–"><a href="#3-1-Raftåˆå§‹åŒ–" class="headerlink" title="3.1. Raftåˆå§‹åŒ–"></a>3.1. Raftåˆå§‹åŒ–</h3><p><img src="/img/raft/ServerStateMachine.png" alt="img"><br><img src="/img/raft/Rules.png" alt="img"><br>æ¯ä¸ªRaft Serveråˆå§‹åŒ–æ—¶éƒ½æ˜¯FollowerçŠ¶æ€ï¼Œtermä¸º0.<br>Raft serveråˆå§‹åŒ–ä¸€ä¸ªelectionTimerè®¡æ—¶å™¨ï¼ˆæ—¶é—´ä»150ms-300msä¸ç­‰ï¼‰ï¼Œå¦‚æœåœ¨è®¡æ—¶å™¨å®Œæˆä¹‹å‰ï¼Œæ”¶åˆ°äº†CandidateæœåŠ¡å™¨å‘é€çš„æŠ•ç¥¨è¯·æ±‚ï¼ˆRequestVoteï¼‰ï¼Œæˆ–è€…æ˜¯æ”¶åˆ°äº†leaderå‘é€çš„å¿ƒè·³ï¼ˆAppendEntriesï¼‰ï¼Œåˆ™åˆ·æ–°è®¡æ—¶å™¨ï¼Œç»§ç»­ç»´æŒFollowerçŠ¶æ€ã€‚<br>å¦‚æœæ²¡æœ‰æ”¶åˆ°ï¼Œå³<strong>é€‰ä¸¾è¶…æ—¶</strong>ï¼Œåˆ™è½¬å˜ä¸ºCandidateï¼Œå‘èµ·æŠ•ç¥¨ã€‚<br>è¿™é‡Œå’Œå¤§å¤šæ•°äººä¸€æ ·ï¼Œå°†é€‰ä¸¾è®¡æ—¶è¡Œä¸ºå°è£…ä¸ºä¸€ä¸ªloopï¼ˆraftå…±æœ‰ä¸‰ä¸ªloopï¼ŒelectionLoopï¼ŒappendEntriesLoopï¼ŒapplyLogLoopï¼Œè¿™ä¸‰ä¸ªæ—¶é—´éƒ½æ˜¯ç”±è¶…æ—¶é©±åŠ¨çš„ï¼‰ã€‚</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rf *Raft)</span> <span class="hljs-title">electionLoop</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">for</span> &#123;<span class="hljs-keyword">select</span> &#123;<span class="hljs-keyword">case</span> &lt;-rf.stopCh:<span class="hljs-keyword">return</span><span class="hljs-keyword">case</span> &lt;-rf.electionTimer.C:rf.startElection()&#125;&#125;&#125;</code></pre><h3 id="3-2-å‘èµ·é€‰ä¸¾ï¼Œé€‰å‡ºLeader"><a href="#3-2-å‘èµ·é€‰ä¸¾ï¼Œé€‰å‡ºLeader" class="headerlink" title="3.2. å‘èµ·é€‰ä¸¾ï¼Œé€‰å‡ºLeader"></a>3.2. å‘èµ·é€‰ä¸¾ï¼Œé€‰å‡ºLeader</h3><h4 id="3-2-1-å‘å‡ºé€‰ä¸¾è¦æ±‚"><a href="#3-2-1-å‘å‡ºé€‰ä¸¾è¦æ±‚" class="headerlink" title="3.2.1. å‘å‡ºé€‰ä¸¾è¦æ±‚"></a>3.2.1. å‘å‡ºé€‰ä¸¾è¦æ±‚</h4><p>è¦å¼€å§‹ä¸€æ¬¡é€‰ä¸¾è¿‡ç¨‹ï¼Œè·Ÿéšè€…å…ˆè¦å¢åŠ è‡ªå·±çš„å½“å‰ä»»æœŸå·å¹¶ä¸”è½¬æ¢åˆ°Candidateã€‚ç„¶åå®ƒå‘é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹å‘é€<strong>RequestVoteArgs</strong>æ¥ç»™è‡ªå·±æŠ•ç¥¨ã€‚ç›´åˆ°ä»¥ä¸‹ä»»æ„å‘ç”Ÿï¼š</p><ol><li>èµ¢å¾—é€‰ä¸¾<blockquote><p>å½“ä¸€ä¸ªå€™é€‰äººä»æ•´ä¸ªé›†ç¾¤çš„å¤§å¤šæ•°æœåŠ¡å™¨èŠ‚ç‚¹è·å¾—äº†é’ˆå¯¹åŒä¸€ä¸ªä»»æœŸå·çš„é€‰ç¥¨ï¼Œé‚£ä¹ˆä»–å°±èµ¢å¾—äº†è¿™æ¬¡é€‰ä¸¾å¹¶æˆä¸ºé¢†å¯¼äººã€‚æ¯ä¸€ä¸ªæœåŠ¡å™¨æœ€å¤šä¼šå¯¹ä¸€ä¸ªä»»æœŸå·æŠ•å‡ºä¸€å¼ é€‰ç¥¨ï¼ŒæŒ‰ç…§å…ˆæ¥å…ˆæœåŠ¡çš„åŸåˆ™ã€‚è¦æ±‚å¤§å¤šæ•°é€‰ç¥¨çš„è§„åˆ™ç¡®ä¿äº†æœ€å¤šåªä¼šæœ‰ä¸€ä¸ªå€™é€‰äººèµ¢å¾—æ­¤æ¬¡é€‰ä¸¾ã€‚ä¸€æ—¦å€™é€‰äººèµ¢å¾—é€‰ä¸¾ï¼Œä»–å°±ç«‹å³æˆä¸ºé¢†å¯¼äººã€‚ç„¶åä»–ä¼šå‘å…¶ä»–çš„æœåŠ¡å™¨å‘é€å¿ƒè·³æ¶ˆæ¯æ¥å»ºç«‹è‡ªå·±çš„æƒå¨å¹¶ä¸”é˜»æ­¢æ–°çš„é¢†å¯¼äººçš„äº§ç”Ÿã€‚</p></blockquote></li><li>å…¶ä»–RaftèŠ‚ç‚¹æˆä¸ºLeader<blockquote><p>åœ¨ç­‰å¾…æŠ•ç¥¨çš„æ—¶å€™ï¼Œå€™é€‰äººå¯èƒ½ä¼šä»å…¶ä»–çš„æœåŠ¡å™¨æ¥æ”¶åˆ°å£°æ˜å®ƒæ˜¯é¢†å¯¼äººçš„é™„åŠ æ—¥å¿—é¡¹ RPCã€‚å¦‚æœè¿™ä¸ªé¢†å¯¼äººçš„ä»»æœŸå·ï¼ˆåŒ…å«åœ¨æ­¤æ¬¡çš„ RPCä¸­ï¼‰ä¸å°äºå€™é€‰äººå½“å‰çš„ä»»æœŸå·ï¼Œé‚£ä¹ˆå€™é€‰äººä¼šæ‰¿è®¤é¢†å¯¼äººåˆæ³•å¹¶å›åˆ°è·Ÿéšè€…çŠ¶æ€ã€‚ å¦‚æœæ­¤æ¬¡ RPC ä¸­çš„ä»»æœŸå·æ¯”è‡ªå·±å°ï¼Œé‚£ä¹ˆå€™é€‰äººå°±ä¼šæ‹’ç»è¿™æ¬¡çš„ RPC å¹¶ä¸”ç»§ç»­ä¿æŒå€™é€‰äººçŠ¶æ€ã€‚</p></blockquote></li><li>No one wins<blockquote><p>å¦‚æœæœ‰å¤šä¸ªè·Ÿéšè€…åŒæ—¶æˆä¸ºå€™é€‰äººï¼Œé‚£ä¹ˆé€‰ç¥¨å¯èƒ½ä¼šè¢«ç“œåˆ†ä»¥è‡³äºæ²¡æœ‰å€™é€‰äººå¯ä»¥èµ¢å¾—å¤§å¤šæ•°äººçš„æ”¯æŒã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿçš„æ—¶å€™ï¼Œæ¯ä¸€ä¸ªå€™é€‰äººéƒ½ä¼šè¶…æ—¶ï¼Œç„¶åé€šè¿‡å¢åŠ å½“å‰ä»»æœŸå·æ¥å¼€å§‹ä¸€è½®æ–°çš„é€‰ä¸¾ã€‚ç„¶è€Œï¼Œæ²¡æœ‰å…¶ä»–æœºåˆ¶çš„è¯ï¼Œé€‰ç¥¨å¯èƒ½ä¼šè¢«æ— é™çš„é‡å¤ç“œåˆ†ã€‚</p></blockquote></li></ol><p>Raft ç®—æ³•ä½¿ç”¨éšæœºé€‰ä¸¾è¶…æ—¶æ—¶é—´çš„æ–¹æ³•æ¥ç¡®ä¿å¾ˆå°‘ä¼šå‘ç”Ÿé€‰ç¥¨ç“œåˆ†çš„æƒ…å†µï¼Œå°±ç®—å‘ç”Ÿä¹Ÿèƒ½å¾ˆå¿«çš„è§£å†³ã€‚ä¸ºäº†é˜»æ­¢é€‰ç¥¨èµ·åˆå°±è¢«ç“œåˆ†ï¼Œé€‰ä¸¾è¶…æ—¶æ—¶é—´æ˜¯ä»ä¸€ä¸ªå›ºå®šçš„åŒºé—´ï¼ˆä¾‹å¦‚ 150-300 æ¯«ç§’ï¼‰éšæœºé€‰æ‹©ã€‚è¿™æ ·å¯ä»¥æŠŠæœåŠ¡å™¨éƒ½åˆ†æ•£å¼€ä»¥è‡³äºåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªæœåŠ¡å™¨ä¼šé€‰ä¸¾è¶…æ—¶ï¼›ç„¶åä»–èµ¢å¾—é€‰ä¸¾å¹¶åœ¨å…¶ä»–æœåŠ¡å™¨è¶…æ—¶ä¹‹å‰å‘é€å¿ƒè·³åŒ…ã€‚åŒæ ·çš„æœºåˆ¶è¢«ç”¨åœ¨é€‰ç¥¨ç“œåˆ†çš„æƒ…å†µä¸‹ã€‚æ¯ä¸€ä¸ªå€™é€‰äººåœ¨å¼€å§‹ä¸€æ¬¡é€‰ä¸¾çš„æ—¶å€™ä¼šé‡ç½®ä¸€ä¸ª<strong>éšæœºçš„é€‰ä¸¾è¶…æ—¶æ—¶é—´</strong>ï¼Œç„¶ååœ¨è¶…æ—¶æ—¶é—´å†…ç­‰å¾…æŠ•ç¥¨çš„ç»“æœï¼›è¿™æ ·å‡å°‘äº†åœ¨æ–°çš„é€‰ä¸¾ä¸­å¦å¤–çš„é€‰ç¥¨ç“œåˆ†çš„å¯èƒ½æ€§ã€‚</p><h4 id="3-2-2-æ¥æ”¶é€‰ä¸¾è¦æ±‚"><a href="#3-2-2-æ¥æ”¶é€‰ä¸¾è¦æ±‚" class="headerlink" title="3.2.2. æ¥æ”¶é€‰ä¸¾è¦æ±‚"></a>3.2.2. æ¥æ”¶é€‰ä¸¾è¦æ±‚</h4><pre><code class="hljs go"><span class="hljs-comment">// é€‰ä¸¾äººçš„termå°äºå½“å‰æœåŠ¡å™¨çš„termï¼Œæ‹’ç»æŠ•ç¥¨</span><span class="hljs-keyword">if</span> req.Term &lt; rf.currentTerm &#123;<span class="hljs-keyword">return</span>&#125;<span class="hljs-comment">// å·²ç»é€‰ä¸¾æˆåŠŸï¼Œæ‹’ç»æŠ•ç¥¨</span><span class="hljs-keyword">if</span> rf.role == Leader &#123;<span class="hljs-keyword">return</span>&#125;<span class="hljs-comment">// å·²ç»æŠ•ç¥¨ç»™å½“å‰å€™é€‰äºº</span><span class="hljs-keyword">if</span> rf.voteFor == req.CandidateId &#123;reply.VoteGranted = <span class="hljs-literal">true</span><span class="hljs-keyword">return</span>&#125;<span class="hljs-comment">// å¦‚æœå·²ç»æŠ•ç¥¨ï¼Œä¸”å¯¹è±¡ä¸æ˜¯å½“å‰å€™é€‰äººï¼Œæ‹’ç»æŠ•ç¥¨</span><span class="hljs-comment">// ä½†å¦‚æœå½“å‰æœåŠ¡å™¨ä¸æ˜¯follwerï¼Œä¸”é€‰ä¸¾äººçš„termä¸å°äºå½“å‰æœåŠ¡å™¨çš„termï¼Œåˆ™å®ƒä¼šè½¬æŠ•ç»™é€‰ä¸¾äºº</span><span class="hljs-keyword">if</span> rf.voteFor != voteForNobody &amp;&amp; rf.voteFor != req.CandidateId &amp;&amp; rf.role == Follower &#123;<span class="hljs-keyword">return</span>&#125;<span class="hljs-comment">// å€™é€‰äººæœ€åä¸€æ¡æ—¥å¿—çš„termå°äºå½“å‰æœåŠ¡å™¨æœ€åä¸€æ¡æ—¥å¿—çš„term, æˆ–è€…å€™é€‰äººæœ€åä¸€æ¡æ—¥å¿—çš„indexå°äºå½“å‰æœåŠ¡å™¨æœ€åä¸€æ¡æ—¥å¿—çš„indexï¼ˆå³logè®°å½•å†²çªï¼‰ï¼Œæ‹’ç»æŠ•ç¥¨</span><span class="hljs-keyword">if</span> lastLogTerm &gt; req.LastLogTerm || (req.LastLogTerm == lastLogTerm &amp;&amp; req.LastLogIndex &lt; lastLogIndex) &#123;<span class="hljs-keyword">return</span>&#125;<span class="hljs-comment">// å°†è‡ªèº«çš„termè°ƒæ•´ä¸ºå’Œå€™é€‰äººä¸€è‡´</span>rf.currentTerm = req.Term<span class="hljs-comment">// æŠ•ç¥¨ç»™å€™é€‰äºº</span>rf.voteFor = req.CandidateIdreply.VoteGranted = <span class="hljs-literal">true</span>rf.changeRole(Follower)   <span class="hljs-comment">// åˆ·æ–°è®¡æ—¶å™¨</span>rf.resetElectionTimer()rf.log(<span class="hljs-string">&quot;vote for:%d&quot;</span>, req.CandidateId)</code></pre><h3 id="3-3-é€‰ä¸¾å®Œæˆï¼ŒLeaderå‘é€å¿ƒè·³"><a href="#3-3-é€‰ä¸¾å®Œæˆï¼ŒLeaderå‘é€å¿ƒè·³" class="headerlink" title="3.3. é€‰ä¸¾å®Œæˆï¼ŒLeaderå‘é€å¿ƒè·³"></a>3.3. é€‰ä¸¾å®Œæˆï¼ŒLeaderå‘é€å¿ƒè·³</h3><p>2Aé‡Œå…¶å®æ²¡å•¥å¥½è¯´çš„ï¼Œå®æµ‹å°±ç®—ä½ ä¸å†™å¿ƒè·³ä¹Ÿèƒ½è¿‡é‚£ä¸¤ä¸ªtestï¼Œç®—æ˜¯æµ‹è¯•çš„è®¾è®¡ç–æ¼å§ï¼Œappendentriesæˆ‘ä¼šæ”¾åˆ°2Bé‡Œä¸€èµ·è®²ã€‚</p><h2 id="4-ç®—æ³•å¯é æ€§-amp-ä¸€è‡´æ€§åˆ†æ"><a href="#4-ç®—æ³•å¯é æ€§-amp-ä¸€è‡´æ€§åˆ†æ" class="headerlink" title="4. ç®—æ³•å¯é æ€§&amp;ä¸€è‡´æ€§åˆ†æ"></a>4. ç®—æ³•å¯é æ€§&amp;ä¸€è‡´æ€§åˆ†æ</h2><h3 id="4-1-LeaderèŠ‚ç‚¹å´©æºƒ"><a href="#4-1-LeaderèŠ‚ç‚¹å´©æºƒ" class="headerlink" title="4.1. LeaderèŠ‚ç‚¹å´©æºƒ"></a>4.1. LeaderèŠ‚ç‚¹å´©æºƒ</h3><p>Leaderå´©æºƒåï¼ŒFollowerèŠ‚ç‚¹å°†ä¸å†æ”¶åˆ°å¿ƒè·³ï¼Œè®¡æ—¶å™¨åˆ°æ—¶åFollowerèŠ‚ç‚¹ä¼šé‡æ–°è¿›è¡Œé€‰ä¸¾ã€‚</p><h3 id="4-2-FollowerèŠ‚ç‚¹-CandidateèŠ‚ç‚¹å´©æºƒ"><a href="#4-2-FollowerèŠ‚ç‚¹-CandidateèŠ‚ç‚¹å´©æºƒ" class="headerlink" title="4.2. FollowerèŠ‚ç‚¹/CandidateèŠ‚ç‚¹å´©æºƒ"></a>4.2. FollowerèŠ‚ç‚¹/CandidateèŠ‚ç‚¹å´©æºƒ</h3><p>LeaderèŠ‚ç‚¹å‘ç°å‘ç»™æŸä¸ªfollowerèŠ‚ç‚¹çš„å¿ƒè·³è¶…æ—¶åï¼ŒLeaderèŠ‚ç‚¹ä¼š<strong>æ— é™é‡å‘</strong>ã€‚Raft çš„ RPCs éƒ½æ˜¯<strong>å¹‚ç­‰</strong>çš„ï¼Œæ‰€ä»¥è¿™æ ·é‡è¯•ä¸ä¼šé€ æˆä»»ä½•é—®é¢˜ã€‚ä¾‹å¦‚ä¸€ä¸ªè·Ÿéšè€…å¦‚æœæ”¶åˆ°é™„åŠ æ—¥å¿—è¯·æ±‚ä½†æ˜¯ä»–å·²ç»åŒ…å«äº†è¿™ä¸€æ—¥å¿—ï¼Œé‚£ä¹ˆä»–å°±ä¼šç›´æ¥å¿½ç•¥è¿™ä¸ªæ–°çš„è¯·æ±‚ã€‚</p><div class="note note-info">            <p><strong>å¹‚ç­‰ï¼ˆidempotentã€idempotenceï¼‰</strong>æ˜¯ä¸€ä¸ªæ•°å­¦ä¸è®¡ç®—æœºå­¦æ¦‚å¿µï¼Œå¸¸è§äºæŠ½è±¡ä»£æ•°ä¸­ã€‚<br>åœ¨ç¼–ç¨‹ä¸­ä¸€ä¸ªå¹‚ç­‰æ“ä½œçš„ç‰¹ç‚¹æ˜¯<strong>å…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒ</strong>ã€‚å¹‚ç­‰å‡½æ•°ï¼Œæˆ–å¹‚ç­‰æ–¹æ³•ï¼Œæ˜¯æŒ‡å¯ä»¥ä½¿ç”¨ç›¸åŒå‚æ•°é‡å¤æ‰§è¡Œï¼Œå¹¶èƒ½è·å¾—ç›¸åŒç»“æœçš„å‡½æ•°ã€‚è¿™äº›å‡½æ•°ä¸ä¼šå½±å“ç³»ç»ŸçŠ¶æ€ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒé‡å¤æ‰§è¡Œä¼šå¯¹ç³»ç»Ÿé€ æˆæ”¹å˜ã€‚ä¾‹å¦‚ï¼Œâ€œsetTrue()â€å‡½æ•°å°±æ˜¯ä¸€ä¸ªå¹‚ç­‰å‡½æ•°,æ— è®ºå¤šæ¬¡æ‰§è¡Œï¼Œå…¶ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ›´å¤æ‚çš„æ“ä½œå¹‚ç­‰ä¿è¯æ˜¯åˆ©ç”¨å”¯ä¸€äº¤æ˜“å·(æµæ°´å·)å®ç°.</p>          </div><h3 id="4-3-å¦‚ä½•ä¿è¯é€‰å‡ºä¸€ä¸ªç¨³å®šçš„Leaderï¼Ÿ"><a href="#4-3-å¦‚ä½•ä¿è¯é€‰å‡ºä¸€ä¸ªç¨³å®šçš„Leaderï¼Ÿ" class="headerlink" title="4.3. å¦‚ä½•ä¿è¯é€‰å‡ºä¸€ä¸ªç¨³å®šçš„Leaderï¼Ÿ"></a>4.3. å¦‚ä½•ä¿è¯é€‰å‡ºä¸€ä¸ªç¨³å®šçš„Leaderï¼Ÿ</h3><ol><li><p>è¦æ±‚ä¸€ä¸ªLeaderåªæœ‰æ‹¿åˆ°å¤§äºä¸€åŠèŠ‚ç‚¹çš„æŠ•ç¥¨æ‰èƒ½å½“é€‰ï¼Œä¸”æ¯ä¸ªèŠ‚ç‚¹åœ¨ä¸€æ¬¡ä»»æœŸä¸­åªèƒ½æŠ•ç»™ä¸€ä¸ªCandidateï¼Œä¿è¯äº†æ¯æ¬¡termé‡Œåªä¼šé€‰å‡ºä¸€ä¸ªLeaderã€‚</p></li><li><p>Raft çš„è¦æ±‚ä¹‹ä¸€å°±æ˜¯å®‰å…¨æ€§ä¸èƒ½ä¾èµ–æ—¶é—´ï¼šæ•´ä¸ªç³»ç»Ÿä¸èƒ½å› ä¸ºæŸäº›äº‹ä»¶è¿è¡Œçš„æ¯”é¢„æœŸå¿«ä¸€ç‚¹æˆ–è€…æ…¢ä¸€ç‚¹å°±äº§ç”Ÿäº†é”™è¯¯çš„ç»“æœã€‚ä½†æ˜¯ï¼Œå¯ç”¨æ€§ï¼ˆç³»ç»Ÿå¯ä»¥åŠæ—¶çš„å“åº”å®¢æˆ·ç«¯ï¼‰ä¸å¯é¿å…çš„è¦ä¾èµ–äºæ—¶é—´ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ¶ˆæ¯äº¤æ¢æ¯”æœåŠ¡å™¨æ•…éšœé—´éš”æ—¶é—´é•¿ï¼Œå€™é€‰äººå°†æ²¡æœ‰è¶³å¤Ÿé•¿çš„æ—¶é—´æ¥èµ¢å¾—é€‰ä¸¾ï¼›æ²¡æœ‰ä¸€ä¸ªç¨³å®šçš„Leaderï¼ŒRaft å°†æ— æ³•å·¥ä½œã€‚<br> æ‰€ä»¥æˆ‘ä»¬è¦ä¿è¯ï¼š</p><blockquote><p>å¹¿æ’­æ—¶é—´ï¼ˆbroadcastTimeï¼‰ &lt;&lt; é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆelectionTimeoutï¼‰ &lt;&lt; å¹³å‡æ•…éšœé—´éš”æ—¶é—´ï¼ˆMTBFï¼‰</p></blockquote><p> åœ¨è¿™ä¸ªä¸ç­‰å¼ä¸­ï¼Œå¹¿æ’­æ—¶é—´æŒ‡çš„æ˜¯ä»ä¸€ä¸ªæœåŠ¡å™¨å¹¶è¡Œçš„å‘é€ RPCs ç»™é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡å™¨å¹¶æ¥æ”¶å“åº”çš„å¹³å‡æ—¶é—´ï¼›é€‰ä¸¾è¶…æ—¶æ—¶é—´æ˜¯åœ¨ é€‰ä¸¾çš„è¶…æ—¶æ—¶é—´é™åˆ¶ï¼›å¹³å‡æ•…éšœé—´éš”æ—¶é—´å°±æ˜¯å¯¹äºä¸€å°æœåŠ¡å™¨è€Œè¨€ï¼Œä¸¤æ¬¡æ•…éšœä¹‹é—´çš„å¹³å‡æ—¶é—´ã€‚å¹¿æ’­æ—¶é—´å¿…é¡»æ¯”é€‰ä¸¾è¶…æ—¶æ—¶é—´å°ä¸€ä¸ªé‡çº§ï¼Œè¿™æ ·é¢†å¯¼äººæ‰èƒ½å¤Ÿå‘é€ç¨³å®šçš„å¿ƒè·³æ¶ˆæ¯æ¥é˜»æ­¢è·Ÿéšè€…å¼€å§‹è¿›å…¥é€‰ä¸¾çŠ¶æ€ï¼›é€šè¿‡éšæœºåŒ–é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„æ–¹æ³•ï¼Œè¿™ä¸ªä¸ç­‰å¼ä¹Ÿä½¿å¾—é€‰ç¥¨ç“œåˆ†çš„æƒ…å†µå˜å¾—ä¸å¯èƒ½ã€‚é€‰ä¸¾è¶…æ—¶æ—¶é—´åº”è¯¥è¦æ¯”å¹³å‡æ•…éšœé—´éš”æ—¶é—´å°ä¸Šå‡ ä¸ªæ•°é‡çº§ï¼Œè¿™æ ·æ•´ä¸ªç³»ç»Ÿæ‰èƒ½ç¨³å®šçš„è¿è¡Œã€‚å½“é¢†å¯¼äººå´©æºƒåï¼Œæ•´ä¸ªç³»ç»Ÿä¼šå¤§çº¦ç›¸å½“äºé€‰ä¸¾è¶…æ—¶çš„æ—¶é—´é‡Œä¸å¯ç”¨ï¼›æˆ‘ä»¬å¸Œæœ›è¿™ç§æƒ…å†µåœ¨æ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œä¸­å¾ˆå°‘å‡ºç°ã€‚</p><p> å¹¿æ’­æ—¶é—´å’Œå¹³å‡æ•…éšœé—´éš”æ—¶é—´æ˜¯ç”±ç³»ç»Ÿå†³å®šçš„ï¼Œä½†æ˜¯é€‰ä¸¾è¶…æ—¶æ—¶é—´æ˜¯æˆ‘ä»¬è‡ªå·±é€‰æ‹©çš„ã€‚Raft çš„ RPCs éœ€è¦æ¥æ”¶æ–¹å°†ä¿¡æ¯æŒä¹…åŒ–çš„ä¿å­˜åˆ°ç¨³å®šå­˜å‚¨ä¸­å»ï¼Œæ‰€ä»¥å¹¿æ’­æ—¶é—´å¤§çº¦æ˜¯ 0.5 æ¯«ç§’åˆ° 20 æ¯«ç§’ï¼Œå–å†³äºå­˜å‚¨çš„æŠ€æœ¯ã€‚å› æ­¤ï¼Œé€‰ä¸¾è¶…æ—¶æ—¶é—´å¯èƒ½éœ€è¦åœ¨ 10 æ¯«ç§’åˆ° 500 æ¯«ç§’ä¹‹é—´ã€‚å¤§å¤šæ•°çš„æœåŠ¡å™¨çš„å¹³å‡æ•…éšœé—´éš”æ—¶é—´éƒ½åœ¨å‡ ä¸ªæœˆç”šè‡³æ›´é•¿ï¼Œå¾ˆå®¹æ˜“æ»¡è¶³æ—¶é—´çš„éœ€æ±‚ã€‚</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>åˆ†å¸ƒå¼ç³»ç»Ÿ</category>
      
      <category>6.824</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åˆ†å¸ƒå¼ç³»ç»Ÿ</tag>
      
      <tag>6.824</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TCPè¯¦è§£ç¬”è®°</title>
    <link href="/2020/09/29/TCP%E8%AF%A6%E8%A7%A3%E7%AC%94%E8%AE%B0/"/>
    <url>/2020/09/29/TCP%E8%AF%A6%E8%A7%A3%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<p>TCPåè®®è¯¦è§£ï¼Œé‡ä¼ æœºåˆ¶ï¼ŒRTTç®—æ³•ï¼Œæ»‘åŠ¨çª—å£ï¼Œæ‹¥å¡æ§åˆ¶ç­‰ã€‚</p><a id="more"></a><h2 id="0-æ€»è¿°"><a href="#0-æ€»è¿°" class="headerlink" title="0. æ€»è¿°"></a>0. æ€»è¿°</h2><p>TCPå‘å±•åˆ°ä»Šå¤©å·²ç»æ˜¯éå¸¸æˆç†Ÿçš„åè®®äº†ï¼Œä½œä¸º<strong>ä¼ è¾“å±‚ï¼ˆTranport Layerï¼‰</strong>åè®®ï¼Œå¯ä¾›è·¨ä»»æ„ç½‘ç»œå¯é åœ°ä¼ è¾“æ•°æ®ã€‚ä»¥TCPç«¯å£çš„å½¢å¼ä¸ºåº”ç”¨ç¨‹åºæä¾›ä¼ è¾“å±‚å¯»å€ï¼ˆtransport-layer addressingï¼‰ï¼Œå¹¶ç”¨è¿™äº›ç«¯å£åœ¨æœºå™¨ä¹‹é—´å»ºç«‹è¿æ¥ã€‚ä¸€æ—¦å»ºç«‹äº†è¿æ¥ï¼Œå°±å¯ä»¥åœ¨ä¸¤ä¸ªè®¾å¤‡ä¹‹é—´<strong>åŒå‘</strong>ä¼ é€’æ•°æ®ã€‚åº”ç”¨ç¨‹åºå¯ä»¥å°†æ•°æ®ä½œä¸ºç®€å•çš„å­—èŠ‚æµå‘é€åˆ°TCPç«¯å£ï¼Œè€ŒTCPåè®®è´Ÿè´£å°†æ•°æ®æ‰“åŒ…ä¸ºIPæŠ¥æ–‡å‘é€ã€‚æ¥æ”¶è®¾å¤‡çš„TCPå®ç°å°†è¿‡ç¨‹é€†è½¬ï¼Œå°†æœ€åˆå‘é€çš„æ•°æ®æµä¼ é€’ç»™åº”ç”¨ç¨‹åºã€‚</p><p>TCPåŒ…å«å¾ˆå¤šæœºåˆ¶ï¼Œä»¥ç¡®ä¿æ•°æ®çš„å¯é æ€§ï¼Œä¸€è‡´æ€§å’ŒåŠæ—¶æ€§ã€‚è¿™å…¶ä¸­å…³é”®æ˜¯<strong>æ»‘åŠ¨çª—å£</strong>ï¼Œè¯¥æœºåˆ¶è¦æ±‚æ¯ä¸ªè®¾å¤‡è¿½è¸ªå·²å‘é€çš„æ•°æ®ï¼ˆå³è¦æ±‚æ”¶åˆ°ACKï¼‰ï¼Œå¹¶ç¡®è®¤æ¥æ”¶åˆ°çš„æ•°æ®ï¼ˆæ”¶åˆ°æ•°æ®åä¼šå‘é€ACKï¼‰ã€‚æœªç¡®è®¤çš„æ•°æ®ä¼šè‡ªåŠ¨é‡ä¼ ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®è®¾å¤‡å’Œè¿æ¥çš„éœ€è¦è°ƒæ•´ç³»ç»Ÿçš„å‚æ•°ã€‚è¯¥ç³»ç»Ÿè¿˜æä¾›äº†è®¾å¤‡ä¹‹é—´çš„ç¼“å†²å’Œæµæ§åˆ¶åŠŸèƒ½ï¼Œä»¥å¤„ç†ä¸å‡åŒ€çš„æ•°æ®ä¼ è¾“é€Ÿç‡å’Œå…¶ä»–é—®é¢˜ã€‚</p><p>TCPå¯ä»¥æœ€å¤§ç¨‹åº¦åœ°æ»¡è¶³å‡ ä¹æ‰€æœ‰éœ€è¦<strong>é¢å‘è¿æ¥ï¼ˆconnection-orientedï¼‰</strong>çš„<strong>å¯é </strong>æ•°æ®ä¼ é€’éœ€è¦ã€‚è¿™æ˜¯TCPçš„ä¸»è¦ç›®æ ‡ï¼Œå› ä¸ºè¿™æ„å‘³ç€é«˜å±‚åº”ç”¨ç¨‹åºä¸å¿…å•ç‹¬æä¾›è¿™äº›é€šç”¨åŠŸèƒ½ã€‚ TCPæ˜¯æœ€å¹¿æ³›ä½¿ç”¨çš„TCP / IPä¼ è¾“åè®®ï¼Œå¤§å¤šæ•°åº”ç”¨ç¨‹åºéƒ½é‡‡ç”¨TCPã€‚</p><div class="note note-success">            <p>æ¦‚æ‹¬ä¸€ä¸‹TCPçš„<strong>ä¸»è¦ç‰¹å¾</strong>ï¼šæˆ‘ä»¬å¯ä»¥è¯´å®ƒæ˜¯<strong>é¢å‘è¿æ¥çš„ï¼ŒåŒå‘çš„ï¼Œå¤šè¿æ¥çš„ï¼Œå¯é çš„ï¼Œéœ€è¦ç¡®è®¤çš„ï¼Œé¢å‘æµå’Œæµç®¡ç†çš„</strong>ã€‚</p>          </div><h2 id="1-TCPç©¶ç«Ÿå¹²äº†å•¥ï¼Ÿ"><a href="#1-TCPç©¶ç«Ÿå¹²äº†å•¥ï¼Ÿ" class="headerlink" title="1. TCPç©¶ç«Ÿå¹²äº†å•¥ï¼Ÿ"></a>1. TCPç©¶ç«Ÿå¹²äº†å•¥ï¼Ÿ</h2><h3 id="1-1-TCPèƒ½å¹²å•¥ï¼Ÿ"><a href="#1-1-TCPèƒ½å¹²å•¥ï¼Ÿ" class="headerlink" title="1.1. TCPèƒ½å¹²å•¥ï¼Ÿ"></a>1.1. TCPèƒ½å¹²å•¥ï¼Ÿ</h3><ol><li><p><strong>å¯»å€/å¤šè·¯å¤ç”¨ï¼š</strong> åƒUDPä¸€æ ·ï¼ŒTCPçš„ä¸€é¡¹é‡è¦å·¥ä½œæ˜¯å¤šè·¯å¤ç”¨ä»ä¸åŒè¿›ç¨‹æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œä»¥ä¾¿å¯ä»¥ä½¿ç”¨åŸºç¡€ç½‘ç»œå±‚åè®®å°†å…¶å‘é€å‡ºå»ã€‚</p></li><li><p><strong>è¿æ¥çš„å»ºç«‹ï¼Œç®¡ç†å’Œç»ˆæ­¢</strong>ï¼šè®¾å¤‡å¯ä»¥éµå¾ªTCPæ ‡å‡†æµç¨‹æ¥å»ºç«‹å¯ä»¥ä¼ è¾“æ•°æ®çš„TCPè¿æ¥ã€‚ä¸€æ—¦è¿æ¥å»ºç«‹ï¼ŒTCPå°±ä¼šå¼€å§‹ç®¡ç†è¯¥è¿æ¥ä»¥åŠå¤„ç†é—®é¢˜ã€‚å½“è®¾å¤‡å¯åŠ¨å…³é—­TCPè¿æ¥åï¼Œä¼šæœ‰ä¸€ä¸ªç‰¹æ®Šçš„TCPè¿›ç¨‹å°†æ­¤è¿æ¥ä¸­æ­¢ã€‚</p></li><li><p><strong>æ•°æ®å¤„ç†å’Œæ‰“åŒ…ï¼š</strong>TCPå®šä¹‰äº†ä¸€ç§æœºåˆ¶ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡è¯¥æœºåˆ¶ä»æ›´é«˜å±‚å‘å…¶å‘é€æ•°æ®ã€‚ç„¶åï¼Œå°†è¿™äº›æ•°æ®æ‰“åŒ…æˆæ¶ˆæ¯ï¼Œä»¥å‘é€åˆ°ç›®æ ‡TCPè½¯ä»¶ã€‚ç›®æ ‡è½¯ä»¶å°†æ•°æ®æ‰“åŒ…ï¼Œç„¶åå°†å…¶æä¾›ç»™ç›®æ ‡è®¡ç®—æœºä¸Šçš„åº”ç”¨ç¨‹åºã€‚</p></li><li><p><strong>æ•°æ®ä¼ è¾“ï¼š</strong>ä»æ¦‚å¿µä¸Šè®²ï¼Œä¼ è¾“è®¾å¤‡ä¸Šçš„TCPå®ç°è´Ÿè´£å°†æ‰“åŒ…çš„æ•°æ®ä¼ è¾“åˆ°å¦ä¸€è®¾å¤‡ä¸Šçš„TCPè¿›ç¨‹ã€‚éµå¾ªåˆ†å±‚åŸç†ï¼Œè¿™æ˜¯é€šè¿‡ä½¿å‘é€æœºä¸Šçš„TCPè½¯ä»¶å°†æ•°æ®åŒ…ä¼ é€’åˆ°åŸºç¡€ç½‘ç»œå±‚åè®®ï¼ˆIPåè®®ï¼‰æ¥å®Œæˆçš„ã€‚</p></li><li><p><strong>æä¾›å¯é æ€§å’Œä¼ è¾“è´¨é‡æœåŠ¡ï¼š</strong> ä½¿ç”¨TCPåè®®å‘é€æ•°æ®æ˜¯â€œå¯é çš„â€ã€‚è¿™æ„å‘³ç€ï¼Œä½¿ç”¨TCPä¸å¿…æ‹…å¿ƒæ•°æ®æ²¡æœ‰è¢«å‘é€ï¼Œæ•°æ®æ²¡æœ‰æŠµè¾¾ï¼Œæˆ–ä»¥é”™è¯¯çš„é¡ºåºåˆ°è¾¾ã€‚è¿™ä¹Ÿæ„å‘³ç€é¿å…äº†ç›´æ¥ä½¿ç”¨IPåè®®å‘é€æ•°æ®å¯èƒ½ä¼šå‡ºç°çš„å…¶ä»–å¸¸è§é—®é¢˜ã€‚</p></li><li><p><strong>æµæ§åˆ¶å’Œæ‹¥å¡é¿å…ï¼š</strong>TCPæ§åˆ¶å’Œç®¡ç†ä¸¤ä¸ªè®¾å¤‡ä¹‹é—´çš„æ•°æ®æµï¼Œä»¥åŠå¤„ç†é€šä¿¡æœŸé—´å¯èƒ½é‡åˆ°çš„æ‹¥å¡çš„ã€‚</p></li></ol><h3 id="1-2-TCPä¸èƒ½å¹²å•¥ï¼Ÿ"><a href="#1-2-TCPä¸èƒ½å¹²å•¥ï¼Ÿ" class="headerlink" title="1.2. TCPä¸èƒ½å¹²å•¥ï¼Ÿ"></a>1.2. TCPä¸èƒ½å¹²å•¥ï¼Ÿ</h3><ol><li><p><strong>æŒ‡å®šåº”ç”¨ç”¨é€”ï¼š</strong> TCPæ²¡æœ‰å…·ä½“æè¿°åº”ç”¨ç¨‹åºè¯¥å¦‚ä½•ä½¿ç”¨TCPã€‚</p></li><li><p><strong>æä¾›å®‰å…¨æ€§ï¼š</strong>TCPä¸æä¾›ä»»ä½•æœºåˆ¶æ¥ç¡®ä¿å…¶ä¼ è¾“çš„æ•°æ®çš„çœŸå®æ€§æˆ–ç§å¯†æ€§ã€‚å¦‚æœéœ€è¦è¿™äº›ï¼Œåˆ™å¿…é¡»ä½¿ç”¨å…¶ä»–æŸç§æ–¹å¼æ¥å®Œæˆï¼Œä¾‹å¦‚IPSecã€‚</p></li><li><p><strong>ç»´æŠ¤æ¶ˆæ¯è¾¹ç•Œï¼š</strong>TCPå°†æ•°æ®ä½œä¸ºè¿ç»­æµè€Œä¸æ˜¯ç¦»æ•£æ¶ˆæ¯å‘é€ã€‚åº”è¯¥ç”±åº”ç”¨ç¨‹åºå†³å®šä¸€æ¡æ¶ˆæ¯çš„ç»“æŸä½ç½®å’Œä¸‹ä¸€æ¡æ¶ˆæ¯çš„å¼€å§‹ä½ç½®ã€‚</p></li><li><p><strong>ä¿è¯é€šä¿¡ï¼š</strong>TCPä¼šæ£€æµ‹æœªç¡®è®¤çš„ä¼ è¾“ï¼Œå¹¶åœ¨éœ€è¦æ—¶é‡æ–°å‘é€ã€‚ä½†æ˜¯ï¼Œå¦‚æœå‡ºç°æŸç§é—®é¢˜å¯¼è‡´æ— æ³•å¯é é€šä¿¡ï¼Œåˆ™æ‰€æœ‰TCPå¯ä»¥åšçš„å°±æ˜¯â€œç»§ç»­å°è¯•â€ã€‚å®ƒæ— æ³•åšå‡ºä»»ä½•ä¿è¯ï¼Œå› ä¸ºæœ‰å¤ªå¤šäº‹æƒ…æ— æ³•æ§åˆ¶ã€‚åŒæ ·ï¼Œå®ƒå¯ä»¥å°è¯•ç®¡ç†æ•°æ®æµï¼Œä½†ä¸èƒ½è§£å†³æ‰€æœ‰é—®é¢˜ã€‚</p></li></ol><h2 id="2-é‡ä¼ æœºåˆ¶"><a href="#2-é‡ä¼ æœºåˆ¶" class="headerlink" title="2. é‡ä¼ æœºåˆ¶"></a>2. é‡ä¼ æœºåˆ¶</h2><h2 id="3-RTTç®—æ³•"><a href="#3-RTTç®—æ³•" class="headerlink" title="3. RTTç®—æ³•"></a>3. RTTç®—æ³•</h2><h2 id="4-æ»‘åŠ¨çª—å£"><a href="#4-æ»‘åŠ¨çª—å£" class="headerlink" title="4. æ»‘åŠ¨çª—å£"></a>4. æ»‘åŠ¨çª—å£</h2><h2 id="5-æ‹¥å¡æ§åˆ¶"><a href="#5-æ‹¥å¡æ§åˆ¶" class="headerlink" title="5. æ‹¥å¡æ§åˆ¶"></a>5. æ‹¥å¡æ§åˆ¶</h2><h2 id="6-é¢è¯•å¸¸é—®é—®é¢˜"><a href="#6-é¢è¯•å¸¸é—®é—®é¢˜" class="headerlink" title="6. é¢è¯•å¸¸é—®é—®é¢˜"></a>6. é¢è¯•å¸¸é—®é—®é¢˜</h2><h3 id="6-1-tcpçš„å¯é æ€§å¦‚ä½•ä¿è¯"><a href="#6-1-tcpçš„å¯é æ€§å¦‚ä½•ä¿è¯" class="headerlink" title="6.1. tcpçš„å¯é æ€§å¦‚ä½•ä¿è¯"></a>6.1. tcpçš„å¯é æ€§å¦‚ä½•ä¿è¯</h3><p>åˆ†å—ä¼ é€ï¼šæ•°æ®è¢«åˆ†å‰²æˆæœ€åˆé€‚çš„æ•°æ®å—ï¼ˆUDPçš„æ•°æ®æŠ¥é•¿åº¦ä¸å˜ï¼‰</p><p>ç­‰å¾…ç¡®è®¤ï¼šé€šè¿‡å®šæ—¶å™¨ç­‰å¾…æ¥æ”¶ç«¯å‘é€ç¡®è®¤è¯·æ±‚ï¼Œæ”¶ä¸åˆ°ç¡®è®¤åˆ™é‡å‘</p><p>ç¡®è®¤å›å¤ï¼šæ”¶åˆ°ç¡®è®¤åå‘é€ç¡®è®¤å›å¤(ä¸æ˜¯ç«‹å³å‘é€ï¼Œé€šå¸¸æ¨è¿Ÿå‡ åˆ†ä¹‹ä¸€ç§’)</p><p>æ•°æ®æ ¡éªŒï¼šä¿æŒé¦–éƒ¨å’Œæ•°æ®çš„æ ¡éªŒå’Œï¼Œæ£€æµ‹æ•°æ®ä¼ è¾“è¿‡ç¨‹æœ‰æ— å˜åŒ–</p><p>ä¹±åºæ’åºï¼šæ¥æ”¶ç«¯èƒ½é‡æ’åºæ•°æ®ï¼Œä»¥æ­£ç¡®çš„é¡ºåºäº¤ç»™åº”ç”¨ç«¯</p><p>é‡å¤ä¸¢å¼ƒï¼šæ¥æ”¶ç«¯èƒ½ä¸¢å¼ƒé‡å¤çš„æ•°æ®åŒ…</p><p>æµé‡ç¼“å†²ï¼šä¸¤ç«¯æœ‰å›ºå®šå¤§å°çš„ç¼“å†²åŒºï¼ˆæ»‘åŠ¨çª—å£ï¼‰ï¼Œé˜²æ­¢é€Ÿåº¦ä¸åŒ¹é…ä¸¢æ•°æ®</p>]]></content>
    
    
    <categories>
      
      <category>è®¡ç®—æœºç½‘ç»œ</category>
      
      <category>TCP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      
      <tag>TCP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2020 Spring 6.824 Lab1: MapReduceç¬”è®°</title>
    <link href="/2020/09/28/2020-Spring-6-824-Lab1-MapReduce%E7%AC%94%E8%AE%B0/"/>
    <url>/2020/09/28/2020-Spring-6-824-Lab1-MapReduce%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="2020-Spring-6-824-Lab1-MapReduceç¬”è®°"><a href="#2020-Spring-6-824-Lab1-MapReduceç¬”è®°" class="headerlink" title="2020 Spring 6.824 Lab1: MapReduceç¬”è®°"></a>2020 Spring 6.824 Lab1: MapReduceç¬”è®°</h1><p>æœ¬èŠ‚labçš„ä»£ç ï¼š<a href="https://github.com/keleqnma/6.824-notes-codes/tree/master/src/mr">https://github.com/keleqnma/6.824-notes-codes/tree/master/src/mr</a></p><h2 id="0-MapReduceæ¶æ„"><a href="#0-MapReduceæ¶æ„" class="headerlink" title="0. MapReduceæ¶æ„"></a>0. MapReduceæ¶æ„</h2><ul><li>é›†ç¾¤ä¸­çš„è§’è‰²åˆ†ç±»<ul><li>Master è´Ÿè´£ä»»åŠ¡è°ƒåº¦(åˆ†é…ä»»åŠ¡ï¼Œé‡æ–°æ‰§è¡Œï¼Œè°ƒåº¦ç­‰)</li><li>Worker è´Ÿè´£è¿è¡Œ Map ä»»åŠ¡ æˆ–è€… Reduce ä»»åŠ¡</li></ul></li><li>worker è¿è¡Œçš„ä»»åŠ¡åˆ†ç±»<ul><li>Map ä»»åŠ¡ï¼š æ¯ä¸ªMap ä»»åŠ¡è¯»å–éƒ¨åˆ†è¾“å…¥ äº§ç”Ÿä¸­é—´çš„<em>k v</em> æ•°æ®</li><li>Reduce ä»»åŠ¡ï¼š è¯»å–map äº§ç”Ÿçš„ä¸­é—´ <em>k v</em> æ•°æ®æ¯ä¸ªReduce äº§å‡ºä¸€ä¸ªè¾“å‡ºæ–‡ä»¶</li></ul></li></ul><p><img src="https://www.talend.com/wp-content/uploads/what-is-mapreduce.jpg" alt="image"></p><p><code>MapReduce</code> çš„æ•´ä½“æ€æƒ³æ˜¯ï¼š <strong>å°†è¾“å…¥çš„æ•°æ®åˆ†æˆ M ä¸ª <code>tasks</code>ï¼Œ ç”±ç”¨æˆ·è‡ªå®šä¹‰çš„ <code>Map</code> å‡½æ•°å»æ‰§è¡Œä»»åŠ¡ï¼Œäº§å‡º <code>&lt;Key, Value&gt;</code>å½¢å¼çš„ä¸­é—´æ•°æ®ï¼Œç„¶åç›¸åŒçš„ key é€šè¿‡ç”¨æˆ·è‡ªå®šä¹‰çš„ <code>Reduce</code> å‡½æ•°å»èšåˆï¼Œå¾—åˆ°æœ€ç»ˆçš„ç»“æœã€‚</strong> </p><ol><li>MapReduceç¨‹åºè´Ÿè´£å°†ç”¨æˆ·çš„è¾“å…¥åˆ’åˆ†ä¸ºMå— <code>16M ~ 64M</code> çš„å—å¤§å°ã€‚é€šè¿‡åˆ’åˆ†å‡½æ•°<code>(hash(key) mod R)</code> ä¼šæŠŠMapä¸­é—´æ•°æ®åˆ’åˆ†ä¸ºRä¸ªåˆ†åŒºã€‚</li><li>å°†ç¨‹åºå¤åˆ¶åˆ°é›†ç¾¤ä¸­çš„å„ä¸ªéœ€è¦è¿è¡Œçš„æœºå™¨ä¸Šå¹¶å¯åŠ¨</li><li>Master ç»™ç©ºé—²çš„æœºå™¨åˆ†é…Map æˆ–è€…Reduce ä»»åŠ¡ï¼Œç”±äº(1) ä¸­è¯´è¾“å…¥æ–‡ä»¶è¢«åˆ’åˆ†äº†Må—ï¼Œåˆ†åŒºå‡½æ•° <code>mod R</code> æ‰€ä»¥æ­¤æ—¶Mapä»»åŠ¡è¢«åˆ’åˆ†ä¸ºäº†Mä¸ªä»»åŠ¡ï¼ŒReduceä»»åŠ¡è¢«åˆ’åˆ†äº†Rä¸ªåˆ†åŒºï¼ŒåŒæ—¶æœ€ç»ˆç»“æœä¹Ÿä¼šäº§ç”Ÿ <code>&lt;= R</code> ä¸ªæœ€ç»ˆè¾“å‡ºçš„æ–‡ä»¶</li><li>æ‰§è¡ŒMapä»»åŠ¡çš„workerè¯»å–ç›¸åº”çš„è¾“å…¥å—,è§£æåå‘é€ç»™ç”¨æˆ·è‡ªå®šä¹‰çš„Mapç¨‹åºï¼Œç”¨æˆ·Mapç¨‹åºå°†å¤„ç†åçš„ä¸­é—´ç»“æœä¿å­˜åœ¨å†…å­˜å½“ä¸­ã€‚</li><li>ä¿å­˜åœ¨å†…å­˜ä¸­çš„ä¸­é—´ç»“æœä¼šå®šæœŸçš„è¢«æ ¹æ®åˆ†åŒºå‡½æ•°åˆ’åˆ†ä¸º<code>Rä¸ªåŒºåŸŸ</code>å†™å…¥æœ¬åœ°ç£ç›˜ï¼Œæœ¬åœ°ç£ç›˜ä¿å­˜çš„<code>ä½ç½®ä¿¡æ¯</code>ä¼šè¢«ä¼ è¾“åˆ°Masterï¼ŒMasterå°†è¿™äº›partationä½ç½®ä¿¡æ¯<code>è½¬å‘</code>åˆ°Reduce çš„workerã€‚</li><li>Reduce worker æ¥æ”¶åˆ°è¿™äº›ä½ç½®ä¿¡æ¯åä¼šé€šè¿‡<code>RPCè°ƒç”¨</code>ä»Map Workerçš„ç£ç›˜ä¸­è¯»å–ç›¸åº”partationçš„ä¸­é—´ç»“æœï¼Œå½“Reduceè¯»å–äº†æ‰€æœ‰çš„ä¸­é—´ç»“æœçš„ä¹‹åå°†<code>æŒ‰ç…§keyè¿›è¡Œä¸€æ¬¡æ’åº</code>ï¼Œå› ä¸ºå¤šä¸ªworkerä»»åŠ¡äº§ç”Ÿçš„ä¸­é—´ç»“æœä¼šè¢«åŒä¸€ä¸ªReduce worker è¯»å–,æ‰€ä»¥ä¸ºäº†ä¿è¯ç»“æœæœ‰åºè¿˜éœ€è¦é‡æ–°æ’åºä¸€æ¬¡ã€‚</li><li>reduce worker éå†æ’åºè¿‡çš„ä¸­é—´æ•°æ®ï¼Œç»™æ¯ä¸ªé‡åˆ°çš„å”¯ä¸€çš„ä¸­é—´keyï¼Œå°†è¿™ä¸ªkeyå’Œå¯¹åº”çš„valueä¼ é€’åˆ°ç”¨æˆ·çš„reduce æ–¹æ³•ä¸­ã€‚reduce æ–¹æ³•çš„è¾“å‡ºä¼šè¢«æ·»åŠ åˆ°è¿™ä¸ªåˆ†åŒºæœ€ç»ˆè¾“å‡ºæ–‡ä»¶ä¸­ã€‚</li><li>æ‰€æœ‰ä»»åŠ¡ç»“æŸåä¼šäº§ç”Ÿ<code>R</code>ä¸ªè¾“å‡ºæ–‡ä»¶ï¼Œä¸éœ€è¦åˆå¹¶ã€‚</li></ol><h3 id="Map-è¿‡ç¨‹"><a href="#Map-è¿‡ç¨‹" class="headerlink" title="Map è¿‡ç¨‹"></a>Map è¿‡ç¨‹</h3><ul><li>æ ¹æ®è¾“å…¥è¾“å…¥ä¿¡æ¯ï¼Œå°†è¾“å…¥æ•°æ® split æˆ M ä»½ï¼Œ æ¯”å¦‚ä¸Šå›¾ä¸­çš„ split0 - split4 <code>(è¿™é‡ŒM=5)</code></li><li>åœ¨æ‰€æœ‰å¯ç”¨çš„<code>worker</code>èŠ‚ç‚¹ä¸­ï¼Œèµ· M ä¸ª<code>task</code>ä»»åŠ¡çš„çº¿ç¨‹ï¼Œ æ¯ä¸ªä»»åŠ¡ä¼šè¯»å–å¯¹åº”ä¸€ä¸ª split å½“åšè¾“å…¥ã€‚</li><li>è°ƒç”¨ <code>map</code> å‡½æ•°ï¼Œå°†è¾“å…¥è½¬åŒ–ä¸º  <code>&lt;Key, Value&gt;</code> æ ¼å¼çš„ä¸­é—´æ•°æ®ï¼Œå¹¶ä¸”æ’åºåï¼Œå†™å…¥ç£ç›˜ã€‚ è¿™é‡Œï¼Œæ¯ä¸ª <code>task</code> ä¼šå†™ R ä¸ªæ–‡ä»¶ï¼Œå¯¹åº”ç€ <code>Reduce</code> ä»»åŠ¡æ•°ã€‚ æ•°æ®å†™å…¥å“ªä¸ªæ–‡ä»¶çš„è§„åˆ™ç”± <code>Partitioner</code> å†³å®šï¼Œé»˜è®¤æ˜¯ <code>hash(key) % R</code></li><li>(å¯é€‰) ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œä¸­é—´è¿˜å¯ä»¥ç”¨ä¸€ä¸ª <code>combiner</code> çš„ä¸­é—´è¿‡ç¨‹</li></ul><h3 id="Reduce-è¿‡ç¨‹"><a href="#Reduce-è¿‡ç¨‹" class="headerlink" title="Reduce è¿‡ç¨‹"></a>Reduce è¿‡ç¨‹</h3><ul><li><code>map</code> é˜¶æ®µç»“æŸä»¥åï¼Œ å¼€å§‹è¿›å…¥ <code>Reduce</code> é˜¶æ®µï¼Œæ¯ä¸ª <code>Reduce task</code>ä¼šä»æ‰€æœ‰çš„ <code>Map</code> ä¸­é—´æ•°æ®ä¸­ï¼Œè·å–å±äºè‡ªå·±çš„ä¸€ä»½æ•°æ®ï¼Œæ‹¿åˆ°æ‰€æœ‰æ•°æ®åï¼Œä¸€èˆ¬ä¼šè¿›è¡Œæ’åº<code>(Hadoop æ¡†æ¶æ˜¯è¿™æ ·åš)</code>  ã€‚</li></ul><blockquote><p>è¯´æ˜ï¼š è¿™ä¸ªæ’åºæ˜¯éå¸¸å¿…è¦çš„ï¼Œä¸»è¦å› ä¸º <code>Reduce</code> å‡½æ•°çš„è¾“å…¥ æ˜¯  <code>&lt;key, []values&gt;</code>  çš„æ ¼å¼ï¼Œå› ä¸ºéœ€è¦æ ¹æ®keyå»æ’åºã€‚æœ‰åŒå­¦æƒ³ä¸ºå•¥ä¸ç”¨ <code>map&lt;&gt;()</code> å»å®ç°å‘¢ï¼Ÿ åŸå› ï¼šå› ä¸ºmapå¿…é¡»å­˜åˆ°å†…å­˜ä¸­ï¼Œä½†æ˜¯å®é™…ä¸­æ•°æ®é‡å¾ˆå¤§ï¼Œå¾€å¾€éœ€è¦æº¢å†™åˆ°ç£ç›˜ã€‚ ä½†æ˜¯æ’åºæ˜¯å¯ä»¥åšåˆ°çš„ï¼Œæ¯”å¦‚å½’å¹¶æ’åºã€‚ è¿™ä¹Ÿå°±æ˜¯mapç«¯äº§å‡ºæ•°æ®éœ€è¦æ’åºï¼ŒReduceç«¯è·å–æ•°æ®åä¹Ÿéœ€è¦å…ˆæ’åºçš„åŸå› ã€‚</p></blockquote><ul><li>è°ƒç”¨ <code>Reduce</code> å‡½æ•°ï¼Œå¾—åˆ°æœ€ç»ˆçš„ç»“æœè¾“å‡ºç»“æœï¼Œå­˜å…¥å¯¹åº”çš„æ–‡ä»¶</li><li>(å¯é€‰) æ±‡æ€»æ‰€æœ‰ <code>Reduce</code>ä»»åŠ¡çš„ç»“æœã€‚ä¸€èˆ¬ä¸åšæ±‡æ€»ï¼Œå› ä¸ºé€šå¸¸ä¸€ä¸ªä»»åŠ¡çš„ç»“æœå¾€å¾€æ˜¯å¦ä¸€ä¸ª <code>MapReduce</code>ä»»åŠ¡çš„è¾“å…¥ï¼Œå› æ­¤æ²¡å¿…è¦æ±‡æ€»åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚</li></ul><h2 id="1-Mapç»“æ„"><a href="#1-Mapç»“æ„" class="headerlink" title="1.Mapç»“æ„"></a>1.Mapç»“æ„</h2><p><code>master</code> æ˜¯ <code>MapReduce</code> ä»»åŠ¡ä¸­æœ€æ ¸å¿ƒçš„è§’è‰²ï¼Œå®ƒéœ€è¦ç»´æŠ¤ <strong>çŠ¶æ€ä¿¡æ¯</strong> å’Œ <strong>æ–‡ä»¶ä¿¡æ¯</strong>ã€‚</p><ul><li>çŠ¶æ€ä¿¡æ¯ï¼š<ul><li><code>map</code> ä»»åŠ¡çŠ¶æ€</li><li><code>Reduce</code> ä»»åŠ¡çŠ¶æ€</li><li><code>worker</code> èŠ‚ç‚¹çŠ¶æ€</li></ul></li><li>æ–‡ä»¶ä¿¡æ¯<ul><li>è¾“å…¥æ–‡ä»¶ä¿¡æ¯</li><li>è¾“å‡ºæ–‡ä»¶ä¿¡æ¯</li><li><code>map</code>ä¸­é—´æ•°æ®æ–‡ä»¶ä¿¡æ¯</li></ul></li></ul><h2 id="2-å®¹é”™"><a href="#2-å®¹é”™" class="headerlink" title="2. å®¹é”™"></a>2. å®¹é”™</h2><h3 id="worker-èŠ‚ç‚¹å¤±è´¥"><a href="#worker-èŠ‚ç‚¹å¤±è´¥" class="headerlink" title="worker èŠ‚ç‚¹å¤±è´¥"></a>worker èŠ‚ç‚¹å¤±è´¥</h3><p><code>master</code>ä¼šå‘¨æœŸæ€§å‘æ‰€æœ‰èŠ‚ç‚¹å‘é€<code>ping </code>å¿ƒè·³æ£€æµ‹ï¼Œ å¦‚æœè¶…æ—¶æœªå›å¤ï¼Œ<code>master</code>ä¼šè®¤ä¸ºè¯¥<code>worker</code>å·²ç»æ•…éšœã€‚ä»»ä½•åœ¨è¯¥èŠ‚ç‚¹å®Œæˆçš„<code>map </code>æˆ–è€…<code>Reduce</code>ä»»åŠ¡éƒ½ä¼šè¢«æ ‡è®°ä¸º<code>idle</code>ï¼Œ å¹¶ç”±å…¶ä»–çš„<code>worker</code> é‡æ–°æ‰§è¡Œã€‚</p><blockquote><p>è¯´æ˜ï¼š å› ä¸º<code>MapReduce</code> ä¸ºäº†å‡å°‘ç½‘ç»œå¸¦å®½çš„æ¶ˆè€—ï¼Œ<code>map</code>çš„æ•°æ®æ˜¯å­˜å‚¨åœ¨æœ¬åœ°ç£ç›˜çš„ï¼Œå¦‚æœæŸä¸ª<code>worker</code>æœºå™¨æ•…éšœï¼Œä¼šå¯¼è‡´å…¶ä»–çš„<code>Reduce</code> ä»»åŠ¡æ‹¿ä¸åˆ°å¯¹åº”çš„ä¸­é—´æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦é‡è·‘ä»»åŠ¡ã€‚é‚£ä¹ˆè¿™ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœåˆ©ç”¨<code>hadoop</code> ç­‰åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿæ¥å­˜å‚¨ä¸­é—´æ•°æ®ï¼Œå…¶å®å¯¹äºå®Œæˆçš„<code>map</code>ä»»åŠ¡ï¼Œæ˜¯ä¸éœ€è¦é‡è·‘çš„ï¼Œä»£ä»·å°±æ˜¯å¢åŠ ç½‘ç»œå¸¦å®½ã€‚</p></blockquote><h3 id="Master-èŠ‚ç‚¹å¤±è´¥"><a href="#Master-èŠ‚ç‚¹å¤±è´¥" class="headerlink" title="Master èŠ‚ç‚¹å¤±è´¥"></a>Master èŠ‚ç‚¹å¤±è´¥</h3><p><code>master</code>èŠ‚ç‚¹å¤±è´¥ï¼Œåœ¨æ²¡æœ‰å®ç°HA çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è¯´åŸºæœ¬æ•´ä¸ª<code>MapReduce</code>ä»»åŠ¡å°±å·²ç»æŒ‚äº†ï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼Œç›´æ¥é‡æ–°å¯åŠ¨<code>master</code> é‡è·‘ä»»åŠ¡å°±okäº†ã€‚ å½“ç„¶å•¦ï¼Œå¦‚æœé›†ç¾¤æœ‰é«˜å¯é æ–¹æ¡ˆï¼Œæ¯”å¦‚<code>master</code>ä¸»å‰¯å¤‡ç”¨ï¼Œå°±å¯ä»¥å®ç°<code>master</code>çš„é«˜å¯é ï¼Œ<strong>ä»£ä»·å°±æ˜¯å¾—åŒæ­¥ç»´æŠ¤ä¸»å‰¯ä¹‹é—´çš„çŠ¶æ€ä¿¡æ¯å’Œæ–‡ä»¶ä¿¡æ¯ç­‰ã€‚</strong></p><h3 id="å¤±è´¥å¤„ç†"><a href="#å¤±è´¥å¤„ç†" class="headerlink" title="å¤±è´¥å¤„ç†"></a>å¤±è´¥å¤„ç†</h3><p>è®ºæ–‡ä¸­æåˆ°ï¼Œåªè¦<code>MapReduce</code>å‡½æ•°æ˜¯ç¡®å®šçš„ï¼Œè¯­ä¹‰ä¸Šä¸ç®¡æ˜¯åˆ†å¸ƒå¼æ‰§è¡Œè¿˜æ˜¯å•æœºæ‰§è¡Œï¼Œç»“æœéƒ½æ˜¯ä¸€è‡´çš„ã€‚æ¯ä¸ª<code>map</code> <code>Reduce</code> ä»»åŠ¡è¾“å‡ºæ˜¯é€šè¿‡åŸå­æäº¤æ¥ä¿è¯çš„ï¼Œ å³ï¼š</p><p><strong>ä¸€ä¸ªä»»åŠ¡è¦ä¹ˆæœ‰å®Œæ•´çš„æœ€ç»ˆæ–‡ä»¶ï¼Œè¦ä¹ˆå­˜åœ¨æœ€ç»ˆè¾“å‡ºç»“æœï¼Œè¦ä¹ˆä¸å­˜åœ¨ã€‚</strong></p><ul><li>æ¯ä¸ªè¿›è¡Œä¸­çš„ä»»åŠ¡ï¼Œåœ¨æ²¡æœ‰æœ€ç»ˆè¯­ä¹‰å®Œæˆä¹‹å‰ï¼Œéƒ½åªå†™ä¸´æ—¶æ–‡ä»¶ï¼Œæ¯ä¸ª<code>Reduce</code> ä»»åŠ¡ä¼šå†™ä¸€ä¸ªï¼Œè€Œæ¯ä¸ª<code>Map</code> ä»»åŠ¡ä¼šå†™ R ä¸ªï¼Œå¯¹åº” R ä¸ª<code>reducer</code>.</li><li>å½“ <code>Map</code> ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œä¼šå‘<code>master</code>å‘é€æ–‡ä»¶ä½ç½®ï¼Œå¤§å°ç­‰ä¿¡æ¯ã€‚<code>Master</code>å¦‚æœæ¥å—åˆ°ä¸€ä¸ªå·²ç»å®Œæˆçš„<code>Map</code>ä»»åŠ¡çš„ä¿¡æ¯ï¼Œå°±å¿½ç•¥æ‰ï¼Œå¦åˆ™ï¼Œä¼šè®°å½•è¿™ä¸ªä¿¡æ¯ã€‚</li><li>å½“ <code>Reduce</code> ä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œä¼šå°†ä¸´æ—¶æ–‡ä»¶é‡å‘½åä¸ºæœ€ç»ˆçš„è¾“å‡ºæ–‡ä»¶ï¼Œ å¦‚æœå¤šä¸ªç›¸åŒçš„<code>Reduce</code>ä»»åŠ¡åœ¨å¤šå°æœºå™¨æ‰§è¡Œå®Œï¼Œä¼šå¤šæ¬¡è¦†ç›–è¾“å‡ºæ–‡ä»¶ï¼Œè¿™ä¸ªç”±åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„<code>rename</code>æ“ä½œçš„åŸå­æ€§ï¼Œä¿è¯ä»»ä½•æ—¶åˆ»ï¼Œçœ‹åˆ°çš„éƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„æˆåŠŸç»“æœ</li></ul><p>å¯¹äºå¤§éƒ¨åˆ†ç¡®å®šæ€§çš„ä»»åŠ¡ï¼Œä¸ç®¡æ˜¯åˆ†å¸ƒå¼è¿˜æ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œæœ€ç»ˆéƒ½ä¼šå¾—åˆ°ä¸€è‡´çš„ç»“æœã€‚å¯¹äºä¸ç¡®å®šçš„<code>map</code> æˆ–è€…<code>Reduce</code> ä»»åŠ¡ï¼Œ<code>MapReduce</code> ä¿è¯æä¾›ä¸€ä¸ªå¼±çš„ï¼Œä»ç„¶åˆç†çš„è¯­ä¹‰ã€‚</p><blockquote><p>ä¸¾ä¸ªä¾‹å­æ¥è¯´:</p><p>ç¡®å®šæ€§ä»»åŠ¡æ¯”å¦‚ è¯é¢‘ç»Ÿè®¡   ä¸ç®¡ä½ æ€ä¹ˆæ‰§è¡Œï¼Œä¸²è¡Œæˆ–è€…å¹¶è¡Œï¼Œæœ€ç»ˆå¾—åˆ°çš„éƒ½æ˜¯ç¡®å®šæ€§çš„ç»Ÿè®¡ç»“æœã€‚</p><p>ç¬¬äºŒä¸ªä¸ç¡®å®šæ€§ä»»åŠ¡ï¼š éšæœºä¼ æ’­ç®—æ³•ï¼Œ<code>pageRank</code> ç­‰ï¼Œå› ä¸ºä¼šæœ‰æ¦‚ç‡å› ç´ åœ¨é‡Œé¢ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ æ¯æ¬¡è·‘çš„ç»“æœæ•°æ®ä¸ä¸€å®šèƒ½å¯¹çš„ä¸Šã€‚ä½†æ˜¯æ˜¯åˆç†çš„ï¼Œå› ä¸ºæœ¬æ¥å°±æœ‰å¾ˆå¤šéšæœºçš„å› ç´ åœ¨é‡Œé¢ã€‚</p></blockquote><h2 id="3-ä¼˜åŒ–"><a href="#3-ä¼˜åŒ–" class="headerlink" title="3. ä¼˜åŒ–"></a>3. ä¼˜åŒ–</h2><h3 id="å­˜å‚¨ä¼˜åŒ–"><a href="#å­˜å‚¨ä¼˜åŒ–" class="headerlink" title="å­˜å‚¨ä¼˜åŒ–"></a>å­˜å‚¨ä¼˜åŒ–</h3><p>â€‹    ç”±äºç½‘ç»œå¸¦å®½èµ„æºçš„æ˜‚è´µæ€§ï¼Œå› æ­¤å¯¹<code>MapReduce</code>  å­˜å‚¨åšäº†å¾ˆå¤šå¿…è¦çš„ä¼˜åŒ–ã€‚</p><ul><li>é€šè¿‡ä»æœ¬åœ°ç£ç›˜è¯»å–æ–‡ä»¶ï¼ŒèŠ‚çº¦ç½‘ç»œå¸¦å®½</li><li>GFS å°†æ–‡ä»¶åˆ†è§£æˆå¤šä¸ª å¤§å°é€šå¸¸ä¸º 64M çš„<code>block</code>, å¹¶å¤šå¤‡ä»½å­˜å‚¨åœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œåœ¨è°ƒåº¦æ—¶ï¼Œä¼šè€ƒè™‘æ–‡ä»¶çš„ä½ç½®ä¿¡æ¯ï¼Œå°½å¯èƒ½åœ¨å­˜æœ‰è¾“å…¥æ–‡ä»¶çš„æœºå™¨ä¸Šè°ƒåº¦<code>map</code>ä»»åŠ¡ï¼Œé¿å…ç½‘ç»œIOã€‚</li><li>ä»»åŠ¡å¤±è´¥æ—¶ï¼Œä¹Ÿä¼šå°è¯•åœ¨ç¦»å‰¯æœ¬æœ€è¿‘çš„workerä¸­æ‰§è¡Œï¼Œæ¯”å¦‚åŒä¸€å­ç½‘ä¸‹çš„æœºå™¨ã€‚</li><li>MapReduce ä»»åŠ¡åœ¨å¤§é›†ç¾¤ä¸­æ‰§è¡Œæ—¶ï¼Œå¤§éƒ¨åˆ†è¾“å…¥ç›´æ¥å¯ä»¥ä»ç£ç›˜ä¸­è¯»å–ï¼Œä¸æ¶ˆè€—å¸¦å®½ã€‚</li></ul><h3 id="ä»»åŠ¡ç²’åº¦"><a href="#ä»»åŠ¡ç²’åº¦" class="headerlink" title="ä»»åŠ¡ç²’åº¦"></a>ä»»åŠ¡ç²’åº¦</h3><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œä»»åŠ¡æ•°å³ä¸º <code>O(M + R)</code>,  è¿™ä¸ªæ•°é‡åº”å½“æ¯”<code>worker</code>æ•°é‡å¤šå¾—å¤šï¼Œè¿™æ ·åˆ©äºè´Ÿè½½å‡è¡¡å’Œå¤±è´¥æ¢å¤çš„æƒ…å†µï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½æ— é™å¢é•¿ï¼Œå› ä¸ºå¤ªå¤šä»»åŠ¡çš„è°ƒåº¦ï¼Œä¼šæ¶ˆè€—<code>master</code> å­˜å‚¨ä»»åŠ¡ä¿¡æ¯çš„å†…å­˜èµ„æºï¼Œå¦‚æœå¯åŠ¨taskæ‰€èŠ±çš„æ—¶é—´æ¯”ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿˜å¤šï¼Œé‚£å°±ä¸å¿å¤±äº†ã€‚</p><h4 id="è‡ªå®šä¹‰åˆ†åŒºå‡½æ•°-partition-ï¼š"><a href="#è‡ªå®šä¹‰åˆ†åŒºå‡½æ•°-partition-ï¼š" class="headerlink" title="è‡ªå®šä¹‰åˆ†åŒºå‡½æ•° (partition)ï¼š"></a>è‡ªå®šä¹‰åˆ†åŒºå‡½æ•° (<code>partition</code>)ï¼š</h4><p>è‡ªå®šä¹‰åˆ†åŒºå¯ä»¥æ›´å¥½åœ°ç¬¦åˆä¸šåŠ¡å’Œè¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œé˜²æ­¢æ•°æ®å€¾æ–œã€‚ é»˜è®¤åªæ˜¯ç®€å•çš„ <code>hash(key) % R</code></p><h4 id="æœ‰åºä¿è¯ï¼š"><a href="#æœ‰åºä¿è¯ï¼š" class="headerlink" title="æœ‰åºä¿è¯ï¼š"></a>æœ‰åºä¿è¯ï¼š</h4><p>æ¯ä¸ª<code>partition</code>å†…çš„æ•°æ®éƒ½æ˜¯æ’åºçš„ï¼Œè¿™æ ·æœ‰åˆ©äº<code>Reduce</code>é˜¶æ®µçš„<code>merge</code>åˆå¹¶</p><h4 id="Combiner-å‡½æ•°ï¼š"><a href="#Combiner-å‡½æ•°ï¼š" class="headerlink" title="Combiner å‡½æ•°ï¼š"></a><code>Combiner</code> å‡½æ•°ï¼š</h4><p>è¿™ä¸ªæ˜¯æ¯ä¸ª<code>map</code>é˜¶æ®µå®Œæˆä¹‹åï¼Œå±€éƒ¨å…ˆåšä¸€æ¬¡èšåˆã€‚æ¯”å¦‚ï¼šè¯é¢‘ç»Ÿè®¡ï¼Œæ¯ä¸ª Word å¯èƒ½å‡ºç°äº†100æ¬¡ï¼Œå¦‚æœä¸ä½¿ç”¨<code>combiner</code>ï¼Œ å°±ä¼šå‘é€100 ä¸ª <code>&lt;word, 1&gt;</code>, å¦‚æœ<code>combiner</code>èšåˆä¹‹åï¼Œåˆ™ä¸º <code>&lt;word, 100&gt;</code>, å¤§å¤§åœ°å‡å°‘äº†ç½‘ç»œä¼ è¾“å’Œç£ç›˜çš„IOã€‚</p><h4 id="è¾“å…¥è¾“å‡ºç±»å‹"><a href="#è¾“å…¥è¾“å‡ºç±»å‹" class="headerlink" title="è¾“å…¥è¾“å‡ºç±»å‹"></a>è¾“å…¥è¾“å‡ºç±»å‹</h4><p>ä¸€ä¸ª<code>reader</code>æ²¡å¿…è¦éè¦ä»æ–‡ä»¶è¯»æ•°æ®ï¼Œ<code>MapReduce</code> æ”¯æŒå¯ä»¥ä»ä¸åŒçš„æ•°æ®æºä¸­ä»¥å¤šç§ä¸åŒçš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯”å¦‚ä»æ•°æ®åº“è¯»å–ï¼Œç”¨æˆ·åªéœ€è¦è‡ªå®šä¹‰splitè§„åˆ™ï¼Œå°±èƒ½è½»æ˜“å®ç°ã€‚</p><h4 id="è®¡æ•°å™¨"><a href="#è®¡æ•°å™¨" class="headerlink" title="è®¡æ•°å™¨"></a>è®¡æ•°å™¨</h4><p><code>MapReduce</code> è¿˜æ·»åŠ äº†è®¡æ•°å™¨ï¼Œå¯ä»¥ç”¨æ¥æ£€æµ‹<code>MapReduce</code>çš„ä¸€äº›ä¸­é—´æ“ä½œã€‚</p><h2 id="4-å®ç°"><a href="#4-å®ç°" class="headerlink" title="4. å®ç°"></a>4. å®ç°</h2><h3 id="åˆå§‹ä»£ç é€»è¾‘"><a href="#åˆå§‹ä»£ç é€»è¾‘" class="headerlink" title="åˆå§‹ä»£ç é€»è¾‘"></a>åˆå§‹ä»£ç é€»è¾‘</h3><h4 id="1-MapReduceåº”ç”¨"><a href="#1-MapReduceåº”ç”¨" class="headerlink" title="1. MapReduceåº”ç”¨"></a>1. MapReduceåº”ç”¨</h4><p><code>mrapps</code>æ–‡ä»¶å¤¹é‡ŒåŒ…å«äº†å¾ˆå¤š<code>mapreduce</code>åº”ç”¨ï¼Œæ¯”å¦‚wc.go(wordcount)ï¼Œç”¨æ¥æ•°å•è¯é¢‘ç‡çš„ï¼Œæ¯ä¸ªåº”ç”¨éƒ½å®šä¹‰äº†è‡ªå·±çš„mapå‡½æ•°å’Œreduceå‡½æ•°ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹wc.goé‡Œè¿™ä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Map</span><span class="hljs-params">(filename <span class="hljs-keyword">string</span>, contents <span class="hljs-keyword">string</span>)</span> []<span class="hljs-title">mr</span>.<span class="hljs-title">KeyValue</span></span> &#123;<span class="hljs-comment">// function to detect word separators.</span>ff := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r <span class="hljs-keyword">rune</span>)</span> <span class="hljs-title">bool</span></span> &#123; <span class="hljs-keyword">return</span> !unicode.IsLetter(r) &#125;<span class="hljs-comment">// split contents into an array of words.</span>words := strings.FieldsFunc(contents, ff)kva := []mr.KeyValue&#123;&#125;<span class="hljs-keyword">for</span> _, w := <span class="hljs-keyword">range</span> words &#123;kv := mr.KeyValue&#123;w, <span class="hljs-string">&quot;1&quot;</span>&#125;kva = <span class="hljs-built_in">append</span>(kva, kv)&#125;<span class="hljs-keyword">return</span> kva&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Reduce</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>, values []<span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<span class="hljs-comment">// return the number of occurrences of this word.</span><span class="hljs-keyword">return</span> strconv.Itoa(<span class="hljs-built_in">len</span>(values))&#125;</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå®šä¹‰å¾ˆç®€å•ï¼Œmapå‡½æ•°è¾“å‡º&lt;word, â€˜1â€™&gt;ï¼Œreduceå‡½æ•°è¾“å…¥èšåˆåä¼—å¤šä¸ª&lt;word,â€™1â€™&gt;ï¼Œè¾“å‡ºâ€™1â€™çš„é•¿åº¦ï¼Œå³è¯¥å•è¯å‡ºç°çš„æ€»æ¬¡æ•°ã€‚</p><p>å°†è¿™ä¸ªåº”ç”¨å®šä¹‰çš„å‡½æ•°å’Œå‡½æ•°å¯¼å‡ºï¼š</p><blockquote><p>go build -buildmode=plugin ../mrapps/wc.go</p></blockquote><p><strong>è§£é‡Šï¼š</strong>pluginï¼ˆæ’ä»¶ï¼‰æ¨¡å¼ä¼šæŠŠè¯¥æ–‡ä»¶çš„å‡½æ•°å’Œå˜é‡å¯¼å‡ºåˆ°<code>.so</code>æ–‡ä»¶ï¼Œå…¶ä»–æ–‡ä»¶å¯ä»¥é€šè¿‡å¼•ç”¨<code>plugin</code>åº“æ¥è°ƒç”¨ï¼Œå¯ä»¥çœ‹è¿™é‡Œï¼š<a href="https://medium.com/learning-the-go-programming-language/writing-modular-go-programs-with-plugins-ec46381ee1a9">https://medium.com/learning-the-go-programming-language/writing-modular-go-programs-with-plugins-ec46381ee1a9</a></p><h4 id="2-MapReduceè¿‡ç¨‹"><a href="#2-MapReduceè¿‡ç¨‹" class="headerlink" title="2. MapReduceè¿‡ç¨‹"></a>2. MapReduceè¿‡ç¨‹</h4><p>éšåï¼Œå¯åŠ¨sequentialï¼ˆä¸²è¡Œï¼Œéå¹¶è¡Œï¼‰çš„ç¤ºä¾‹ï¼š</p><blockquote><p>go run mrsequential.go wc.so pg*.txt</p></blockquote><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(os.Args) &lt; <span class="hljs-number">3</span> &#123;fmt.Fprintf(os.Stderr, <span class="hljs-string">&quot;Usage: mrsequential xxx.so inputfiles...\n&quot;</span>)os.Exit(<span class="hljs-number">1</span>)&#125;  <span class="hljs-comment">// ç¤ºä¾‹ä¸­ï¼Œos.Args[1] = wc.so, è¯»å–wc.soä¸­å®šä¹‰çš„mapå‡½æ•°å’Œreduceå‡½æ•°ï¼Œèµ‹å€¼ç»™mapfå’Œrecudefå˜é‡</span>mapf, reducef := loadPlugin(os.Args[<span class="hljs-number">1</span>])<span class="hljs-comment">// Mapè¿‡ç¨‹ï¼Œè¾“å‡ºå¤šä¸ªæ–‡ä»¶çš„mapç»“æœ</span><span class="hljs-comment">// read each input file,</span><span class="hljs-comment">// pass it to Map,</span><span class="hljs-comment">// accumulate the intermediate Map output.</span><span class="hljs-comment">// </span>intermediate := []mr.KeyValue&#123;&#125;<span class="hljs-keyword">for</span> _, filename := <span class="hljs-keyword">range</span> os.Args[<span class="hljs-number">2</span>:] &#123;file, err := os.Open(filename)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;log.Fatalf(<span class="hljs-string">&quot;cannot open %v&quot;</span>, filename)&#125;content, err := ioutil.ReadAll(file)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;log.Fatalf(<span class="hljs-string">&quot;cannot read %v&quot;</span>, filename)&#125;file.Close()kva := mapf(filename, <span class="hljs-keyword">string</span>(content))intermediate = <span class="hljs-built_in">append</span>(intermediate, kva...)&#125;<span class="hljs-comment">//</span><span class="hljs-comment">// a big difference from real MapReduce is that all the</span><span class="hljs-comment">// intermediate data is in one place, intermediate[],</span><span class="hljs-comment">// rather than being partitioned into NxM buckets.</span><span class="hljs-comment">//</span>    <span class="hljs-comment">// å°†ä¸­é—´ç»“æœæ’åº</span>sort.Sort(ByKey(intermediate))oname := <span class="hljs-string">&quot;mr-out-0&quot;</span>ofile, _ := os.Create(oname)<span class="hljs-comment">// </span><span class="hljs-comment">// call Reduce on each distinct key in intermediate[],</span><span class="hljs-comment">// and print the result to mr-out-0.</span><span class="hljs-comment">//</span>i := <span class="hljs-number">0</span><span class="hljs-keyword">for</span> i &lt; <span class="hljs-built_in">len</span>(intermediate) &#123;j := i + <span class="hljs-number">1</span>    <span class="hljs-comment">//å°†ç›¸åŒçš„keyæ‰¾å‡ºæ¥ï¼ˆè¿™ä¹Ÿæ˜¯æ’åºçš„æ„ä¹‰ï¼‰</span><span class="hljs-keyword">for</span> j &lt; <span class="hljs-built_in">len</span>(intermediate) &amp;&amp; intermediate[j].Key == intermediate[i].Key &#123;j++&#125;    <span class="hljs-comment">//å°†æ‹¥æœ‰ç›¸åŒçš„keyçš„é”®å€¼å¯¹åˆå¹¶</span>values := []<span class="hljs-keyword">string</span>&#123;&#125;<span class="hljs-keyword">for</span> k := i; k &lt; j; k++ &#123;values = <span class="hljs-built_in">append</span>(values, intermediate[k].Value)&#125;    <span class="hljs-comment">//è¾“å…¥åˆ°reduceå‡½æ•°é‡Œï¼Œå¾—åˆ°è¾“å‡º</span>output := reducef(intermediate[i].Key, values)<span class="hljs-comment">// this is the correct format for each line of Reduce output.</span>fmt.Fprintf(ofile, <span class="hljs-string">&quot;%v %v\n&quot;</span>, intermediate[i].Key, output)i = j&#125;ofile.Close()&#125;</code></pre><p>è¿™ä¸ªç¤ºä¾‹æ¼”ç¤ºäº†ä¸€ä¸ªåŸºç¡€çš„MapReduceæµç¨‹æ˜¯æ€æ ·çš„ã€‚</p><h3 id="è‡ªå·±å†™ä»£ç "><a href="#è‡ªå·±å†™ä»£ç " class="headerlink" title="è‡ªå·±å†™ä»£ç "></a>è‡ªå·±å†™ä»£ç </h3><p>ä¸‹æ¥æˆ‘ä»¬å¼€å§‹å†™ä»£ç å§ï¼æ ¹æ®å®˜æ–¹æŒ‡å¼•ï¼š</p><blockquote><p>One way to get started is to modify <code>mr/worker.go</code>â€˜s <code>Worker()</code> to send an RPC to the master asking for a task. Then modify the master to respond with the file name of an as-yet-unstarted map task. Then modify the worker to read that file and call the application Map function, as in <code>mrsequential.go</code>.</p></blockquote><p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹é€»è¾‘ï¼Œåœ¨å·²ç»ç»™å‡ºçš„ä¸²è¡ŒMapReduceä¸­ï¼Œå•ä¸€è¿›ç¨‹æŒ‰ç…§é¡ºåºæ‰§è¡ŒMapä»»åŠ¡å’ŒReduceä»»åŠ¡ï¼Œä½†æ˜¯åœ¨è¦å®ç°çš„å¹¶è¡ŒMapReduceä¸­ï¼Œæˆ‘ä»¬å°†å¯åŠ¨ä¸€ä¸ªMasterå’Œå¤šä¸ªWorkerã€‚</p><p>RPCæ•™ç¨‹å¯ä»¥çœ‹è¿™é‡Œï¼š<a href="https://golang.org/pkg/net/rpc/%EF%BC%8C%E7%AE%80%E5%8D%95%E6%9D%A5%E8%AF%B4%E5%B0%B1%E6%98%AF%E9%80%9A%E8%BF%87%E6%B3%A8%E5%86%8C%E5%AF%B9%E8%B1%A1%E6%9D%A5%E8%B0%83%E7%94%A8%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E5%87%BD%E6%95%B0%E3%80%82">https://golang.org/pkg/net/rpc/ï¼Œç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡æ³¨å†Œå¯¹è±¡æ¥è°ƒç”¨è¿œç¨‹æœåŠ¡ç«¯çš„å‡½æ•°ã€‚</a></p><h4 id="1-æ•°æ®ç»“æ„åˆ†æ"><a href="#1-æ•°æ®ç»“æ„åˆ†æ" class="headerlink" title="1.æ•°æ®ç»“æ„åˆ†æ"></a>1.æ•°æ®ç»“æ„åˆ†æ</h4><pre><code class="hljs go"><span class="hljs-keyword">type</span> TaskStat <span class="hljs-keyword">struct</span> &#123;Status    TaskStatus <span class="hljs-comment">//taskçŠ¶æ€</span>WorkerId  <span class="hljs-keyword">int</span>        <span class="hljs-comment">//å¤„ç†è¯¥taskçš„workeråºå·</span>mu        sync.Mutex <span class="hljs-comment">//åˆ†æ®µé”</span>StartTime time.Time  <span class="hljs-comment">//èµ·å§‹æ—¶é—´ï¼ˆç”¨æ¥è®¡ç®—æœ‰æ²¡æœ‰è¶…æ—¶ï¼‰</span>&#125;<span class="hljs-keyword">type</span> Master <span class="hljs-keyword">struct</span> &#123;files     []<span class="hljs-keyword">string</span>   <span class="hljs-comment">//éœ€è¦å¤„ç†çš„files</span>nReduce   <span class="hljs-keyword">int</span>        <span class="hljs-comment">//è¾“å…¥çš„å‚æ•°nReduceï¼ˆè¾“å…¥çš„æ–‡ä»¶ä¼šè¢«åˆ’åˆ†æˆå‡ ä¸ªtaskæ¥å¤„ç†ï¼‰</span>taskPhase TaskPhase  <span class="hljs-comment">//taskPhaseï¼ˆmapé˜¶æ®µè¿˜æ˜¯reduceé˜¶æ®µï¼‰</span>taskStats []TaskStat <span class="hljs-comment">//taskStatsï¼ˆå„ä¸ªtaskçš„çŠ¶æ€ï¼‰</span>mu        sync.Mutex <span class="hljs-comment">//muï¼ˆå…¨å±€é”ï¼‰</span>done      <span class="hljs-keyword">bool</span>       <span class="hljs-comment">//doneï¼ˆä»»åŠ¡æ˜¯å¦å·²å®Œæˆï¼‰</span>workerSeq <span class="hljs-keyword">int</span>        <span class="hljs-comment">//workerSeqï¼ˆæœ‰å‡ ä¸ªworkerï¼‰</span>taskCh    <span class="hljs-keyword">chan</span> Task  <span class="hljs-comment">//taskChï¼ˆç”¨æ¥åˆ†å‘taskçš„channelï¼‰</span>statCh    <span class="hljs-keyword">chan</span> <span class="hljs-keyword">bool</span>  <span class="hljs-comment">//statChï¼ˆç”¨æ¥æ¥å—å„taskçŠ¶æ€çš„channelï¼‰</span>&#125;<span class="hljs-keyword">type</span> Task <span class="hljs-keyword">struct</span> &#123;FileName <span class="hljs-keyword">string</span>NReduce  <span class="hljs-keyword">int</span>NMaps    <span class="hljs-keyword">int</span>Seq      <span class="hljs-keyword">int</span>Phase    TaskPhaseAlive    <span class="hljs-keyword">bool</span> <span class="hljs-comment">// worker should exit when alive is false</span>&#125;</code></pre><h4 id="2-è°ƒç”¨é€»è¾‘"><a href="#2-è°ƒç”¨é€»è¾‘" class="headerlink" title="2.è°ƒç”¨é€»è¾‘"></a>2.è°ƒç”¨é€»è¾‘</h4><p>èµ·å§‹Masteråˆå§‹åŒ–åï¼Œåç»­å¯åŠ¨çš„wokerè¿›ç¨‹åˆ™ä¼šé€šè¿‡è°ƒç”¨<code>RegWorker</code>åœ¨Masterè¿›ç¨‹æ³¨å†Œï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Master)</span> <span class="hljs-title">RegWorker</span><span class="hljs-params">(args *RegisterArgs, reply *RegisterReply)</span> <span class="hljs-title">error</span></span> &#123;m.mu.Lock()<span class="hljs-keyword">defer</span> m.mu.Unlock()m.workerSeq++reply.WorkerId = m.workerSeq<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><p>éšåwokerè¿›ç¨‹ä¼šè°ƒç”¨<code>GetOneTask</code>è¯·æ±‚Masteråˆ†é…ä»»åŠ¡ï¼ŒMasterä¼šä»taskChannelé‡Œè·å–ä¸€ä¸ªtaskå¹¶åˆå§‹åŒ–Taskï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Master)</span> <span class="hljs-title">GetOneTask</span><span class="hljs-params">(args *TaskArgs, reply *TaskReply)</span> <span class="hljs-title">error</span></span> &#123;task := &lt;-m.taskChreply.Task = &amp;task<span class="hljs-keyword">if</span> task.Alive &#123;m.regTask(args, &amp;task)&#125;DPrintf(<span class="hljs-string">&quot;in get one Task, args:%+v, reply:%+v&quot;</span>, args, reply)<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Master)</span> <span class="hljs-title">regTask</span><span class="hljs-params">(args *TaskArgs, task *Task)</span></span> &#123;m.taskStats[task.Seq].mu.Lock()<span class="hljs-keyword">defer</span> m.taskStats[task.Seq].mu.Unlock()<span class="hljs-keyword">if</span> task.Phase != m.taskPhase &#123;<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;req Task phase neq&quot;</span>)&#125;m.taskStats[task.Seq].Status = TaskStatusRunningm.taskStats[task.Seq].WorkerId = args.WorkerIdm.taskStats[task.Seq].StartTime = time.Now()&#125;</code></pre><p>è·å–Taskä¹‹åï¼ŒWokerè¿›ç¨‹æ ¹æ®Taskçš„Phaseä¸åŒåˆ†åˆ«è¿›è¡Œä¸åŒçš„å¤„ç†ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *worker)</span> <span class="hljs-title">doMapTask</span><span class="hljs-params">(t Task)</span></span> &#123;contents, err := ioutil.ReadFile(t.FileName)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;w.reportTask(t, <span class="hljs-literal">false</span>, err)<span class="hljs-keyword">return</span>&#125;kvs := w.mapf(t.FileName, <span class="hljs-keyword">string</span>(contents))reduces := <span class="hljs-built_in">make</span>([][]KeyValue, t.NReduce)<span class="hljs-keyword">for</span> _, kv := <span class="hljs-keyword">range</span> kvs &#123;idx := ihash(kv.Key) % t.NReducereduces[idx] = <span class="hljs-built_in">append</span>(reduces[idx], kv)&#125;<span class="hljs-keyword">for</span> idx, l := <span class="hljs-keyword">range</span> reduces &#123;fileName := reduceName(t.Seq, idx)f, err := os.Create(fileName)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;w.reportTask(t, <span class="hljs-literal">false</span>, err)<span class="hljs-keyword">return</span>&#125;enc := json.NewEncoder(f)<span class="hljs-keyword">for</span> _, kv := <span class="hljs-keyword">range</span> l &#123;<span class="hljs-keyword">if</span> err := enc.Encode(&amp;kv); err != <span class="hljs-literal">nil</span> &#123;w.reportTask(t, <span class="hljs-literal">false</span>, err)&#125;&#125;<span class="hljs-keyword">if</span> err := f.Close(); err != <span class="hljs-literal">nil</span> &#123;w.reportTask(t, <span class="hljs-literal">false</span>, err)&#125;&#125;w.reportTask(t, <span class="hljs-literal">true</span>, <span class="hljs-literal">nil</span>)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *worker)</span> <span class="hljs-title">doReduceTask</span><span class="hljs-params">(t Task)</span></span> &#123;maps := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>][]<span class="hljs-keyword">string</span>)<span class="hljs-keyword">for</span> idx := <span class="hljs-number">0</span>; idx &lt; t.NMaps; idx++ &#123;fileName := reduceName(idx, t.Seq)file, err := os.Open(fileName)<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;w.reportTask(t, <span class="hljs-literal">false</span>, err)<span class="hljs-keyword">return</span>&#125;dec := json.NewDecoder(file)<span class="hljs-keyword">for</span> &#123;<span class="hljs-keyword">var</span> kv KeyValue<span class="hljs-keyword">if</span> err := dec.Decode(&amp;kv); err != <span class="hljs-literal">nil</span> &#123;<span class="hljs-keyword">break</span>&#125;<span class="hljs-keyword">if</span> _, ok := maps[kv.Key]; !ok &#123;maps[kv.Key] = <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">string</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>)&#125;maps[kv.Key] = <span class="hljs-built_in">append</span>(maps[kv.Key], kv.Value)&#125;&#125;res := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">string</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>)<span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> maps &#123;res = <span class="hljs-built_in">append</span>(res, fmt.Sprintf(<span class="hljs-string">&quot;%v %v\n&quot;</span>, k, w.reducef(k, v)))&#125;<span class="hljs-keyword">if</span> err := ioutil.WriteFile(mergeName(t.Seq), []<span class="hljs-keyword">byte</span>(strings.Join(res, <span class="hljs-string">&quot;&quot;</span>)), <span class="hljs-number">0600</span>); err != <span class="hljs-literal">nil</span> &#123;w.reportTask(t, <span class="hljs-literal">false</span>, err)&#125;w.reportTask(t, <span class="hljs-literal">true</span>, <span class="hljs-literal">nil</span>)&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *worker)</span> <span class="hljs-title">reportTask</span><span class="hljs-params">(t Task, done <span class="hljs-keyword">bool</span>, err error)</span></span> &#123;<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;log.Printf(<span class="hljs-string">&quot;%v&quot;</span>, err)&#125;args := ReportTaskArgs&#123;&#125;args.Done = doneargs.Seq = t.Seqargs.Phase = t.Phaseargs.WorkerId = w.idreply := ReportTaskReply&#123;&#125;<span class="hljs-keyword">if</span> ok := call(<span class="hljs-string">&quot;Master.ReportTask&quot;</span>, &amp;args, &amp;reply); !ok &#123;DPrintf(<span class="hljs-string">&quot;report task fail:%+v&quot;</span>, args)&#125;&#125;</code></pre><p>å®Œæˆä»»åŠ¡åï¼ŒWorkerè¿›ç¨‹å‘Masterè¿›ç¨‹æ±‡æŠ¥ï¼Œå¹¶é‡æ–°å¾ªç¯è¯·æ±‚æ–°ä»»åŠ¡ï¼ŒMasterè¿›ç¨‹åˆ¤æ–­å½“å‰ä»»åŠ¡çš„åˆæ³•æ€§ä»¥åŠæ˜¯å¦æ­£å¸¸å®Œæˆï¼Œå¦‚æœæ­£å¸¸ç»“æŸåˆ™å¯åŠ¨ä¸€æ¬¡å•æ¬¡å…¨å±€è°ƒåº¦æ¥åˆ·æ–°çŠ¶æ€ï¼š</p><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Master)</span> <span class="hljs-title">ReportTask</span><span class="hljs-params">(args *ReportTaskArgs, reply *ReportTaskReply)</span> <span class="hljs-title">error</span></span> &#123;m.taskStats[args.Seq].mu.Lock()<span class="hljs-keyword">defer</span> m.taskStats[args.Seq].mu.Unlock()DPrintf(<span class="hljs-string">&quot;get report task: %+v, taskPhase: %+v&quot;</span>, args, m.taskPhase)<span class="hljs-keyword">if</span> m.taskPhase != args.Phase || args.WorkerId != m.taskStats[args.Seq].WorkerId &#123;<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;<span class="hljs-keyword">if</span> args.Done &#123;m.taskStats[args.Seq].Status = TaskStatusFinish&#125; <span class="hljs-keyword">else</span> &#123;m.taskStats[args.Seq].Status = TaskStatusErr&#125;<span class="hljs-keyword">go</span> m.tickSingleTimer()<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>&#125;</code></pre><h4 id="3-Masterè°ƒåº¦è¿‡ç¨‹"><a href="#3-Masterè°ƒåº¦è¿‡ç¨‹" class="headerlink" title="3.Masterè°ƒåº¦è¿‡ç¨‹"></a>3.Masterè°ƒåº¦è¿‡ç¨‹</h4><p>åœ¨Workerè¿›ç¨‹åœ¨å¤„ç†ä»»åŠ¡æ—¶ï¼ŒMasterè¿›ç¨‹ä¹Ÿåœ¨è¿›è¡Œè°ƒåº¦ï¼š</p><pre><code class="hljs go"><span class="hljs-comment">//åªè¦ä»»åŠ¡æ²¡æœ‰å®Œæˆç»“æŸå°±å®šæœŸå¯ç”¨è°ƒåº¦</span><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Master)</span> <span class="hljs-title">tickSchedule</span><span class="hljs-params">()</span></span> &#123;<span class="hljs-keyword">for</span> !m.Done() &#123;m.tickSingleTimer()time.Sleep(ScheduleInterval)&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Master)</span> <span class="hljs-title">tickSingleTimer</span><span class="hljs-params">()</span></span> &#123;allFinish := <span class="hljs-literal">true</span><span class="hljs-keyword">var</span> wg sync.WaitGroupwg.Add(<span class="hljs-built_in">len</span>(m.taskStats))<span class="hljs-keyword">for</span> index := <span class="hljs-keyword">range</span> m.taskStats &#123;<span class="hljs-keyword">go</span> m.taskSchedule(index, &amp;wg) <span class="hljs-comment">//å¯¹æ¯ä¸ªtaskstateéƒ½å¯ç”¨å•ç‹¬çš„goroutineè°ƒåº¦</span>&#125;<span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> m.taskStats &#123;finStat := &lt;-m.statCh<span class="hljs-comment">//ä»ä¿¡é“ä¸­è¯»å–çŠ¶æ€</span>allFinish = allFinish &amp;&amp; finStat&#125;wg.Wait()<span class="hljs-comment">//ç­‰å¾…goroutineséƒ½ç»“æŸï¼ˆä¸ç„¶åé¢æ›´æ–°phaseçš„æ—¶å€™å…¨å±€é”ä¸è¦†ç›–å±€éƒ¨é”å°±ä¼šäº§ç”Ÿç«äº‰ï¼‰</span><span class="hljs-keyword">if</span> allFinish &#123;<span class="hljs-keyword">if</span> m.taskPhase == MapPhase &#123;log.Println(<span class="hljs-string">&quot;map done&quot;</span>)m.initReduceTask()&#125; <span class="hljs-keyword">else</span> &#123;m.mu.Lock()m.done = <span class="hljs-literal">true</span>m.mu.Unlock()&#125;&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Master)</span> <span class="hljs-title">taskSchedule</span><span class="hljs-params">(taskSeq <span class="hljs-keyword">int</span>, wg *sync.WaitGroup)</span></span> &#123;<span class="hljs-keyword">if</span> m.Done() &#123;<span class="hljs-keyword">return</span>&#125;m.taskStats[taskSeq].mu.Lock()DPrintf(<span class="hljs-string">&quot;begin,task:%v, Status: %v&quot;</span>, taskSeq, m.taskStats[taskSeq].Status)<span class="hljs-keyword">switch</span> m.taskStats[taskSeq].Status &#123;<span class="hljs-keyword">case</span> TaskStatusReady:<span class="hljs-comment">//åˆå§‹çŠ¶æ€ï¼Œå°†å…¶æ”¾å…¥task channel</span>m.statCh &lt;- <span class="hljs-literal">false</span>m.taskCh &lt;- m.getTask(taskSeq)m.taskStats[taskSeq].Status = TaskStatusQueue<span class="hljs-keyword">case</span> TaskStatusQueue:<span class="hljs-comment">//æ’é˜Ÿä¸­ï¼Œæœªè¢«workeré¢†å–</span>m.statCh &lt;- <span class="hljs-literal">false</span><span class="hljs-keyword">case</span> TaskStatusRunning:<span class="hljs-comment">//æ­£åœ¨è¢«workerå¤„ç†ï¼Œåˆ¤æ–­ä¸€ä¸‹æ—¶é—´æœ‰æ²¡æœ‰è¶…æ—¶</span>m.statCh &lt;- <span class="hljs-literal">false</span><span class="hljs-keyword">if</span> time.Now().Sub(m.taskStats[taskSeq].StartTime) &gt; MaxTaskRunTime &#123;m.taskStats[taskSeq].Status = TaskStatusQueuem.taskCh &lt;- m.getTask(taskSeq)&#125;<span class="hljs-keyword">case</span> TaskStatusFinish:<span class="hljs-comment">//æ­£å¸¸ç»“æŸçš„task</span>m.statCh &lt;- <span class="hljs-literal">true</span><span class="hljs-keyword">case</span> TaskStatusErr:<span class="hljs-comment">//é”™è¯¯ç»“æŸçš„taskï¼Œå°†å…¶é‡æ–°æ”¾å…¥é˜Ÿåˆ—ä¸­</span>m.statCh &lt;- <span class="hljs-literal">false</span>m.taskStats[taskSeq].Status = TaskStatusQueuem.taskCh &lt;- m.getTask(taskSeq)<span class="hljs-keyword">default</span>:<span class="hljs-comment">//å¼‚å¸¸çŠ¶æ€</span>m.statCh &lt;- <span class="hljs-literal">false</span><span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;t.status err&quot;</span>)&#125;<span class="hljs-keyword">defer</span> m.taskStats[taskSeq].mu.Unlock()<span class="hljs-keyword">defer</span> wg.Done()&#125;</code></pre><p>ä»¥ä¸Šå°±æ˜¯MapReduceæˆ‘ä¸ªäººçš„ä¸€äº›å¿ƒå¾—äº†ã€‚</p><p>ä»£ç å‚è€ƒï¼š</p><ol><li><a href="https://titanssword.github.io/2018-01-20-mapreduce%20implements.html">https://titanssword.github.io/2018-01-20-mapreduce%20implements.html</a></li><li><a href="https://github.com/kophy/6.824">https://github.com/kophy/6.824</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>åˆ†å¸ƒå¼ç³»ç»Ÿ</category>
      
      <category>6.824</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åˆ†å¸ƒå¼ç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
